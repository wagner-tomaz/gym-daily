<!DOCTYPE html<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gym Daily</title>
    <link rel="apple-touch-icon" href="../gym-daily/images/gym-daily.png">
    <link rel="icon" sizes="192x192" href="../gym-daily/images/gym-daily.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: black; color: white; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #3b0764; border-radius: 3px; }
        /* Ajuste de inputs para mobile */
        input, select, textarea { font-size: 16px !important; } 
    </style>
</head>
<body class="min-h-screen bg-black pb-24 select-none">

    <div id="root" class="max-w-md mx-auto p-4">
        </div>

    <div class="fixed bottom-0 left-0 right-0 border-t z-40 bg-zinc-900 border-zinc-800">
        <div class="max-w-md mx-auto flex">
            <button onclick="app.setTab('calendar')" id="btn-calendar" class="flex-1 py-4 flex flex-col items-center gap-1 transition-colors">
                <i data-lucide="calendar" class="w-6 h-6"></i>
                <span class="text-xs font-semibold">Calendário</span>
            </button>
            <button onclick="app.setTab('routine')" id="btn-routine" class="flex-1 py-4 flex flex-col items-center gap-1 transition-colors">
                <i data-lucide="dumbbell" class="w-6 h-6"></i>
                <span class="text-xs font-semibold">Ficha</span>
            </button>
        </div>
    </div>

<script>
    // --- ESTADO GLOBAL ---
    const state = {
        currentTab: 'calendar',
        currentDate: new Date(),
        gymData: JSON.parse(localStorage.getItem('gymTrackerData')) || {},
        routines: JSON.parse(localStorage.getItem('gymRoutines')) || [],
        
        // Modal Calendário
        selectedDay: null,
        showModal: false,
        modalMode: 'select', // select, attended, missed, rest
        
        // Form Calendário
        weight: '',
        workoutType: '',
        exercises: [{ name: '', customName: '', weight: '', reps: '', sets: '' }],
        notes: '',
        photo: null,
        missedReason: '',
        customReason: '',

        // Rotinas
        showRoutineModal: false,
        routineModalMode: 'create',
        currentRoutine: null, // Objeto temporário de edição
        routineName: '',
        selectedWeekday: null,
        routineExercises: [],
        
        // Navegação de Rotina (Visualização)
        viewingRoutineId: null, // Guardamos ID para garantir reatividade
        viewingDay: null
    };

    // --- CONSTANTES ---
    const weekdays = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
    const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
    
    const missedReasons = ['Academia fechada', 'Doente', 'Cansaço excessivo', 'Trabalho/Estudo', 'Perdi o horário', 'Outro'];

    const exercisesList = {
        inferior: ['Agachamento Livre', 'Leg Press 45°', 'Cadeira Extensora', 'Mesa Flexora', 'Stiff', 'Elevação Pélvica', 'Panturrilha em pé', 'Cadeira Abdutora', 'Cadeira Adutora', 'Agachamento Búlgaro', 'Afundo', 'Levantamento Terra', 'Outro'],
        superior: ['Supino Reto', 'Supino Inclinado', 'Crucifixo', 'Desenvolvimento', 'Elevação Lateral', 'Puxada Alta', 'Remada Curvada', 'Remada Baixa', 'Rosca Direta', 'Rosca Martelo', 'Tríceps Corda', 'Tríceps Testa', 'Mergulho', 'Outro'],
        mesclado: []
    };
    exercisesList.mesclado = [...exercisesList.inferior.slice(0, -1), ...exercisesList.superior];

    // --- UTILITÁRIOS ---
    const formatDateKey = (year, month, day) => `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    
    const getDaysInMonth = (date) => {
        const year = date.getFullYear();
        const month = date.getMonth();
        return {
            daysInMonth: new Date(year, month + 1, 0).getDate(),
            startingDayOfWeek: new Date(year, month, 1).getDay()
        };
    };

    const getDayType = (exercises) => {
        if (!exercises || exercises.length === 0) return '';
        const types = [...new Set(exercises.map(ex => ex.type))];
        if (types.length === 1) return types[0].charAt(0).toUpperCase() + types[0].slice(1);
        return 'Mesclado';
    };

    const saveToStorage = () => {
        localStorage.setItem('gymTrackerData', JSON.stringify(state.gymData));
        localStorage.setItem('gymRoutines', JSON.stringify(state.routines));
    };

    // --- APLICAÇÃO ---
    window.app = {
        render: () => {
            const root = document.getElementById('root');
            root.innerHTML = '';

            // Atualiza TabBar
            document.getElementById('btn-calendar').style.color = state.currentTab === 'calendar' ? '#a855f7' : '#71717a';
            document.getElementById('btn-routine').style.color = state.currentTab === 'routine' ? '#a855f7' : '#71717a';

            if (state.currentTab === 'calendar') renderCalendar(root);
            else renderRoutineTab(root);

            if (state.showModal) renderCalendarModal(root);
            if (state.showRoutineModal) renderRoutineModal(root);

            lucide.createIcons();
        },

        setTab: (tab) => {
            state.currentTab = tab;
            app.render();
        },

        // --- CALENDÁRIO ---
        prevMonth: () => {
            state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() - 1);
            app.render();
        },
        nextMonth: () => {
            state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() + 1);
            app.render();
        },
        dayClick: (day) => {
            const dateKey = formatDateKey(state.currentDate.getFullYear(), state.currentDate.getMonth(), day);
            const dateObj = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day);
            
            state.selectedDay = { day, dateKey, weekdayIndex: dateObj.getDay() }; // 0 = Domingo
            
            const data = state.gymData[dateKey];
            app.resetForm();

            if (data) {
                // Compatibilidade com dados antigos (attended boolean) vs novos (status string)
                if (data.status) {
                    state.modalMode = data.status;
                } else {
                    state.modalMode = data.attended ? 'attended' : 'missed';
                }

                if (state.modalMode === 'attended') {
                    state.weight = data.weight || '';
                    state.workoutType = data.workoutType || '';
                    state.exercises = data.exercises || [{ name: '', customName: '', weight: '', reps: '', sets: '' }];
                    state.notes = data.notes || '';
                    state.photo = data.photo || null;
                } else if (state.modalMode === 'missed') {
                    state.missedReason = data.reason || '';
                    state.customReason = data.customReason || '';
                }
            } else {
                state.modalMode = 'select';
            }
            state.showModal = true;
            app.render();
        },
        resetForm: () => {
            state.weight = '';
            state.workoutType = '';
            state.exercises = [{ name: '', customName: '', weight: '', reps: '', sets: '' }];
            state.notes = '';
            state.photo = null;
            state.missedReason = '';
            state.customReason = '';
        },
        closeModal: () => {
            state.showModal = false;
            app.render();
        },
        setModalMode: (mode) => {
            state.modalMode = mode;
            // Se for descanso, já podemos salvar ou deixar o usuário confirmar? Vamos deixar confirmar no render.
            app.render();
        },

        // --- FORMULÁRIO TREINO (CALENDÁRIO) ---
        updateForm: (field, value) => {
            state[field] = value;
            app.render();
        },
        handlePhoto: (input) => {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    state.photo = reader.result;
                    app.render();
                };
                reader.readAsDataURL(file);
            }
        },
        addExercise: () => {
            state.exercises.push({ name: '', customName: '', weight: '', reps: '', sets: '' });
            app.render();
        },
        removeExercise: (index) => {
            state.exercises.splice(index, 1);
            app.render();
        },
        updateExercise: (index, field, value) => {
            state.exercises[index][field] = value;
            app.render();
        },
        
        // NOVO: Carregar rotina no dia do calendário
        loadRoutineIntoSession: (routineId) => {
            if (!routineId) return;
            const routine = state.routines.find(r => r.id == routineId);
            if (!routine) return;

            // Pega o dia da semana do dia selecionado (0-6)
            const weekday = state.selectedDay.weekdayIndex;
            const exercisesForDay = routine.days[weekday];

            if (exercisesForDay && exercisesForDay.length > 0) {
                // Mapeia para o formato do formulário (remove 'type' pois o form usa lista geral ou type global)
                // Vamos tentar inferir o workoutType baseado na maioria dos exercicios ou setar 'mesclado'
                state.exercises = exercisesForDay.map(ex => ({
                    name: ex.name,
                    customName: ex.customName,
                    weight: ex.weight,
                    reps: ex.reps,
                    sets: ex.sets
                }));
                
                // Tenta inferir o tipo
                const types = [...new Set(exercisesForDay.map(e => e.type))];
                state.workoutType = types.length === 1 ? types[0] : 'mesclado';
                
                alert(`Treino de ${weekdays[weekday]} da rotina "${routine.name}" carregado!`);
            } else {
                alert(`A rotina "${routine.name}" não tem exercícios cadastrados para ${weekdays[weekday]}.`);
            }
            app.render();
        },

        saveData: (status) => {
            const entry = {
                status: status, // 'attended', 'missed', 'rest'
                attended: status === 'attended', // Mantendo retrocompatibilidade
                notes: state.notes
            };

            if (status === 'attended') {
                entry.weight = state.weight;
                entry.workoutType = state.workoutType;
                entry.exercises = state.exercises.filter(ex => ex.name).map(ex => ({
                    ...ex,
                    name: ex.name === 'Outro' ? ex.customName : ex.name
                }));
                entry.photo = state.photo;
            } else if (status === 'missed') {
                entry.reason = state.missedReason;
                entry.customReason = state.missedReason === 'Outro' ? state.customReason : '';
            }
            // Status 'rest' só salva o status e notas (se tiver)

            state.gymData[state.selectedDay.dateKey] = entry;
            saveToStorage();
            state.showModal = false;
            app.resetForm();
            app.render();
        },
        deleteEntry: () => {
            if(confirm('Apagar registro deste dia?')) {
                delete state.gymData[state.selectedDay.dateKey];
                saveToStorage();
                state.showModal = false;
                app.resetForm();
                app.render();
            }
        },

        // --- IMPORT/EXPORT GERAL ---
        exportJSON: () => {
            const data = { exportDate: new Date().toISOString(), data: state.gymData, routines: state.routines };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup-gym-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        },
        importJSON: (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    // Suporte para importar rotina individual ou backup completo
                    if (imported.type === 'single_routine') {
                        state.routines.push(imported.data);
                        alert(`Rotina "${imported.data.name}" importada!`);
                    } else {
                        if (imported.data) state.gymData = imported.data;
                        if (imported.routines) state.routines = imported.routines;
                        alert('Backup completo restaurado!');
                    }
                    saveToStorage();
                    app.render();
                } catch { alert('Erro ao ler arquivo.'); }
            };
            reader.readAsText(file);
            input.value = '';
        },

        // --- ROTINAS (CRUD) ---
        createRoutine: () => {
            state.routineModalMode = 'create';
            state.routineName = '';
            // Estrutura inicial da rotina
            state.currentRoutine = { id: Date.now(), name: '', days: { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [] } };
            state.showRoutineModal = true;
            state.selectedWeekday = null;
            app.render();
        },
        editRoutine: (id, event) => {
            if(event) event.stopPropagation(); // Evita bugs de clique duplo
            
            const routine = state.routines.find(r => r.id === id);
            if(!routine) return;
            
            state.currentRoutine = JSON.parse(JSON.stringify(routine)); // Deep Copy para edição
            state.routineName = routine.name;
            state.routineModalMode = 'edit';
            state.showRoutineModal = true;
            state.selectedWeekday = null;
            app.render();
        },
        deleteRoutine: (id, event) => {
            if(event) event.stopPropagation();
            
            if(confirm('Tem certeza que deseja excluir esta rotina permanentemente?')) {
                state.routines = state.routines.filter(r => r.id !== id);
                saveToStorage();
                // Se estava vendo a rotina excluida, volta pra lista
                if(state.viewingRoutineId === id) {
                    state.viewingRoutineId = null;
                }
                app.render();
            }
        },
        saveRoutine: () => {
            if (!state.routineName.trim()) return alert('Dê um nome para a rotina');
            state.currentRoutine.name = state.routineName;
            
            const idx = state.routines.findIndex(r => r.id === state.currentRoutine.id);
            if (idx >= 0) state.routines[idx] = state.currentRoutine;
            else state.routines.push(state.currentRoutine);
            
            saveToStorage();
            state.showRoutineModal = false;
            
            // Força atualização da view se estivermos vendo essa rotina
            app.render();
        },

        // --- EXERCÍCIOS DA ROTINA (CRUD) ---
        openDayEditor: (dayIndex) => {
            state.selectedWeekday = dayIndex;
            // Carrega exercícios do dia para edição
            const days = state.currentRoutine.days[dayIndex];
            state.routineExercises = days.length > 0 ? JSON.parse(JSON.stringify(days)) : [];
            app.render();
        },
        addRoutineExercise: () => {
            state.routineExercises.push({ type: '', name: '', customName: '', weight: '', reps: '', sets: '' });
            app.render();
        },
        removeRoutineExercise: (i) => {
            state.routineExercises.splice(i, 1);
            app.render();
        },
        updateRoutineExercise: (i, field, val) => {
            state.routineExercises[i][field] = val;
            app.render();
        },
        saveDayExercises: () => {
            const filtered = state.routineExercises.filter(ex => ex.type && ex.name);
            state.currentRoutine.days[state.selectedWeekday] = filtered;
            
            // Se estivermos editando uma rotina existente (modo edit), já salvamos no array global para refletir imediatamente
            if (state.routineModalMode === 'edit') {
                 const idx = state.routines.findIndex(r => r.id === state.currentRoutine.id);
                 if (idx >= 0) {
                     state.routines[idx] = state.currentRoutine;
                     saveToStorage();
                 }
            }
            
            state.selectedWeekday = null;
            app.render();
        },

        // --- NAVEGAÇÃO INTERNA DA FICHA ---
        openRoutineView: (id) => {
            state.viewingRoutineId = id;
            state.viewingDay = null;
            app.render();
        },
        closeRoutineView: () => {
            state.viewingRoutineId = null;
            app.render();
        },
        openDayView: (idx) => {
            state.viewingDay = idx;
            app.render();
        },
        closeDayView: () => {
            state.viewingDay = null;
            app.render();
        },

        // --- IMPORT/EXPORT INDIVIDUAL ---
        exportSingleRoutine: (id, event) => {
            if(event) event.stopPropagation();
            const routine = state.routines.find(r => r.id === id);
            const data = { type: 'single_routine', data: routine };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `rotina-${routine.name.replace(/\s+/g, '-').toLowerCase()}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }
    };

    // --- RENDERIZADORES ---

    function renderCalendar(root) {
        const { daysInMonth, startingDayOfWeek } = getDaysInMonth(state.currentDate);
        
        let gridHtml = '';
        for(let i=0; i<startingDayOfWeek; i++) gridHtml += '<div class="aspect-square"></div>';
        
        for(let i=1; i<=daysInMonth; i++) {
            const dateKey = formatDateKey(state.currentDate.getFullYear(), state.currentDate.getMonth(), i);
            const entry = state.gymData[dateKey];
            let classes = 'aspect-square rounded-xl flex flex-col items-center justify-center font-bold text-sm transition-all active:scale-95 shadow-md ';
            let style = 'background-color: #27272a; color: white;';
            
            // Lógica de Cores
            if (entry) {
                if (entry.status === 'rest') {
                    classes += 'bg-blue-600 text-white shadow-blue-900/50';
                    style = '';
                } else if (entry.status === 'missed' || (entry.attended === false)) {
                    classes += 'bg-red-600 text-white shadow-red-900/50';
                    style = '';
                } else if (entry.status === 'attended' || entry.attended) {
                    classes += 'bg-green-600 text-white shadow-green-900/50';
                    style = '';
                }
            } else {
                 classes += 'hover:bg-zinc-700';
            }

            gridHtml += `<button onclick="app.dayClick(${i})" class="${classes}" style="${style}">${i}</button>`;
        }

        root.innerHTML = `
            <div class="flex items-center justify-between mb-6 pt-2">
                <div>
                    <h1 class="text-2xl font-bold text-white flex items-center gap-2">
                        <i data-lucide="dumbbell" class="text-purple-500"></i> Gym Daily
                    </h1>
                    <p class="text-zinc-400 text-xs">Sua evolução dia após dia</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="app.prevMonth()" class="p-2 rounded-full bg-zinc-800 hover:bg-zinc-700"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                    <button onclick="app.nextMonth()" class="p-2 rounded-full bg-zinc-800 hover:bg-zinc-700"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                </div>
            </div>

            <div class="bg-zinc-900 rounded-3xl p-4 shadow-xl mb-6 border border-zinc-800">
                <h2 class="text-center text-lg font-bold text-white mb-4 capitalize">
                    ${monthNames[state.currentDate.getMonth()]} <span class="text-purple-400">${state.currentDate.getFullYear()}</span>
                </h2>

                <div class="grid grid-cols-7 gap-2 mb-2">
                    ${dayNames.map(d => `<div class="text-center text-zinc-500 font-bold text-xs uppercase tracking-wider">${d}</div>`).join('')}
                </div>
                
                <div class="grid grid-cols-7 gap-2">
                    ${gridHtml}
                </div>
            </div>

            <div class="flex justify-center gap-4 mb-6 text-xs font-medium text-zinc-400">
                <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 bg-green-600 rounded-full"></div>Treino</div>
                <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 bg-red-600 rounded-full"></div>Falta</div>
                <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 bg-blue-600 rounded-full"></div>Descanso</div>
            </div>

            <div class="flex gap-3">
                <button onclick="app.exportJSON()" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2 border border-zinc-700 transition-all active:scale-95">
                    <i data-lucide="download" class="w-4 h-4"></i> Exportar
                </button>
                <label class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2 cursor-pointer border border-zinc-700 transition-all active:scale-95">
                    <i data-lucide="upload" class="w-4 h-4"></i> Importar
                    <input type="file" accept=".json" class="hidden" onchange="app.importJSON(this)">
                </label>
            </div>
        `;
    }

    function renderRoutineTab(root) {
        // Encontra a rotina atual baseada no ID para garantir reatividade
        const activeRoutine = state.viewingRoutineId ? state.routines.find(r => r.id === state.viewingRoutineId) : null;

        if (!activeRoutine) {
            // --- LISTA DE ROTINAS ---
            const listHtml = state.routines.map(r => `
                <div class="group w-full rounded-2xl p-4 mb-3 bg-zinc-900 border border-zinc-800 hover:border-purple-900 transition-all relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-purple-600"></div>
                    <div class="flex justify-between items-center">
                        <div onclick="app.openRoutineView(${r.id})" class="flex-1 cursor-pointer">
                            <h3 class="text-lg font-bold text-white">${r.name}</h3>
                            <p class="text-zinc-500 text-xs mt-0.5">${r.days ? Object.values(r.days).reduce((acc, d) => acc + d.length, 0) : 0} exercícios cadastrados</p>
                        </div>
                        <div class="flex gap-1 ml-2">
                             <button onclick="app.exportSingleRoutine(${r.id}, event)" class="p-2 text-zinc-400 hover:text-white rounded-lg hover:bg-zinc-800" title="Exportar Rotina">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </button>
                            <button onclick="app.editRoutine(${r.id}, event)" class="p-2 text-purple-400 hover:text-purple-300 rounded-lg hover:bg-purple-900/20">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                            <button onclick="app.deleteRoutine(${r.id}, event)" class="p-2 text-red-400 hover:text-red-300 rounded-lg hover:bg-red-900/20">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            root.innerHTML = `
                <div class="mb-6 pt-2">
                    <h1 class="text-2xl font-bold text-white mb-1">Minhas Rotinas</h1>
                    <p class="text-zinc-400 text-sm">Gerencie seus treinos semanais</p>
                </div>

                <div class="flex gap-3 mb-6">
                    <button onclick="app.createRoutine()" class="flex-1 bg-purple-700 hover:bg-purple-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-purple-900/20 transition-all active:scale-95">
                        <i data-lucide="plus" class="w-5 h-5"></i> Criar Nova
                    </button>
                     <label class="px-4 bg-zinc-800 hover:bg-zinc-700 text-white rounded-xl flex items-center justify-center cursor-pointer border border-zinc-700 transition-all">
                        <i data-lucide="upload" class="w-5 h-5"></i>
                        <input type="file" accept=".json" class="hidden" onchange="app.importJSON(this)">
                    </label>
                </div>

                <div class="pb-20">
                    ${listHtml}
                    ${state.routines.length === 0 ? `
                        <div class="text-center py-12 border-2 border-dashed border-zinc-800 rounded-2xl">
                            <i data-lucide="clipboard-list" class="w-12 h-12 text-zinc-600 mx-auto mb-3"></i>
                            <p class="text-zinc-500">Nenhuma rotina criada</p>
                        </div>
                    ` : ''}
                </div>
            `;
        } else if (state.viewingDay === null) {
            // --- DETALHE DA ROTINA (SELEÇÃO DE DIA - VISUAL LISTA BONITA) ---
            const r = activeRoutine;
            const daysList = weekdays.map((day, idx) => {
                const len = r.days[idx].length;
                const type = getDayType(r.days[idx]);
                // Layout bonito em lista
                return `
                    <button onclick="app.openDayView(${idx})" class="w-full flex items-center justify-between p-4 mb-2 rounded-xl bg-zinc-900 border border-zinc-800 hover:border-purple-700 hover:bg-zinc-800 transition-all group">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-zinc-800 flex items-center justify-center group-hover:bg-purple-900/30 group-hover:text-purple-400 transition-colors">
                                <span class="font-bold text-sm">${day.substring(0,3)}</span>
                            </div>
                            <div class="text-left">
                                <h3 class="text-white font-semibold">${day}</h3>
                                <p class="text-xs ${type ? 'text-purple-400' : 'text-zinc-500'}">${type || 'Descanso'}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 text-zinc-500">
                            <span class="text-xs font-medium">${len > 0 ? len + ' exercícios' : ''}</span>
                            <i data-lucide="chevron-right" class="w-4 h-4"></i>
                        </div>
                    </button>
                `;
            }).join('');

            root.innerHTML = `
                <div class="flex items-center gap-3 mb-6 pt-2">
                    <button onclick="app.closeRoutineView()" class="p-2 rounded-full bg-zinc-800 hover:bg-zinc-700"><i data-lucide="arrow-left" class="text-white w-5 h-5"></i></button>
                    <div class="flex-1">
                        <h1 class="text-xl font-bold text-white truncate">${r.name}</h1>
                    </div>
                    <button onclick="app.editRoutine(${r.id})" class="text-purple-400 text-sm font-semibold px-3 py-1 bg-purple-900/20 rounded-lg">Editar</button>
                </div>
                <div class="pb-20 flex flex-col gap-1">
                    ${daysList}
                </div>
            `;
        } else {
            // --- VISUALIZAÇÃO DOS EXERCÍCIOS DO DIA ---
            const r = activeRoutine;
            const d = state.viewingDay;
            const exercises = r.days[d];
            
            const exList = exercises.length === 0 
                ? `<div class="text-center py-20 text-zinc-500">
                        <i data-lucide="coffee" class="w-12 h-12 mx-auto mb-3 opacity-20"></i>
                        <p>Nenhum exercício neste dia</p>
                        <button onclick="app.editRoutine(${r.id})" class="text-purple-400 mt-4 text-sm hover:underline">Adicionar Exercícios</button>
                   </div>` 
                : exercises.map((ex, i) => `
                    <div class="flex gap-4 p-4 rounded-2xl mb-3 bg-zinc-900 border border-zinc-800 items-center">
                        <div class="w-12 h-12 rounded-xl bg-zinc-800 flex items-center justify-center flex-shrink-0 text-purple-500 font-bold">
                            ${i+1}
                        </div>
                        <div class="flex-1">
                            <h3 class="text-white font-bold text-base leading-tight mb-1">${ex.name === 'Outro' ? ex.customName : ex.name}</h3>
                            <div class="flex flex-wrap gap-2 text-xs text-zinc-400">
                                <span class="bg-zinc-800 px-2 py-0.5 rounded text-zinc-300">${ex.sets} Séries</span>
                                <span class="bg-zinc-800 px-2 py-0.5 rounded text-zinc-300">${ex.reps} Reps</span>
                                ${ex.weight ? `<span class="bg-zinc-800 px-2 py-0.5 rounded text-yellow-500/80 font-mono">${ex.weight}kg</span>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');

            root.innerHTML = `
                <div class="flex items-center gap-3 mb-4 pt-2">
                    <button onclick="app.closeDayView()" class="p-2 rounded-full bg-zinc-800 hover:bg-zinc-700"><i data-lucide="arrow-left" class="text-white w-5 h-5"></i></button>
                    <div class="flex-1">
                        <h1 class="text-xl font-bold text-white">${weekdays[d]}</h1>
                        <p class="text-xs text-purple-400 font-semibold uppercase tracking-wider">${getDayType(exercises)}</p>
                    </div>
                </div>
                <div class="pb-20">${exList}</div>
            `;
        }
    }

    // --- MODAL CALENDÁRIO ---
    function renderCalendarModal(root) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 flex items-end sm:items-center justify-center sm:p-4 z-50';
        modal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
        modal.style.backdropFilter = 'blur(4px)';
        
        // Renderização dinâmica do conteúdo do modal
        let content = '';
        
        if (state.modalMode === 'select') {
            content = `
                <h3 class="text-lg font-bold text-white text-center mb-6">Como foi hoje?</h3>
                <div class="flex flex-col gap-3">
                    <button onclick="app.setModalMode('attended')" class="bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-3 transition-transform active:scale-95">
                        <i data-lucide="check-circle-2" class="w-6 h-6"></i> Treinei!
                    </button>
                    <button onclick="app.setModalMode('rest')" class="bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-3 transition-transform active:scale-95">
                        <i data-lucide="coffee" class="w-6 h-6"></i> Descansei
                    </button>
                    <button onclick="app.setModalMode('missed')" class="bg-red-600 hover:bg-red-700 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-3 transition-transform active:scale-95">
                        <i data-lucide="x-circle" class="w-6 h-6"></i> Faltei
                    </button>
                </div>
            `;
        } else if (state.modalMode === 'attended') {
            // Dropdown de Rotinas para carregar
            const routinesOptions = state.routines.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            
            const exHtml = state.exercises.map((ex, i) => `
                <div class="p-4 rounded-xl mb-3 space-y-3 bg-zinc-900 border border-zinc-700 relative">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-zinc-400 text-xs uppercase tracking-wider">Exercício ${i+1}</span>
                        <button onclick="app.removeExercise(${i})" class="text-red-500 p-1"><i data-lucide="trash" class="w-4 h-4"></i></button>
                    </div>
                    <select onchange="app.updateExercise(${i}, 'name', this.value)" class="w-full p-3 rounded-lg bg-black border border-zinc-700 text-white focus:border-purple-500 outline-none">
                        <option value="">Selecione o exercício...</option>
                        ${(exercisesList[state.workoutType] || []).map(opt => `<option value="${opt}" ${ex.name === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                    </select>
                    ${ex.name === 'Outro' ? `<input type="text" value="${ex.customName}" oninput="app.updateExercise(${i}, 'customName', this.value)" class="w-full p-3 rounded-lg bg-black border border-zinc-700 text-white focus:border-purple-500 outline-none" placeholder="Nome do exercício">` : ''}
                    <div class="grid grid-cols-3 gap-3">
                        <div class="relative">
                            <input type="number" value="${ex.weight}" oninput="app.updateExercise(${i}, 'weight', this.value)" class="w-full p-3 rounded-lg bg-black border border-zinc-700 text-white focus:border-purple-500 outline-none pl-8" placeholder="0">
                            <span class="absolute left-3 top-3 text-zinc-500 text-xs">Kg</span>
                        </div>
                        <div class="relative">
                            <input type="number" value="${ex.sets}" oninput="app.updateExercise(${i}, 'sets', this.value)" class="w-full p-3 rounded-lg bg-black border border-zinc-700 text-white focus:border-purple-500 outline-none pl-8" placeholder="0">
                            <span class="absolute left-3 top-3 text-zinc-500 text-xs">Sér</span>
                        </div>
                        <div class="relative">
                            <input type="number" value="${ex.reps}" oninput="app.updateExercise(${i}, 'reps', this.value)" class="w-full p-3 rounded-lg bg-black border border-zinc-700 text-white focus:border-purple-500 outline-none pl-8" placeholder="0">
                            <span class="absolute left-3 top-3 text-zinc-500 text-xs">Rep</span>
                        </div>
                    </div>
                </div>
            `).join('');

            content = `
                <div class="space-y-5">
                    ${state.routines.length > 0 ? `
                    <div class="bg-purple-900/20 p-3 rounded-xl border border-purple-500/30">
                        <label class="block text-xs font-bold text-purple-300 mb-2 uppercase">Carregar da Rotina</label>
                        <select onchange="app.loadRoutineIntoSession(this.value)" class="w-full p-2 rounded-lg bg-black border border-purple-500/50 text-white text-sm">
                            <option value="">Selecione para preencher...</option>
                            ${routinesOptions}
                        </select>
                    </div>
                    ` : ''}

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-zinc-500 mb-1.5 uppercase">Tipo</label>
                            <select onchange="app.updateForm('workoutType', this.value)" class="w-full p-3 rounded-xl bg-zinc-900 border border-zinc-700 text-white focus:border-purple-500 outline-none">
                                <option value="">Selecione...</option>
                                <option value="inferior" ${state.workoutType === 'inferior' ? 'selected' : ''}>Inferior</option>
                                <option value="superior" ${state.workoutType === 'superior' ? 'selected' : ''}>Superior</option>
                                <option value="mesclado" ${state.workoutType === 'mesclado' ? 'selected' : ''}>Mesclado</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-zinc-500 mb-1.5 uppercase">Peso (kg)</label>
                            <input type="number" step="0.1" value="${state.weight}" oninput="app.updateForm('weight', this.value)" class="w-full p-3 rounded-xl bg-zinc-900 border border-zinc-700 text-white focus:border-purple-500 outline-none">
                        </div>
                    </div>

                    ${state.workoutType ? `
                        <div class="flex justify-between items-center pt-2">
                            <label class="text-sm font-bold text-white">Exercícios</label>
                            <button onclick="app.addExercise()" class="text-purple-400 font-bold text-sm hover:text-purple-300">+ Adicionar</button>
                        </div>
                        <div class="max-h-[40vh] overflow-y-auto pr-1">
                            ${exHtml}
                        </div>
                    ` : ''}

                    <div>
                         <label class="block text-xs font-bold text-zinc-500 mb-1.5 uppercase">Observações</label>
                         <textarea oninput="app.updateForm('notes', this.value)" class="w-full p-3 rounded-xl bg-zinc-900 border border-zinc-700 text-white focus:border-purple-500 outline-none" rows="2" placeholder="Como foi o treino?">${state.notes}</textarea>
                    </div>

                    <button onclick="app.saveData('attended')" class="w-full bg-purple-700 hover:bg-purple-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-purple-900/30">Salvar Treino</button>
                    ${state.gymData[state.selectedDay.dateKey] ? `<button onclick="app.deleteEntry()" class="w-full text-red-400 font-semibold py-2">Excluir Registro</button>` : ''}
                </div>
            `;
        } else if (state.modalMode === 'rest') {
             content = `
                <div class="text-center py-6">
                    <div class="w-20 h-20 bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="coffee" class="w-10 h-10 text-blue-400"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">Dia de Descanso</h3>
                    <p class="text-zinc-400 text-sm mb-6">O descanso é essencial para a hipertrofia e recuperação.</p>
                    
                    <div class="mb-6 text-left">
                        <label class="block text-xs font-bold text-zinc-500 mb-1.5 uppercase">Observação (Opcional)</label>
                        <textarea oninput="app.updateForm('notes', this.value)" class="w-full p-3 rounded-xl bg-zinc-900 border border-zinc-700 text-white focus:border-blue-500 outline-none" rows="2" placeholder="Ex: Senti dores musculares...">${state.notes}</textarea>
                    </div>

                    <button onclick="app.saveData('rest')" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold">Confirmar Descanso</button>
                    ${state.gymData[state.selectedDay.dateKey] ? `<button onclick="app.deleteEntry()" class="w-full text-red-400 font-semibold py-3 mt-2">Excluir Registro</button>` : ''}
                </div>
             `;
        } else {
            // Missed
            content = `
                <div class="space-y-4">
                    <label class="block text-xs font-bold text-zinc-500 mb-2 uppercase">Motivo da Falta</label>
                    <div class="space-y-2">
                        ${missedReasons.map(r => `
                            <label class="flex items-center p-4 border border-zinc-700 rounded-xl cursor-pointer bg-zinc-900 hover:bg-zinc-800 transition-colors ${state.missedReason === r ? 'border-red-500 bg-red-900/10' : ''}">
                                <input type="radio" name="reason" value="${r}" ${state.missedReason === r ? 'checked' : ''} onchange="app.updateForm('missedReason', this.value)" class="mr-3 w-5 h-5 accent-red-600">
                                <span class="text-white text-sm font-medium">${r}</span>
                            </label>
                        `).join('')}
                    </div>
                    ${state.missedReason === 'Outro' ? `<textarea oninput="app.updateForm('customReason', this.value)" class="w-full p-3 rounded-xl bg-zinc-900 border border-zinc-700 text-white focus:border-red-500 outline-none" placeholder="Descreva o motivo...">${state.customReason}</textarea>` : ''}
                    
                    <button onclick="app.saveData('missed')" class="w-full bg-red-600 hover:bg-red-500 text-white py-4 rounded-xl font-bold mt-4">Confirmar Falta</button>
                    ${state.gymData[state.selectedDay.dateKey] ? `<button onclick="app.deleteEntry()" class="w-full text-red-400 font-semibold py-2">Excluir Registro</button>` : ''}
                </div>
            `;
        }

        modal.innerHTML = `
            <div class="bg-black w-full sm:w-[450px] sm:rounded-3xl rounded-t-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                <div class="flex justify-between items-center p-5 border-b border-zinc-800 bg-zinc-900">
                    <div>
                        <h3 class="text-xl font-bold text-white">Dia ${state.selectedDay.day}</h3>
                        <p class="text-zinc-500 text-xs uppercase font-bold tracking-widest">${monthNames[state.currentDate.getMonth()]}</p>
                    </div>
                    <button onclick="app.closeModal()" class="p-2 rounded-full bg-zinc-800 hover:bg-zinc-700"><i data-lucide="x" class="w-5 h-5 text-white"></i></button>
                </div>
                <div class="p-5 overflow-y-auto custom-scrollbar">
                    ${content}
                </div>
            </div>
        `;
        root.appendChild(modal);
    }

    // --- MODAL ROTINA ---
    function renderRoutineModal(root) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 flex items-end sm:items-center justify-center sm:p-4 z-50';
        modal.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
        
        let content = '';

        if (state.selectedWeekday === null) {
            // Edição Principal
            content = `
                <div class="mb-6">
                    <label class="block text-xs font-bold text-zinc-500 mb-2 uppercase">Nome da Rotina</label>
                    <input type="text" value="${state.routineName}" oninput="state.routineName = this.value" class="w-full p-4 rounded-xl bg-zinc-900 border border-zinc-700 text-white focus:border-purple-500 outline-none text-lg font-bold" placeholder="Ex: Hipertrofia ABCD">
                </div>
                <div class="space-y-2 mb-6 max-h-[50vh] overflow-y-auto">
                    <label class="block text-xs font-bold text-zinc-500 mb-2 uppercase">Configurar Dias</label>
                    ${weekdays.map((d, i) => `
                        <button onclick="app.openDayEditor(${i})" class="w-full p-4 rounded-xl text-left flex justify-between items-center bg-zinc-900 border border-zinc-800 hover:border-purple-600 transition-all">
                            <span class="text-white font-bold">${d}</span>
                            <span class="text-zinc-500 text-sm bg-zinc-800 px-2 py-1 rounded">${state.currentRoutine.days[i].length} ex.</span>
                        </button>
                    `).join('')}
                </div>
                <button onclick="app.saveRoutine()" class="w-full bg-purple-700 hover:bg-purple-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-purple-900/30">Salvar Rotina</button>
            `;
        } else {
            // Edição dos Exercícios do Dia
            const exList = state.routineExercises.map((ex, i) => `
                <div class="p-4 rounded-xl space-y-3 bg-zinc-900 border border-zinc-700 mb-3 relative group">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-zinc-500 text-xs uppercase">Exercício ${i+1}</span>
                        <button onclick="app.removeRoutineExercise(${i})" class="text-red-500 opacity-60 group-hover:opacity-100"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <select onchange="app.updateRoutineExercise(${i}, 'type', this.value)" class="w-full p-2.5 rounded-lg bg-black border border-zinc-700 text-white focus:border-purple-500 outline-none text-sm">
                            <option value="">Grupo...</option>
                            <option value="inferior" ${ex.type === 'inferior' ? 'selected' : ''}>Inferior</option>
                            <option value="superior" ${ex.type === 'superior' ? 'selected' : ''}>Superior</option>
                        </select>
                        
                        <select onchange="app.updateRoutineExercise(${i}, 'name', this.value)" class="w-full p-2.5 rounded-lg bg-black border border-zinc-700 text-white focus:border-purple-500 outline-none text-sm">
                            <option value="">Exercício...</option>
                            ${(exercisesList[ex.type] || []).map(opt => `<option value="${opt}" ${ex.name === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                        </select>
                    </div>

                    ${ex.name === 'Outro' ? `<input type="text" value="${ex.customName}" oninput="app.updateRoutineExercise(${i}, 'customName', this.value)" class="w-full p-3 rounded-lg bg-black border border-zinc-700 text-white text-sm" placeholder="Nome personalizado">` : ''}

                    <div class="grid grid-cols-3 gap-3">
                        <input type="text" value="${ex.weight}" oninput="app.updateRoutineExercise(${i}, 'weight', this.value)" class="p-2.5 rounded-lg bg-black border border-zinc-700 text-white text-center text-sm" placeholder="Kg">
                        <input type="text" value="${ex.sets}" oninput="app.updateRoutineExercise(${i}, 'sets', this.value)" class="p-2.5 rounded-lg bg-black border border-zinc-700 text-white text-center text-sm" placeholder="Séries">
                        <input type="text" value="${ex.reps}" oninput="app.updateRoutineExercise(${i}, 'reps', this.value)" class="p-2.5 rounded-lg bg-black border border-zinc-700 text-white text-center text-sm" placeholder="Reps">
                    </div>
                </div>
            `).join('');

            content = `
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-xl font-bold text-white">${weekdays[state.selectedWeekday]}</h4>
                    <button onclick="app.addRoutineExercise()" class="text-purple-400 font-bold text-sm bg-purple-900/20 px-3 py-1.5 rounded-lg hover:bg-purple-900/40">+ Adicionar</button>
                </div>
                
                <div class="mb-4 max-h-[60vh] overflow-y-auto pr-1 custom-scrollbar">
                    ${state.routineExercises.length ? exList : '<p class="text-zinc-500 text-center py-8">Nenhum exercício adicionado.</p>'}
                </div>
                
                <button onclick="app.saveDayExercises()" class="w-full bg-purple-700 hover:bg-purple-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-purple-900/30">Confirmar Dia</button>
            `;
        }

        modal.innerHTML = `
            <div class="bg-black w-full sm:w-[500px] sm:rounded-3xl rounded-t-3xl shadow-2xl flex flex-col max-h-[95vh]">
                <div class="flex justify-between items-center p-5 border-b border-zinc-800 bg-zinc-900">
                    <h3 class="text-lg font-bold text-white">${state.routineModalMode === 'create' ? 'Nova Rotina' : 'Editar Rotina'}</h3>
                    <button onclick="state.showRoutineModal = false; state.selectedWeekday = null; app.render()" class="p-2 rounded-full bg-zinc-800 hover:bg-zinc-700"><i data-lucide="x" class="w-5 h-5 text-white"></i></button>
                </div>
                <div class="p-5 overflow-y-auto custom-scrollbar">${content}</div>
            </div>
        `;
        root.appendChild(modal);
    }

    // Inicializa
    app.render();

</script>
</body>
</html>