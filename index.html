<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>GymDaily</title>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#09090b" id="theme-color-meta" />
    <link rel="apple-touch-icon" href="../gym-daily/images/gymdaily.png" />
    <link rel="icon" sizes="192x192" href="../gym-daily/images/gymdaily.png" />

    <script src="libs/tailwind.js"></script>
    <script src="libs/lucide.js"></script>

    <style>
      :root {
        /* --- MODO ESCURO (Dark Mode - Tinted Purple) --- */

        /* O segredo aqui: N√£o usamos preto puro (#000000) nem cinza neutro (#18181b).
           Usamos tons muito escuros de Violeta/Azul (Deep Violet Greys).
        */

        /* Fundo Geral: Um preto profundo com leve toque de berinjela/roxo noturno */
        --bg-app: #0f0e13;

        /* Superf√≠cie (Cards): Um cinza-chumbo, mas com base roxa */
        --bg-surface: #1a1923;

        /* Inputs: Um pouco mais escuro que a superf√≠cie */
        --bg-input: #13121b;

        /* Bordas: Roxo acinzentado muito discreto */
        --border-color: #2e2b3b;

        /* Textos */
        --text-main: #f3f0ff; /* Branco com 1% de roxo (evita o brilho excessivo do branco puro) */
        --text-muted: #a39eb5; /* Cinza claro "lavanda" */
        --text-dim: #716d82; /* Cinza escuro "ametista" */

        /* --- MARCA (O Roxo Principal - Mantido Vibrante) --- */
        --primary: #9333ea;
        --primary-hover: #7e22ce;
        --primary-faint: rgba(147, 51, 234, 0.15);

        /* --- STATUS (Mantidos com leve desatura√ß√£o para casar com o fundo) --- */
        --success: #16a34a;
        --success-faint: rgba(22, 163, 74, 0.15);
        --danger: #dc2626;
        --danger-faint: rgba(220, 38, 38, 0.15);
        --info: #2563eb;
        --info-faint: rgba(37, 99, 235, 0.15);
      }

      /* --- MODO CLARO (Lavanda Suave / Tinted Purple) --- */
      /* --- MODO CLARO (Legibilidade Total + Identidade Roxa) --- */
      .light-mode {
        /* Fundo: Um tom "Gelo/Lil√°s" muito suave, quase branco */
        --bg-app: #f5f3ff;

        /* Superf√≠cie (Cards): Branco PURO para destacar do fundo */
        --bg-surface: #ffffff;

        /* Inputs: Um cinza muito leve para diferenciar do branco */
        --bg-input: #f4f4f5;

        /* Bordas: Roxo bem clarinho para delimitar √°reas sem pesar */
        --border-color: #ddd6fe;

        /* Textos: AQUI EST√Å O SEGREDO DA LEITURA */
        --text-main: #2e1065; /* Roxo muito escuro (quase preto) */
        --text-muted: #5b21b6; /* Roxo m√©dio para textos secund√°rios */
        --text-dim: #7c3aed; /* Roxo vibrante para √≠cones/detalhes */

        /* As cores de status e marca continuam as mesmas do root */
      }

      /* Reset e Configura√ß√µes Base */
      html,
      body {
        overscroll-behavior-y: none;
        background-color: var(--bg-app);
        color: var(--text-main);
        -webkit-tap-highlight-color: transparent;
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        transition: background-color 0.3s ease, color 0.3s ease,
          border-color 0.3s ease;
      }

      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: var(--bg-surface);
      }
      ::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 3px;
      }

      input,
      select,
      textarea {
        font-size: 16px !important;
      }
    </style>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              app: "var(--bg-app)",
              surface: "var(--bg-surface)",
              inputbg: "var(--bg-input)",
              bordercol: "var(--border-color)",

              // Marca com varia√ß√£o Faint (Fraca)
              brand: {
                DEFAULT: "var(--primary)",
                hover: "var(--primary-hover)",
                faint: "var(--primary-faint)",
              },

              txt: {
                main: "var(--text-main)",
                muted: "var(--text-muted)",
                dim: "var(--text-dim)",
              },

              // Status com varia√ß√µes Faint
              status: {
                success: "var(--success)",
                success_faint: "var(--success-faint)",

                danger: "var(--danger)",
                danger_faint: "var(--danger-faint)",

                info: "var(--info)",
                info_faint: "var(--info-faint)",
              },
            },
            borderRadius: {
              lg: "4px",
              xl: "8px",
              "2xl": "8px",
              "3xl": "12px",
              full: "8px",
            },
          },
        },
      };
    </script>
  </head>

  <body class="min-h-screen pb-24 select-none">
    <div id="root" class="max-w-md mx-auto p-4"></div>

    <div
      class="fixed bottom-0 left-0 right-0 border-t z-40 bg-surface border-bordercol"
    >
      <div class="max-w-md mx-auto grid grid-cols-5">
        <button
          onclick="app.setTab('calendar')"
          id="btn-calendar"
          class="py-3 flex flex-col items-center gap-1 transition-colors"
        >
          <i data-lucide="calendar" class="w-5 h-5"></i>
          <span class="text-[9px] font-bold">Di√°rio</span>
        </button>
        <button
          onclick="app.setTab('routine')"
          id="btn-routine"
          class="py-3 flex flex-col items-center gap-1 transition-colors"
        >
          <i data-lucide="dumbbell" class="w-5 h-5"></i>
          <span class="text-[9px] font-bold">Ficha</span>
        </button>
        <button
          onclick="app.setTab('diet')"
          id="btn-diet"
          class="py-3 flex flex-col items-center gap-1 transition-colors"
        >
          <i data-lucide="utensils" class="w-5 h-5"></i>
          <span class="text-[9px] font-bold">Dieta</span>
        </button>
        <button
          onclick="app.setTab('stats')"
          id="btn-stats"
          class="py-3 flex flex-col items-center gap-1 transition-colors"
        >
          <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
          <span class="text-[9px] font-bold">Evolu√ß√£o</span>
        </button>
        <button
          onclick="app.setTab('tools')"
          id="btn-tools"
          class="py-3 flex flex-col items-center gap-1 transition-colors"
        >
          <i data-lucide="timer" class="w-5 h-5"></i>
          <span class="text-[9px] font-bold">Tools</span>
        </button>
      </div>
    </div>

    <script>
      function escapeHtml(text) {
        if (text === null || text === undefined) return "";
        const div = document.createElement("div");
        div.textContent = String(text);
        return div.innerHTML;
      }

      // === ESTADO GLOBAL ===
      const state = {
        // TEMA: Recupera ou define Dark como padr√£o
        theme: localStorage.getItem("gymTheme") || "dark",

        // TUTORIAL (Modal de Funcionalidades)
        // L√≥gica: Se "gymHasVisited" n√£o existe (null), retorna true e mostra o modal.
        showFeaturesModal: !localStorage.getItem("gymHasVisited"),

        // DADOS DO USU√ÅRIO
        diet: JSON.parse(localStorage.getItem("gymDiet")) || [],
        showDietModal: false,
        editingMeal: null,

        activeTool: null,
        timerRunning: false,
        timerTime: 60,
        timerTotal: 60,
        timerInterval: null,

        bodyMeasurements: JSON.parse(
          localStorage.getItem("gymMeasurements")
        ) || {
          armRight: "",
          armLeft: "",
          legRight: "",
          legLeft: "",
          chest: "",
          waist: "",
          calves: "",
        },

        dailyCheck: JSON.parse(localStorage.getItem("gymChecklist")) || {
          creatine: false,
          water: false,
          sleep: false,
          protein: false,
        },

        statsPeriod: "month",
        statsMetric: "weight",

        // CONTROLE DE UI
        showExercisePicker: false,
        pickerFilter: "inferior",
        pickerSearch: "",
        editingIndex: null,
        pickerContext: "routine",

        // LOGIN
        isLogged: false,
        userPhoto: null,
        userName: "",
        showProfileMenu: false,

        viewingImage: null,
        currentTab: "calendar",
        currentDate: new Date(),

        // DADOS PRINCIPAIS
        gymData: JSON.parse(localStorage.getItem("gymTrackerData")) || {},
        routines: JSON.parse(localStorage.getItem("gymRoutines")) || [],

        selectedDay: null,
        showModal: false,
        modalMode: "select",

        // FORMUL√ÅRIO DE TREINO
        weight: "",
        workoutType: "",
        exercises: [
          { name: "", customName: "", weight: "", reps: "", sets: "" },
        ],
        notes: "",
        photo: null,
        missedReason: "",
        customReason: "",

        // ROTINAS
        showRoutineModal: false,
        routineModalMode: "create",
        currentRoutine: null,
        routineName: "",
        selectedWeekday: null,
        routineExercises: [],

        viewingRoutineId: null,
        viewingDay: null,
      };

      const weekdays = [
        "Domingo",
        "Segunda-feira",
        "Ter√ßa-feira",
        "Quarta-feira",
        "Quinta-feira",
        "Sexta-feira",
        "S√°bado",
      ];
      const monthNames = [
        "Janeiro",
        "Fevereiro",
        "Mar√ßo",
        "Abril",
        "Maio",
        "Junho",
        "Julho",
        "Agosto",
        "Setembro",
        "Outubro",
        "Novembro",
        "Dezembro",
      ];
      const dayNames = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"];

      // SEUS GIFs
      const exerciseGifs = {
        Esteira:
          "https://i.pinimg.com/originals/2c/87/4b/2c874b1b5b30a07eeee1e3002d2e52b4.gif",
        Escada:
          "https://www.hipertrofia.org/blog/wp-content/uploads/2024/09/walking-on-stepmill.gif",
        "Bicicleta Ergom√©trica":
          "https://i.pinimg.com/originals/88/00/6a/88006a03e1da8a94a7843f5306dac42f.gif",
        "El√≠ptico (Transport)":
          "https://gymvisual.com/img/p/1/5/8/4/1/15841.gif",
        "Pular Corda":
          "https://www.mundoboaforma.com.br/wp-content/uploads/2021/04/pular-corda.gif",
        "Caminhada Leve":
          "https://png.pngtree.com/png-clipart/20220419/original/pngtree-man-doing-walking-exercise-png-image_7538567.png",
        "Agachamento Livre":
          "https://media1.tenor.com/m/pdMmsiutWkcAAAAC/gym.gif",
        "Agachamento Hack": "https://media.tenor.com/jiqHF0MkHeYAAAAM/gym.gif",
        "Leg Press 45¬∞":
          "https://media1.tenor.com/m/xJh_-w_SxckAAAAC/leg-press.gif",
        "Cadeira Extensora":
          "https://media1.tenor.com/m/bqKtsSuqilQAAAAC/gym.gif",
        "Cadeira Flexora":
          "https://i0.wp.com/omelhortreino.com.br/wp-content/uploads/2025/07/Cadeira-flexora.gif?resize=550%2C550&ssl=1",
        "Mesa Flexora": "https://media1.tenor.com/m/fj_cZPprAyMAAAAC/gym.gif",
        Stiff:
          "https://i.pinimg.com/originals/82/4d/fd/824dfd405284597cd20e8a55233e2d77.gif",
        "Levantamento Terra":
          "https://www.hipertrofia.org/blog/wp-content/uploads/2017/11/barbell-deadlift.gif",
        "Eleva√ß√£o P√©lvica":
          "https://i0.wp.com/meutreinador.com/wp-content/uploads/2024/04/elevacao-pelvica-no-banco.gif?fit=1080%2C1080&ssl=1",
        "Cadeira Abdutora":
          "https://www.hipertrofia.org/blog/wp-content/uploads/2024/09/lever-seated-hip-abduction.gif",
        "Cadeira Adutora":
          "https://i.pinimg.com/originals/4e/17/b8/4e17b88b6b11c54155939c0a5b3c3381.gif",
        "Agachamento B√∫lgaro":
          "https://www.hipertrofia.org/blog/wp-content/uploads/2024/06/agachamento-bulgaro.gif",
        "Subida no Banco (Step-up)":
          "https://www.mundoboaforma.com.br/wp-content/uploads/2021/09/stepup-alto-no-banco-com-halteres.gif",
        "Abdu√ß√£o de Quadril (Deitado)":
          "https://www.mundoboaforma.com.br/wp-content/uploads/2021/09/abducao-do-quadril-pernas-deitado-no-solo-com-elevacao-da-perna-reta.gif",
        "Mobilidade de Anca e Tornozelo":
          "https://nabexigamandoeu.pt/wp-content/uploads/2018/06/05_gif.gif",
        "Panturrilha em P√©":
          "https://www.hipertrofia.org/blog/wp-content/uploads/2023/03/lever-standing-calf-raise.gif",
        "Panturrilha Sentado":
          "https://www.hipertrofia.org/blog/wp-content/uploads/2018/10/lever-seated-calf-raise-.gif",
        "Panturrilha (Livre ou M√°quina)":
          "https://www.hipertrofia.org/blog/wp-content/uploads/2023/07/standing-calf-raise-on-a-staircase.gif",
        "Supino Reto":
          "https://www.hipertrofia.org/blog/wp-content/uploads/2018/09/barbell-decline-bench-press.gif",
        "Supino Inclinado":
          "https://www.hipertrofia.org/blog/wp-content/uploads/2023/05/dumbbell-incline-bench-press.gif",
        "Peck Deck (Crucifixo M√°quina)":
          "https://www.mundoboaforma.com.br/wp-content/uploads/2020/12/voador-no-aparelho.gif",
        Crucifixo:
          "https://www.hipertrofia.org/blog/wp-content/uploads/2023/09/dumbbell-fly.gif",
        "Crossover (Polia)":
          "https://i0.wp.com/meutreinador.com/wp-content/uploads/2024/04/Crossover-polia-alta.gif?fit=1080%2C1080&ssl=1",
        Mergulho:
          "https://i.pinimg.com/originals/4a/48/40/4a48407e46bab53a0c6050935f61f669.gif",
        "Puxada Aberta (Pulldown)":
          "https://www.mundoboaforma.com.br/wp-content/uploads/2020/12/costas-puxada-aberta-com-barra-no-pulley.gif",
        "Remada Sentada (Tri√¢ngulo)":
          "https://media.tenor.com/vy_b35185M0AAAAM/remada-baixa-triangulo.gif",
        "Barra Fixa":
          "https://www.mundoboaforma.com.br/wp-content/uploads/2020/12/costas-barra-fixa-pegada-aberta-palma-para-frente-chinup.gif",
        "Remada Curvada":
          "https://www.mundoboaforma.com.br/wp-content/uploads/2020/12/costas-remada-curvada-.gif",
        "Remada Unilateral (Serrote)":
          "https://www.mundoboaforma.com.br/wp-content/uploads/2020/12/costas-remada-unilateral-com-halter-serrote-no-banco.gif",
        "Dead Hang (Pendurar na barra)":
          "https://media.tenor.com/PfpznfyXlk8AAAAM/hang-strong.gif",
        Desenvolvimento:
          "https://www.mundoboaforma.com.br/wp-content/uploads/2020/12/desenvolvimento-para-ombros-com-halteres.gif",
        "Eleva√ß√£o Lateral":
          "https://media.tenor.com/cy46UbnfUrkAAAAM/eleva%C3%A7%C3%A3o-lateral-hateres.gif",
        "Eleva√ß√£o Frontal":
          "https://image.tuasaude.com/media/article/sz/nf/elevacao-frontal_75624.gif?width=686&height=487",
        "Face Pull":
          "https://fitnessprogramer.com/wp-content/uploads/2021/02/Face-Pull.gif",
        "Encolhimento (Trap√©zio)":
          "https://www.hipertrofia.org/blog/wp-content/uploads/2024/01/dumbbell-shrug.gif",
        "Rosca Scott":
          "https://www.mundoboaforma.com.br/wp-content/uploads/2020/11/Rosca-Scott-com-halteres-com-dois-bracos.gif",
        "Rosca Inversa":
          "https://i0.wp.com/omelhortreino.com.br/wp-content/uploads/2025/04/Rosca-Inversa.gif?resize=550%2C550&ssl=1",
        "Flex√£o de Punho":
          "https://treinomestre.com.br/wp-content/uploads/2024/09/flexao-de-punho-com-halteres.gif",
        "Rosca Martelo":
          "https://www.hipertrofia.org/blog/wp-content/uploads/2023/04/dumbbell-hammer-curl-v-2.gif",
        "Tr√≠ceps Corda":
          "https://media.tenor.com/mbebKudZjxYAAAAM/tr%C3%ADceps-pulley.gif",
        "Rosca Paj√© (Wrist Roller)":
          "https://burnfit.io/wp-content/uploads/2023/11/WRIST_ROLLER.gif",
        "Rosca Direta":
          "https://www.hipertrofia.org/blog/wp-content/uploads/2024/02/barbell-standing-close-grip-curl.gif",
        "Tr√≠ceps Testa":
          "https://www.hipertrofia.org/blog/wp-content/uploads/2024/02/barbell-lying-triceps-extension-skull-crusher.gif",
        "Tr√≠ceps Franc√™s":
          "https://www.hipertrofia.org/blog/wp-content/uploads/2025/01/triceps-frances-com-um-halter-sentado.gif",
        "Tr√≠ceps Coice":
          "https://karoldeliberato.com.br/wp-content/uploads/2023/05/image68.gif",
        "Abdominal Infra (Eleva√ß√£o pernas)":
          "https://grandeatleta.com.br/wp-content/uploads/2024/03/Abdominal-infra-solo.gif",
        "Prancha Abdominal":
          "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSERETl8HEs2s1GLn4FV5zdxsELa2-_oxBV7w&s",
        "Abdominal Supra (Crunch)":
          "https://www.mundoboaforma.com.br/wp-content/uploads/2023/02/47271301-abdominal-supra.gif",
        "Extens√£o Lombar (Banco Romano)":
          "https://media.tenor.com/Fsu8AmbXPl0AAAAM/back-extension.gif",
        "Stomach Vacuum":
          "https://www.wikihow.com/images/thumb/9/96/Do-the-Stomach-Vacuum-Exercise-Step-5-Version-2.jpg/v4-460px-Do-the-Stomach-Vacuum-Exercise-Step-5-Version-2.jpg",
        "Flex√£o de Bra√ßo (Push-up)":
          "https://i.pinimg.com/originals/b0/da/7f/b0da7f7f3556befcc7cbdd0ba33be39e.gif",
        Outro: "https://media.forgecdn.net/attachments/627/928/pushup.gif",
      };

      const exerciseDetails = {
        "Agachamento Livre": {
          steps: [
            "P√©s na largura dos ombros, pontas levemente para fora.",
            "Mantenha o peito estufado e o abd√¥men contra√≠do.",
            "Des√ßa jogando o quadril para tr√°s.",
            "Des√ßa at√© as coxas ficarem paralelas ao ch√£o.",
            "Suba empurrando o ch√£o com o calcanhar.",
          ],
          tips: "N√£o deixe os joelhos entrarem. Respire fundo antes de descer.",
          muscles: "Quadr√≠ceps, Gl√∫teo M√°ximo, Core.",
        },
        "Leg Press 45¬∞": {
          steps: [
            "Apoie as costas totalmente no banco.",
            "P√©s na largura do quadril.",
            "Destrave e des√ßa at√© os joelhos perto do peito.",
            "Empurre sem esticar totalmente os joelhos.",
          ],
          tips: "Nunca apoie as m√£os nos joelhos.",
          muscles: "Quadr√≠ceps.",
        },
      };
      const defaultDetails = {
        steps: [
          "Execute o movimento de forma controlada.",
          "Mantenha a postura correta.",
          "Foque na conex√£o mente-m√∫sculo.",
        ],
        tips: "Consulte um professor para ajustes.",
        muscles: "Musculatura alvo.",
      };
      const missedReasons = [
        "Feriado",
        "Academia fechada",
        "Doente",
        "Cansa√ßo excessivo",
        "Trabalho/Estudo",
        "Perdi o hor√°rio",
        "Outro",
      ];
      const exercisesList = {
        cardio: [
          "Escada",
          "Esteira",
          "Caminhada Leve",
          "Bicicleta Ergom√©trica",
          "El√≠ptico (Transport)",
          "Pular Corda",
          "Mobilidade de Anca e Tornozelo",
          "Outro",
        ],
        inferior: [
          "Agachamento Livre",
          "Agachamento Hack",
          "Leg Press 45¬∞",
          "Cadeira Extensora",
          "Agachamento B√∫lgaro",
          "Subida no Banco (Step-up)",
          "Afundo",
          "Eleva√ß√£o P√©lvica",
          "Stiff",
          "Mesa Flexora",
          "Cadeira Flexora",
          "Abdu√ß√£o de Quadril (Deitado)",
          "Cadeira Abdutora",
          "Gl√∫teo Polia (Coice)",
          "Cadeira Adutora",
          "Panturrilha em P√©",
          "Panturrilha Sentado",
          "Panturrilha (Livre ou M√°quina)",
          "Levantamento Terra",
          "Outro",
        ],
        superior: [
          "Supino Inclinado",
          "Supino Reto",
          "Peck Deck (Crucifixo M√°quina)",
          "Crucifixo",
          "Flex√£o de Bra√ßo (Push-up)",
          "Mergulho",
          "Crossover (Polia)",
          "Puxada Aberta (Pulldown)",
          "Remada Sentada (Tri√¢ngulo)",
          "Barra Fixa",
          "Remada Curvada",
          "Remada Unilateral (Serrote)",
          "Dead Hang (Pendurar na barra)",
          "Desenvolvimento",
          "Eleva√ß√£o Lateral",
          "Eleva√ß√£o Frontal",
          "Face Pull",
          "Encolhimento (Trap√©zio)",
          "Rosca Scott",
          "Rosca Martelo",
          "Rosca Direta",
          "Tr√≠ceps Corda",
          "Tr√≠ceps Testa",
          "Tr√≠ceps Franc√™s",
          "Tr√≠ceps Coice",
          "Rosca Inversa",
          "Flex√£o de Punho",
          "Rosca Paj√© (Wrist Roller)",
          "Abdominal Infra (Eleva√ß√£o pernas)",
          "Abdominal Supra (Crunch)",
          "Prancha Abdominal",
          "Extens√£o Lombar (Banco Romano)",
          "Stomach Vacuum",
          "Outro",
        ],
        mesclado: [],
      };
      exercisesList.mesclado = [
        ...exercisesList.inferior.slice(0, -1),
        ...exercisesList.superior,
      ];
      const ultimateList = [
        "Eleva√ß√£o P√©lvica",
        "Stiff",
        "Cadeira Flexora",
        "Leg Press 45¬∞",
        "Cadeira Abdutora",
        "Panturrilha em P√©",
        "Cadeira Extensora",
        "Supino Inclinado",
        "Peck Deck (Crucifixo M√°quina)",
        "Puxada Aberta (Pulldown)",
        "Remada Sentada (Tri√¢ngulo)",
        "Rosca Scott",
        "Rosca Inversa",
        "Flex√£o de Punho",
        "Escada",
        "Abdominal Infra (Eleva√ß√£o pernas)",
        "Prancha Abdominal",
        "Abdominal Supra (Crunch)",
        "Extens√£o Lombar (Banco Romano)",
        "Flex√£o de Bra√ßo (Push-up)",
        "Stomach Vacuum",
        "Agachamento Livre",
        "Agachamento Hack",
        "Agachamento B√∫lgaro",
        "Mesa Flexora",
        "Subida no Banco (Step-up)",
        "Panturrilha Sentado",
        "Cadeira Adutora",
        "Desenvolvimento",
        "Eleva√ß√£o Lateral",
        "Supino Reto",
        "Rosca Martelo",
        "Tr√≠ceps Corda",
        "Rosca Paj√© (Wrist Roller)",
        "Dead Hang (Pendurar na barra)",
        "Panturrilha (Livre ou M√°quina)",
        "Abdu√ß√£o de Quadril (Deitado)",
        "Mobilidade de Anca e Tornozelo",
        "Caminhada Leve",
      ];

      const formatDateKey = (year, month, day) =>
        `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(
          2,
          "0"
        )}`;
      const getDaysInMonth = (date) => ({
        daysInMonth: new Date(
          date.getFullYear(),
          date.getMonth() + 1,
          0
        ).getDate(),
        startingDayOfWeek: new Date(
          date.getFullYear(),
          date.getMonth(),
          1
        ).getDay(),
      });
      const getDayType = (exercises) => {
        if (!exercises || exercises.length === 0) return "";
        const types = [...new Set(exercises.map((ex) => ex.type))];
        if (types.length === 1)
          return types[0].charAt(0).toUpperCase() + types[0].slice(1);
        return "Mesclado";
      };

      const saveToStorage = () => {
        if (window.saveToCloud) window.saveToCloud();
        else {
          localStorage.setItem("gymTrackerData", JSON.stringify(state.gymData));
          localStorage.setItem("gymRoutines", JSON.stringify(state.routines));
          localStorage.setItem(
            "gymMeasurements",
            JSON.stringify(state.bodyMeasurements)
          );
          localStorage.setItem(
            "gymChecklist",
            JSON.stringify(state.dailyCheck)
          );
          localStorage.setItem("gymDiet", JSON.stringify(state.diet));
          localStorage.setItem("gymTheme", state.theme);
        }
      };

      // === APP PRINCIPAL ===
      window.app = {
        render: () => {
          document.body.className = `min-h-screen pb-24 select-none ${
            state.theme === "light" ? "light-mode" : ""
          }`;
          document.getElementById("theme-color-meta").content =
            state.theme === "light" ? "#f4f4f5" : "#09090b";

          const root = document.getElementById("root");
          root.innerHTML = "";

          const brandColor = "var(--primary)";
          const inactiveColor = "var(--text-dim)";

          const tabs = [
            "btn-calendar",
            "btn-routine",
            "btn-diet",
            "btn-stats",
            "btn-tools",
          ];
          const tabNames = ["calendar", "routine", "diet", "stats", "tools"];

          tabs.forEach((id, index) => {
            const el = document.getElementById(id);
            if (el)
              el.style.color =
                state.currentTab === tabNames[index]
                  ? brandColor
                  : inactiveColor;
          });

          if (state.currentTab === "calendar") renderCalendar(root);
          else if (state.currentTab === "diet") renderDietTab(root);
          else if (state.currentTab === "stats") renderStatsTab(root);
          else if (state.currentTab === "tools") renderToolsTab(root);
          else renderRoutineTab(root);

          if (state.showModal) renderCalendarModal(root);
          if (state.showDietModal) renderDietModal(root);
          if (state.showRoutineModal) renderRoutineModal(root);
          if (state.viewingImage) renderImageModal(root);
          if (state.showFeaturesModal) renderFeaturesModal(root);
          if (state.showExercisePicker) renderExercisePicker(root);

          lucide.createIcons();
        },

        toggleFeatureDetails: (id) => {
          const element = document.getElementById(`feature-details-${id}`);
          const icon = document.getElementById(`feature-icon-${id}`);

          // Essa verifica√ß√£o evita bugs se o elemento n√£o for encontrado
          if (element && icon) {
            if (element.classList.contains("hidden")) {
              // Abrir
              element.classList.remove("hidden");
              element.classList.add(
                "animate-in",
                "fade-in",
                "slide-in-from-top-1"
              );
              icon.style.transform = "rotate(180deg)";
            } else {
              // Fechar
              element.classList.add("hidden");
              element.classList.remove(
                "animate-in",
                "fade-in",
                "slide-in-from-top-1"
              );
              icon.style.transform = "rotate(0deg)";
            }
          }
        },

        renderFeaturesModal: (root) => {
          const modal = document.createElement("div");
          modal.className =
            "fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200";

          // AQUI EST√ÉO OS TEXTOS DETALHADOS QUE VOC√ä PEDIU:
          const features = [
            {
              id: "daily",
              icon: "calendar-check",
              title: "Di√°rio de Treino",
              desc: "Gerencie sua frequ√™ncia e hist√≥rico.",
              details:
                "O cora√ß√£o do app. Marque seus dias como 'Treino', 'Descanso' ou 'Falta'. Ao registrar um treino, voc√™ seleciona a ficha usada, anota as cargas, como se sentiu e pode at√© salvar uma foto do shape do dia para comparar sua evolu√ß√£o futura.",
            },
            {
              id: "routines",
              icon: "clipboard-list",
              title: "Montagem de Fichas",
              desc: "Crie treinos ABC, ABCD ou personalizados.",
              details:
                "Liberdade total para montar seu treino. Crie rotinas ilimitadas (ex: 'Treino de For√ßa', 'Adapta√ß√£o'). Adicione exerc√≠cios espec√≠ficos para cada dia da semana, reordene a lista e edite s√©ries e repeti√ß√µes a qualquer momento.",
            },
            {
              id: "gifs",
              icon: "play-circle",
              title: "Biblioteca Visual (GIFs)",
              desc: "Aprenda a execu√ß√£o correta.",
              details:
                "Nunca mais fique na d√∫vida na academia. Ao clicar em qualquer exerc√≠cio da sua ficha, voc√™ v√™ um GIF em alta qualidade da execu√ß√£o, lista de m√∫sculos trabalhados e 'Dicas de Mestre' para melhorar sua t√©cnica e evitar les√µes.",
            },
            {
              id: "diet",
              icon: "utensils",
              title: "Gest√£o de Dieta",
              desc: "Planeje suas refei√ß√µes e hor√°rios.",
              details:
                "Organize sua alimenta√ß√£o. Crie refei√ß√µes (Caf√©, Almo√ßo, Janta...), defina o hor√°rio e liste os alimentos e quantidades. Se ativar as notifica√ß√µes, o app te avisa 15 minutos antes de cada refei√ß√£o para voc√™ n√£o esquecer de comer.",
            },
            {
              id: "tools",
              icon: "wrench",
              title: "Ferramentas √öteis",
              desc: "Cron√¥metro, Medidas e Checklist.",
              details:
                "Um canivete su√≠√ßo para quem treina: Cron√¥metro para o descanso entre s√©ries, Tabela de Medidas para registrar o crescimento de bra√ßo/perna/peito e um Checklist di√°rio para marcar seus h√°bitos (√Ågua, Creatina, Sono, Prote√≠na).",
            },
            {
              id: "cloud",
              icon: "cloud",
              title: "Backup na Nuvem",
              desc: "Seus dados salvos no Google.",
              details:
                "Seguran√ßa total. Fa√ßa login com sua conta Google para sincronizar tudo na nuvem. Se voc√™ trocar de celular, formatar ou acessar pelo computador, suas fichas, hist√≥rico e dieta estar√£o l√°, s√£os e salvos.",
            },
            {
              id: "ui",
              icon: "moon",
              title: "Personaliza√ß√£o",
              desc: "Temas Claro e Escuro.",
              details:
                "Escolha o visual que mais te agrada. O modo Dark economiza bateria e foca no conte√∫do, enquanto o novo modo Light (Lavanda) oferece uma interface limpa e moderna com alto contraste.",
            },
          ];

          const featuresHtml = features
            .map(
              (f) => `
                <div onclick="app.toggleFeatureDetails('${
                  f.id
                }')" class="group bg-surface border border-bordercol rounded-2xl overflow-hidden cursor-pointer hover:border-brand transition-all active:scale-[0.98] mb-3">
                    <div class="flex items-center gap-4 p-4">
                        <div class="w-10 h-10 rounded-full bg-brand/10 flex items-center justify-center text-brand flex-shrink-0 group-hover:bg-brand group-hover:text-white transition-colors">
                            <i data-lucide="${f.icon}" class="w-5 h-5"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-txt-main font-bold text-sm mb-0.5">${escapeHtml(
                              f.title
                            )}</h4>
                            <p class="text-txt-dim text-xs">${escapeHtml(
                              f.desc
                            )}</p>
                        </div>
                        <i id="feature-icon-${
                          f.id
                        }" data-lucide="chevron-down" class="w-5 h-5 text-txt-dim transition-transform duration-300"></i>
                    </div>
                    
                    <div id="feature-details-${
                      f.id
                    }" class="hidden bg-inputbg border-t border-bordercol p-4">
                        <p class="text-txt-dim text-xs leading-relaxed">
                            ${escapeHtml(f.details)}
                        </p>
                    </div>
                </div>
            `
            )
            .join("");

          modal.innerHTML = `
                <div class="bg-app w-full max-w-md rounded-3xl border border-bordercol shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
                    <div class="p-6 border-b border-bordercol bg-surface z-10">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xl font-bold text-txt-main flex items-center gap-2">
                                <i data-lucide="sparkles" class="text-brand"></i> Novidades
                            </h3>
                            <button onclick="app.toggleFeatures()" class="p-2 rounded-full bg-app hover:bg-bordercol text-txt-dim hover:text-brand border border-bordercol transition-colors">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <p class="text-txt-dim text-sm">Toque nos itens para ver os detalhes.</p>
                    </div>

                    <div class="p-4 overflow-y-auto custom-scrollbar bg-app">
                        ${featuresHtml}
                    </div>

                    <div class="p-4 border-t border-bordercol bg-surface z-10">
                        <button onclick="app.toggleFeatures()" class="w-full bg-brand hover:bg-brand-hover text-white py-3.5 rounded-xl font-bold transition-all active:scale-95 shadow-lg shadow-brand/20">
                            Entendi, vamos treinar!
                        </button>
                    </div>
                </div>
            `;
          root.appendChild(modal);
          lucide.createIcons();
        },

        toggleTheme: () => {
          state.theme = state.theme === "dark" ? "light" : "dark";
          saveToStorage();
          app.render();
        },
        openDietModal: (mealIndex = null) => {
          if (mealIndex !== null) {
            state.editingMeal = JSON.parse(
              JSON.stringify(state.diet[mealIndex])
            );
            state.editingMeal.index = mealIndex;
          } else {
            state.editingMeal = {
              time: "08:00",
              name: "",
              foods: [{ name: "", qty: "", unit: "g" }],
            };
          }
          state.showDietModal = true;
          app.render();
        },
        closeDietModal: () => {
          state.showDietModal = false;
          state.editingMeal = null;
          app.render();
        },
        addFoodRow: () => {
          state.editingMeal.foods.push({ name: "", qty: "", unit: "g" });
          app.render();
        },
        removeFoodRow: (index) => {
          state.editingMeal.foods.splice(index, 1);
          app.render();
        },
        updateFoodRow: (index, field, value) => {
          state.editingMeal.foods[index][field] = value;
        },
        updateMealMeta: (field, value) => {
          state.editingMeal[field] = value;
        },
        saveMeal: () => {
          if (!state.editingMeal.name)
            return alert("D√™ um nome para a refei√ß√£o");
          state.editingMeal.foods = state.editingMeal.foods.filter(
            (f) => f.name.trim() !== ""
          );
          if (state.editingMeal.index !== undefined)
            state.diet[state.editingMeal.index] = state.editingMeal;
          else state.diet.push(state.editingMeal);
          state.diet.sort((a, b) => a.time.localeCompare(b.time));
          saveToStorage();
          app.closeDietModal();
        },
        deleteMeal: (index) => {
          if (confirm("Apagar esta refei√ß√£o?")) {
            state.diet.splice(index, 1);
            saveToStorage();
            app.render();
          }
        },
        startTimer: () => {
          if (state.timerRunning) return;
          state.timerRunning = true;
          app.render();
          state.timerInterval = setInterval(() => {
            if (state.timerTime > 0) {
              state.timerTime--;
              const timerDisplay = document.getElementById("timer-display");
              const progressCircle = document.getElementById("timer-progress");
              if (timerDisplay && progressCircle) {
                const mins = Math.floor(state.timerTime / 60)
                  .toString()
                  .padStart(2, "0");
                const secs = (state.timerTime % 60).toString().padStart(2, "0");
                timerDisplay.innerText = `${mins}:${secs}`;
                const percent = (state.timerTime / state.timerTotal) * 283;
                progressCircle.style.strokeDashoffset = 283 - percent;
              }
            } else {
              app.stopTimer();
              if ("vibrate" in navigator) navigator.vibrate([500, 200, 500]);
              app.sendNotification(
                "Tempo Esgotado! üîî",
                "Hora de voltar para a s√©rie!"
              );
              alert("Tempo esgotado!");
            }
          }, 1000);
        },
        stopTimer: () => {
          state.timerRunning = false;
          clearInterval(state.timerInterval);
          app.render();
        },
        resetTimer: (seconds) => {
          app.stopTimer();
          state.timerTotal = seconds;
          state.timerTime = seconds;
          app.render();
        },
        addSeconds: (sec) => {
          state.timerTime += sec;
          state.timerTotal = Math.max(state.timerTotal, state.timerTime);
          app.render();
        },
        moveExercise: (index, direction) => {
          const arr = state.exercises;
          const newIndex = index + direction;
          if (newIndex < 0 || newIndex >= arr.length) return;
          [arr[index], arr[newIndex]] = [arr[newIndex], arr[index]];
          app.render();
        },
        moveRoutineExercise: (index, direction) => {
          const arr = state.routineExercises;
          const newIndex = index + direction;
          if (newIndex < 0 || newIndex >= arr.length) return;
          [arr[index], arr[newIndex]] = [arr[newIndex], arr[index]];
          app.render();
        },
        openPicker: (index = null, context = "routine") => {
          state.editingIndex = index;
          state.pickerContext = context;
          state.pickerFilter = "inferior";
          state.pickerSearch = "";
          state.showExercisePicker = true;
          app.render();
        },
        closePicker: () => {
          state.showExercisePicker = false;
          app.render();
        },
        setPickerFilter: (filter) => {
          state.pickerFilter = filter;
          app.render();
        },
        setPickerSearch: (text) => {
          state.pickerSearch = text;
          updatePickerGridOnly();
        },
        selectExerciseFromPicker: (name, type) => {
          const targetList =
            state.pickerContext === "routine"
              ? state.routineExercises
              : state.exercises;
          if (state.editingIndex === null)
            targetList.push({
              type,
              name,
              customName: "",
              weight: "",
              reps: "",
              sets: "",
            });
          else {
            targetList[state.editingIndex].name = name;
            targetList[state.editingIndex].type = type;
            targetList[state.editingIndex].customName = "";
          }
          state.showExercisePicker = false;
          app.render();
        },
        toggleProfileMenu: () => {
          state.showProfileMenu = !state.showProfileMenu;
          app.render();
        },
        setTab: (tab) => {
          state.currentTab = tab;
          app.render();
        },
        toggleFeatures: () => {
          state.showFeaturesModal = !state.showFeaturesModal;

          // Se estiver fechando, marca que j√° viu para n√£o abrir sozinho de novo
          if (!state.showFeaturesModal) {
            localStorage.setItem("gymHasVisited", "true");
          }

          app.render();
        },
        toggleFeatureDetails: (id) => {
          const element = document.getElementById(`feature-details-${id}`);
          const icon = document.getElementById(`feature-icon-${id}`);

          if (element && icon) {
            if (element.classList.contains("hidden")) {
              // Abrir
              element.classList.remove("hidden");
              element.classList.add(
                "animate-in",
                "fade-in",
                "slide-in-from-top-1"
              );
              icon.style.transform = "rotate(180deg)";
            } else {
              // Fechar
              element.classList.add("hidden");
              element.classList.remove(
                "animate-in",
                "fade-in",
                "slide-in-from-top-1"
              );
              icon.style.transform = "rotate(0deg)";
            }
          }
        },
        openImage: (name, url) => {
          state.viewingImage = { name, url };
          app.render();
        },
        closeImage: () => {
          state.viewingImage = null;
          app.render();
        },
        prevMonth: () => {
          state.currentDate = new Date(
            state.currentDate.getFullYear(),
            state.currentDate.getMonth() - 1
          );
          app.render();
        },
        nextMonth: () => {
          state.currentDate = new Date(
            state.currentDate.getFullYear(),
            state.currentDate.getMonth() + 1
          );
          app.render();
        },
        dayClick: (day) => {
          const dateKey = formatDateKey(
            state.currentDate.getFullYear(),
            state.currentDate.getMonth(),
            day
          );
          const dateObj = new Date(
            state.currentDate.getFullYear(),
            state.currentDate.getMonth(),
            day
          );
          state.selectedDay = { day, dateKey, weekdayIndex: dateObj.getDay() };
          const data = state.gymData[dateKey];
          app.resetForm();
          if (data) {
            if (data.status) state.modalMode = data.status;
            else state.modalMode = data.attended ? "attended" : "missed";
            if (state.modalMode === "attended") {
              state.weight = data.weight || "";
              state.workoutType = data.workoutType || "";
              state.exercises = data.exercises || [
                { name: "", customName: "", weight: "", reps: "", sets: "" },
              ];
              state.notes = data.notes || "";
              state.photo = data.photo || null;
            } else if (state.modalMode === "missed") {
              state.missedReason = data.reason || "";
              state.customReason = data.customReason || "";
            }
          } else {
            state.modalMode = "select";
          }
          state.showModal = true;
          app.render();
        },
        resetForm: () => {
          state.weight = "";
          state.workoutType = "";
          state.exercises = [
            { name: "", customName: "", weight: "", reps: "", sets: "" },
          ];
          state.notes = "";
          state.photo = null;
          state.missedReason = "";
          state.customReason = "";
        },
        closeModal: () => {
          state.showModal = false;
          app.render();
        },
        setModalMode: (mode) => {
          state.modalMode = mode;
          app.render();
        },
        updateForm: (field, value) => {
          state[field] = value;
          if (field === "workoutType") app.render();
        },
        addExercise: () => {
          state.exercises.push({
            name: "",
            customName: "",
            weight: "",
            reps: "",
            sets: "",
          });
          app.render();
        },
        removeExercise: (index) => {
          state.exercises.splice(index, 1);
          app.render();
        },
        updateExercise: (index, field, value) => {
          state.exercises[index][field] = value;
        },
        loadRoutineIntoSession: (routineId) => {
          if (!routineId) return;
          const routine = state.routines.find((r) => r.id == routineId);
          if (!routine) return;
          const weekday = state.selectedDay.weekdayIndex;
          const exercisesForDay = routine.days[weekday];
          if (exercisesForDay && exercisesForDay.length > 0) {
            state.exercises = exercisesForDay.map((ex) => ({
              name: ex.name,
              customName: ex.customName,
              weight: ex.weight,
              reps: ex.reps,
              sets: ex.sets,
            }));
            const types = [...new Set(exercisesForDay.map((e) => e.type))];
            state.workoutType = types.length === 1 ? types[0] : "mesclado";
            alert(`Treino de ${weekdays[weekday]} carregado!`);
          } else {
            alert(`Sem treinos para ${weekdays[weekday]} nesta rotina.`);
          }
          app.render();
        },
        saveData: (status) => {
          const entry = {
            status,
            attended: status === "attended",
            notes: state.notes,
          };
          if (status === "attended") {
            entry.weight = state.weight;
            entry.workoutType = state.workoutType;
            entry.exercises = state.exercises
              .filter((ex) => ex.name)
              .map((ex) => ({
                ...ex,
                name: ex.name === "Outro" ? ex.customName : ex.name,
              }));
            entry.photo = state.photo;
          } else if (status === "missed") {
            entry.reason = state.missedReason;
            entry.customReason =
              state.missedReason === "Outro" ? state.customReason : "";
          }
          state.gymData[state.selectedDay.dateKey] = entry;
          saveToStorage();
          state.showModal = false;
          app.resetForm();
          app.render();
        },
        deleteEntry: () => {
          if (confirm("Apagar registro?")) {
            delete state.gymData[state.selectedDay.dateKey];
            saveToStorage();
            state.showModal = false;
            app.resetForm();
            app.render();
          }
        },
        exportJSON: () => {
          const data = {
            exportDate: new Date().toISOString(),
            data: state.gymData,
            routines: state.routines,
          };
          const url = URL.createObjectURL(
            new Blob([JSON.stringify(data, null, 2)], {
              type: "application/json",
            })
          );
          const link = document.createElement("a");
          link.href = url;
          link.download = `backup-gym-${
            new Date().toISOString().split("T")[0]
          }.json`;
          link.click();
          URL.revokeObjectURL(url);
        },
        importJSON: (input) => {
          const file = input.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const imported = JSON.parse(e.target.result);
              if (imported.type === "single_routine") {
                state.routines.push(imported.data);
                alert(`Rotina importada!`);
              } else {
                if (imported.data) state.gymData = imported.data;
                if (imported.routines) state.routines = imported.routines;
                alert("Backup restaurado!");
              }
              saveToStorage();
              app.render();
            } catch {
              alert("Erro ao ler arquivo.");
            }
          };
          reader.readAsText(file);
          input.value = "";
        },
        createRoutine: () => {
          state.routineModalMode = "create";
          state.routineName = "";
          state.currentRoutine = {
            id: Date.now(),
            name: "",
            days: { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [] },
          };
          state.showRoutineModal = true;
          state.selectedWeekday = null;
          app.render();
        },
        editRoutine: (id, e) => {
          if (e) e.stopPropagation();
          const r = state.routines.find((r) => r.id === id);
          if (!r) return;
          state.currentRoutine = JSON.parse(JSON.stringify(r));
          state.routineName = r.name;
          state.routineModalMode = "edit";
          state.showRoutineModal = true;
          state.selectedWeekday = null;
          app.render();
        },
        editDayDirectly: (id, dayIndex) => {
          const r = state.routines.find((r) => r.id === id);
          if (!r) return;
          state.currentRoutine = JSON.parse(JSON.stringify(r));
          state.routineName = r.name;
          state.routineModalMode = "edit";
          state.selectedWeekday = dayIndex;
          const days = state.currentRoutine.days[dayIndex];
          state.routineExercises =
            days.length > 0 ? JSON.parse(JSON.stringify(days)) : [];
          state.showRoutineModal = true;
          app.render();
        },
        deleteRoutine: (id, e) => {
          if (e) e.stopPropagation();
          if (confirm("Excluir rotina?")) {
            state.routines = state.routines.filter((r) => r.id !== id);
            saveToStorage();
            if (state.viewingRoutineId === id) state.viewingRoutineId = null;
            app.render();
          }
        },
        saveRoutine: () => {
          if (!state.routineName.trim()) return alert("Nome obrigat√≥rio");
          state.currentRoutine.name = state.routineName;
          const idx = state.routines.findIndex(
            (r) => r.id === state.currentRoutine.id
          );
          if (idx >= 0) state.routines[idx] = state.currentRoutine;
          else state.routines.push(state.currentRoutine);
          saveToStorage();
          state.showRoutineModal = false;
          app.render();
        },
        openDayEditor: (dayIndex) => {
          state.selectedWeekday = dayIndex;
          const days = state.currentRoutine.days[dayIndex];
          state.routineExercises =
            days.length > 0 ? JSON.parse(JSON.stringify(days)) : [];
          app.render();
        },
        addRoutineExercise: () => {
          state.routineExercises.push({
            type: "",
            name: "",
            customName: "",
            weight: "",
            reps: "",
            sets: "",
          });
          app.render();
        },
        removeRoutineExercise: (i) => {
          state.routineExercises.splice(i, 1);
          app.render();
        },
        updateRoutineExercise: (i, field, val) => {
          state.routineExercises[i][field] = val;
          if (field === "type") app.render();
        },
        saveDayExercises: () => {
          state.currentRoutine.days[state.selectedWeekday] =
            state.routineExercises.filter((ex) => ex.type && ex.name);
          if (state.routineModalMode === "edit") {
            const idx = state.routines.findIndex(
              (r) => r.id === state.currentRoutine.id
            );
            if (idx >= 0) {
              state.routines[idx] = state.currentRoutine;
              saveToStorage();
            }
          }
          state.selectedWeekday = null;
          app.render();
        },
        openRoutineView: (id) => {
          state.viewingRoutineId = id;
          state.viewingDay = null;
          app.render();
        },
        closeRoutineView: () => {
          state.viewingRoutineId = null;
          app.render();
        },
        openDayView: (idx) => {
          state.viewingDay = idx;
          app.render();
        },
        closeDayView: () => {
          state.viewingDay = null;
          app.render();
        },
        exportSingleRoutine: (id, e) => {
          if (e) e.stopPropagation();
          const routine = state.routines.find((r) => r.id === id);
          const url = URL.createObjectURL(
            new Blob(
              [
                JSON.stringify(
                  { type: "single_routine", data: routine },
                  null,
                  2
                ),
              ],
              { type: "application/json" }
            )
          );
          const link = document.createElement("a");
          link.href = url;
          link.download = `rotina.json`;
          link.click();
          URL.revokeObjectURL(url);
        },

        requestNotificationPermission: () => {
          if (!("Notification" in window)) return alert("Sem suporte.");
          Notification.requestPermission().then((permission) => {
            if (permission === "granted")
              new Notification("GymDaily", {
                body: "Notifica√ß√µes ativadas!",
                icon: "https://cdn-icons-png.flaticon.com/512/2964/2964514.png",
              });
            else alert("Bloqueado.");
          });
        },
        sendNotification: (title, body) => {
          if (Notification.permission === "granted") {
            if (navigator.serviceWorker && navigator.serviceWorker.controller) {
              navigator.serviceWorker.ready.then((reg) =>
                reg.showNotification(title, {
                  body,
                  icon: "https://cdn-icons-png.flaticon.com/512/2964/2964514.png",
                  vibrate: [200, 100, 200],
                })
              );
            } else {
              const notif = new Notification(title, {
                body,
                icon: "https://cdn-icons-png.flaticon.com/512/2964/2964514.png",
              });
              notif.onclick = () => window.focus();
            }
          }
        },
      };

      function renderCalendar(root) {
        const { daysInMonth, startingDayOfWeek } = getDaysInMonth(
          state.currentDate
        );
        let gridHtml = "";
        for (let i = 0; i < startingDayOfWeek; i++)
          gridHtml += '<div class="aspect-square"></div>';

        for (let i = 1; i <= daysInMonth; i++) {
          const dateKey = formatDateKey(
            state.currentDate.getFullYear(),
            state.currentDate.getMonth(),
            i
          );
          const entry = state.gymData[dateKey];

          let classes =
            "aspect-square rounded-xl flex flex-col items-center justify-center font-bold text-sm transition-all active:scale-95 border ";
          let style = "";

          if (entry) {
            if (entry.status === "rest") {
              classes +=
                "bg-status-info text-white border-transparent shadow-sm";
            } else if (entry.status === "missed" || entry.attended === false) {
              classes +=
                "bg-status-danger text-white border-transparent shadow-sm";
            } else if (entry.status === "attended" || entry.attended) {
              classes +=
                "bg-status-success text-white border-transparent shadow-sm";
            }
          } else {
            // Dias vazios: Fundo da tela (bg-app) para contraste com o card branco
            classes +=
              "bg-app text-txt-main border-bordercol hover:border-brand";
          }
          gridHtml += `<button onclick="app.dayClick(${i})" class="${classes}" style="${style}">${i}</button>`;
        }

        // √çcones
        const themeIcon =
          state.theme === "dark"
            ? `<i data-lucide="sun" class="w-4 h-4"></i>`
            : `<i data-lucide="moon" class="w-4 h-4"></i>`;

        // Bot√£o de Tema (Agora bg-surface para ficar "saltado")
        const themeBtn = `<button onclick="app.toggleTheme()" class="w-9 h-9 flex items-center justify-center rounded-full bg-surface border border-bordercol text-txt-dim hover:text-brand hover:border-brand transition-colors active:scale-95 shadow-sm">${themeIcon}</button>`;

        // Bot√£o de Info (Tamb√©m bg-surface)
        const infoBtn = `<button onclick="app.toggleFeatures()" class="w-9 h-9 flex items-center justify-center rounded-full bg-surface text-brand border border-bordercol hover:border-brand transition-colors active:scale-95 shadow-sm"><i data-lucide="info" class="w-5 h-5"></i></button>`;

        const googleIcon = `<svg class="w-4 h-4" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>`;

        let headerRightHtml = "";

        if (!state.isLogged) {
          // Deslogado: [Entrar] [Tema] [Info]
          headerRightHtml = `
            <div class="flex items-center gap-2">
                <button onclick="window.loginGoogle()" class="flex items-center gap-2 px-4 py-2 rounded-full bg-surface border border-bordercol text-txt-main text-xs font-bold active:scale-95 transition-transform h-9 hover:border-brand shadow-sm">
                    ${googleIcon}
                    <span>Entrar</span>
                </button>
                ${themeBtn}
                ${infoBtn}
            </div>`;
        } else {
          // Logado: [Perfil] [Tema] [Info]
          headerRightHtml = `
            <div class="flex items-center gap-2">
                <div class="relative z-50">
                    <button onclick="app.toggleProfileMenu()" class="relative flex items-center active:scale-95 transition-transform">
                        <img src="${
                          state.userPhoto ||
                          "https://ui-avatars.com/api/?name=User"
                        }" class="w-9 h-9 rounded-full border-2 border-brand cursor-pointer hover:opacity-80 transition-opacity block shadow-sm">
                        <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-status-success border-2 border-surface rounded-full"></div>
                    </button>
                    ${
                      state.showProfileMenu
                        ? `
                        <div class="absolute right-0 top-12 w-64 bg-surface border border-bordercol rounded-2xl p-4 flex flex-col items-center gap-3 animate-in fade-in slide-in-from-top-2 duration-200 shadow-xl z-50">
                            <img src="${
                              state.userPhoto
                            }" class="w-16 h-16 rounded-full border-2 border-bordercol">
                            <div class="text-center mb-2">
                                <p class="text-txt-main font-bold text-sm">${escapeHtml(
                                  state.userName
                                )}</p>
                                <p class="text-txt-dim text-xs">Conta Google Conectada</p>
                            </div>
                            <button onclick="window.logoutGoogle()" class="w-full py-2 bg-status-danger-faint hover:bg-status-danger/20 text-status-danger text-xs font-bold rounded-lg border border-status-danger/20 transition-colors flex items-center justify-center gap-2">
                                <i data-lucide="log-out" class="w-3 h-3"></i> Sair da Conta
                            </button>
                        </div>
                        <div class="fixed inset-0 z-40" onclick="app.toggleProfileMenu()"></div>
                    `
                        : ""
                    }
                </div>
                ${themeBtn}
                ${infoBtn}
            </div>`;
        }

        root.innerHTML = `
          <div class="mb-6 pt-2 flex items-center justify-between relative">
            <div>
                <h1 class="text-2xl font-bold text-brand flex items-center gap-2">
                    <i data-lucide="dumbbell" class="text-brand"></i> GymDaily
                </h1>
            </div>
            ${headerRightHtml}
          </div>

          <div class="bg-surface rounded-3xl p-4 mb-3 border border-bordercol shadow-sm">
            <div class="flex items-center justify-between mb-4">
              <button onclick="app.prevMonth()" class="p-2 rounded-full bg-app hover:bg-bordercol text-txt-dim hover:text-brand border border-bordercol transition-colors"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
              <h2 class="text-lg font-bold text-txt-main capitalize">${
                monthNames[state.currentDate.getMonth()]
              } <span class="text-brand">${state.currentDate.getFullYear()}</span></h2>
              <button onclick="app.nextMonth()" class="p-2 rounded-full bg-app hover:bg-bordercol text-txt-dim hover:text-brand border border-bordercol transition-colors"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
            </div>
            
            <div class="grid grid-cols-7 gap-2 mb-2">
                ${dayNames
                  .map(
                    (d) =>
                      `<div class="text-center text-txt-dim font-bold text-xs uppercase tracking-wider">${d}</div>`
                  )
                  .join("")}
            </div>
            
            <div class="grid grid-cols-7 gap-2">
                ${gridHtml}
            </div>
            
            <div class="flex justify-center gap-4 mt-4 text-xs font-medium text-txt-dim">
              <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 bg-status-success rounded-full"></div>Treino</div>
              <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 bg-status-danger rounded-full"></div>Falta</div>
              <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 bg-status-info rounded-full"></div>Descanso</div>
            </div>
          </div>

          <div class="flex gap-3 mb-6">
            <button onclick="app.exportJSON()" class="flex-1 bg-surface hover:bg-app text-txt-main py-3 rounded-xl font-semibold flex items-center justify-center gap-2 border border-bordercol transition-all shadow-sm active:scale-95">
                <i data-lucide="download" class="w-4 h-4"></i> Exportar
            </button>
            <label class="flex-1 bg-surface hover:bg-app text-txt-main py-3 rounded-xl font-semibold flex items-center justify-center gap-2 cursor-pointer border border-bordercol transition-all shadow-sm active:scale-95">
                <i data-lucide="upload" class="w-4 h-4"></i> Importar
                <input type="file" accept=".json" class="hidden" onchange="app.importJSON(this)">
            </label>
          </div>
        `;
      }

      function renderRoutineTab(root) {
        const activeRoutine = state.viewingRoutineId
          ? state.routines.find((r) => r.id === state.viewingRoutineId)
          : null;

        if (!activeRoutine) {
          const listHtml = state.routines
            .map((r) => {
              const exerciseCount = r.days
                ? Object.values(r.days).reduce((acc, d) => acc + d.length, 0)
                : 0;
              return `<div class="group w-full rounded-2xl p-4 mb-3 bg-surface border border-bordercol hover:border-brand transition-all relative overflow-hidden">
              <div class="absolute top-0 left-0 w-1 h-full bg-brand"></div>
              <div class="flex justify-between items-center">
                <div onclick="app.openRoutineView(${
                  r.id
                })" class="flex-1 cursor-pointer"><h3 class="text-lg font-bold text-txt-main">${escapeHtml(
                r.name
              )}</h3><p class="text-txt-dim text-xs mt-0.5">${exerciseCount} exerc√≠cios</p></div>
                <div class="flex gap-1 ml-2">
                  <button onclick="app.exportSingleRoutine(${
                    r.id
                  }, event)" class="p-2 text-txt-muted hover:text-brand-hover rounded-lg hover:bg-bordercol"><i data-lucide="download" class="w-4 h-4"></i></button>
                  <button onclick="app.editRoutine(${
                    r.id
                  }, event)" class="p-2 text-brand hover:text-brand-hover rounded-lg hover:bg-brand-faint"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                  <button onclick="app.deleteRoutine(${
                    r.id
                  }, event)" class="p-2 text-status-danger hover:text-status-danger rounded-lg hover:bg-status-danger-faint"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
              </div>
            </div>`;
            })
            .join("");

          root.innerHTML = `<div class="mb-6 pt-2"><h1 class="text-2xl font-bold text-txt-main mb-1">Minhas fichas</h1><p class="text-txt-dim text-sm">Gerencie seus treinos</p></div>
            <div class="flex gap-3 mb-3">
              <button onclick="app.createRoutine()" class="flex-1 bg-brand hover:bg-brand-hover text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all"><i data-lucide="plus" class="w-5 h-5"></i> Criar ficha</button>
              <label class="px-4 bg-bordercol hover:bg-brand text-white rounded-xl flex items-center justify-center cursor-pointer border border-bordercol transition-all"><i data-lucide="upload" class="w-5 h-5"></i><input type="file" accept=".json" class="hidden" onchange="app.importJSON(this)"></label>
            </div>
            <div class="pb-20">${listHtml} ${
            state.routines.length === 0
              ? `<div class="text-center py-12 border-2 border-dashed border-bordercol rounded-2xl"><i data-lucide="clipboard-list" class="w-12 h-12 text-txt-dim mx-auto mb-3"></i><p class="text-txt-dim">Nenhuma rotina criada</p></div>`
              : ""
          }</div>`;
        } else if (state.viewingDay === null) {
          const daysList = weekdays
            .map((day, idx) => {
              const isActive = activeRoutine.days[idx].length > 0;
              // CORRIGIDO: Sem opacidades quebradas
              const cardClass = isActive
                ? "bg-surface border-brand hover:border-brand"
                : "bg-surface border-bordercol hover:opacity-100 opacity-60";
              return `<button onclick="app.openDayView(${idx})" class="${cardClass} relative flex flex-col justify-between p-4 rounded-2xl border transition-all active:scale-95 text-left group min-h-[110px]">
              <div class="flex justify-between items-start w-full mb-2"><span class="text-3xl font-black tracking-tighter ${
                isActive ? "text-txt-main" : "text-zinc-500"
              }">${day.substring(0, 3).toUpperCase()}</span>${
                isActive
                  ? `<div class="bg-brand-faint text-brand p-2 rounded-xl"><i data-lucide="dumbbell" class="w-4 h-4"></i></div>`
                  : `<div class="p-2"><i data-lucide="coffee" class="w-4 h-4 text-zinc-500"></i></div>`
              }</div>
              <div><p class="text-[10px] font-bold uppercase tracking-widest ${
                isActive ? "text-brand" : "text-zinc-600"
              }">${getDayType(activeRoutine.days[idx]) || "Descanso"}</p>${
                isActive
                  ? `<p class="text-xs text-txt-muted mt-0.5">${activeRoutine.days[idx].length} exerc√≠cios</p>`
                  : ""
              }</div>
            </button>`;
            })
            .join("");
          root.innerHTML = `<div class="flex items-center gap-3 mb-6 pt-2"><button onclick="app.closeRoutineView()" class="p-2 rounded-full bg-brand hover:bg-brand-hover border border-bordercol"><i data-lucide="arrow-left" class="text-white w-5 h-5"></i></button><div class="flex-1 overflow-hidden"><h1 class="text-xl font-bold text-txt-main truncate leading-tight">${escapeHtml(
            activeRoutine.name
          )}</h1><p class="text-xs text-txt-dim">Vis√£o Semanal</p></div><button onclick="app.editRoutine(${
            activeRoutine.id
          })" class="flex items-center gap-2 text-zinc-100 text-xs font-bold px-4 py-2 bg-brand rounded-full hover:bg-brand-hover transition-colors"><i data-lucide="pencil" class="w-3 h-3"></i> Editar</button></div><div class="grid grid-cols-2 gap-3 pb-24">${daysList}</div>`;
        } else {
          const exercises = activeRoutine.days[state.viewingDay];
          const exList =
            exercises.length === 0
              ? `<div class="text-center py-20 text-txt-dim"><i data-lucide="coffee" class="w-12 h-12 mx-auto mb-3 opacity-20"></i><p>Nenhum exerc√≠cio neste dia</p><button onclick="app.editDayDirectly(${activeRoutine.id}, ${state.viewingDay})" class="text-brand mt-4 text-sm hover:underline">Adicionar Exerc√≠cios</button></div>`
              : exercises
                  .map((ex, i) => {
                    const gifUrl =
                      exerciseGifs[ex.name] ||
                      exerciseGifs[ex.name.replace(" 45¬∞", "")] ||
                      exerciseGifs[ex.customName] ||
                      exerciseGifs["Outro"];
                    const mediaHtml = `<img src="${escapeHtml(
                      gifUrl
                    )}" onerror="this.src='https://placehold.co/200x200/27272a/a855f7?text=Erro+no+GIF'" onclick="app.openImage('${escapeHtml(
                      ex.name
                    )}', '${escapeHtml(
                      gifUrl
                    )}')" class="w-16 h-16 rounded-xl object-cover border border-bordercol flex-shrink-0 bg-inputbg cursor-zoom-in hover:opacity-80 transition-opacity">`;
                    return `<div class="flex gap-4 p-3 rounded-2xl mb-3 bg-surface border border-bordercol items-center">${mediaHtml}<div class="flex-1"><h3 class="text-brand font-bold text-base leading-tight mb-2.5">${escapeHtml(
                      ex.name === "Outro" ? ex.customName : ex.name
                    )}</h3><div class="flex flex-wrap gap-2 text-xs"><span class="bg-status-info-faint px-2.5 py-1 rounded-md text-status-info font-bold border border-status-info/30">${escapeHtml(
                      ex.sets
                    )} S√©ries</span><span class="bg-status-success-faint px-2.5 py-1 rounded-md text-status-success font-bold border border-status-success/30">${escapeHtml(
                      ex.reps
                    )} Repeti√ß√µes</span>${
                      ex.weight
                        ? `<span class="bg-yellow-900/20 px-2.5 py-1 rounded-md text-yellow-500 font-mono font-bold border border-yellow-500/30">${escapeHtml(
                            ex.weight
                          )}kg</span>`
                        : ""
                    }</div></div></div>`;
                  })
                  .join("");

          root.innerHTML = `<div class="flex items-center gap-3 mb-4 pt-2"><button onclick="app.closeDayView()" class="p-2 rounded-full bg-brand hover:bg-brand-hover border border-bordercol"><i data-lucide="arrow-left" class="text-white w-5 h-5"></i></button><div class="flex-1"><h1 class="text-xl font-bold text-txt-main">${
            weekdays[state.viewingDay]
          }</h1><p class="text-xs text-brand font-semibold uppercase tracking-wider">${getDayType(
            exercises
          )}</p></div><button onclick="app.editDayDirectly(${
            activeRoutine.id
          }, ${
            state.viewingDay
          })" class="flex items-center gap-2 text-brand text-xs font-bold px-4 py-2 bg-brand-faint border border-brand/30 rounded-full hover:bg-brand/50 transition-colors"><i data-lucide="pencil" class="w-3 h-3"></i> Editar</button></div><div class="pb-20">${exList}</div>`;
        }
      }

      function renderCalendarModal(root) {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 flex items-center justify-center p-4 z-50";
        modal.style.backgroundColor = "rgba(0, 0, 0, 0.8)";
        modal.style.backdropFilter = "blur(4px)";
        let content = "";

        if (state.modalMode === "select") {
          content = `<h3 class="text-lg font-bold text-white text-center mb-6">Como foi hoje?</h3><div class="flex flex-col gap-3"><button onclick="app.setModalMode('attended')" class="bg-status-success hover:bg-green-700 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-3 transition-transform active:scale-95"><i data-lucide="check-circle-2" class="w-6 h-6"></i> Treinei!</button><button onclick="app.setModalMode('rest')" class="bg-status-info hover:bg-blue-700 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-3 transition-transform active:scale-95"><i data-lucide="coffee" class="w-6 h-6"></i> Descansei</button><button onclick="app.setModalMode('missed')" class="bg-status-danger hover:bg-red-700 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-3 transition-transform active:scale-95"><i data-lucide="x-circle" class="w-6 h-6"></i> Faltei</button></div>`;
        } else if (state.modalMode === "attended") {
          const exHtml = state.exercises
            .map((ex, i) => {
              const gifUrl = exerciseGifs[ex.name] || exerciseGifs["Outro"];
              return `<div class="p-3 rounded-2xl bg-surface border border-bordercol mb-3 relative group">
              <div class="flex items-start gap-3 mb-3">
                <div onclick="app.openPicker(${i}, 'log')" class="w-14 h-14 shrink-0 rounded-xl bg-inputbg border border-bordercol overflow-hidden relative cursor-pointer hover:border-brand transition-colors"><img src="${gifUrl}" class="w-full h-full object-cover opacity-80" onerror="this.src='https://placehold.co/100x100/27272a/FFF?text=IMG'"><div class="absolute inset-0 flex items-center justify-center bg-black/30"><i data-lucide="refresh-cw" class="w-4 h-4 text-white opacity-70"></i></div></div>
                <div class="flex-1 min-w-0"><div class="flex justify-between items-start"><div onclick="app.openPicker(${i}, 'log')" class="cursor-pointer"><span class="text-[10px] font-bold text-status-success uppercase tracking-wider block mb-0.5">Feito ${
                i + 1
              }</span><h4 class="text-txt-main font-bold text-sm truncate leading-tight">${escapeHtml(
                ex.name || "Selecionar..."
              )}</h4></div><div class="flex items-center gap-1 -mr-2"><button onclick="app.moveExercise(${i}, -1)" class="p-1 rounded text-txt-dim hover:text-white hover:bg-bordercol"><i data-lucide="arrow-up" class="w-4 h-4"></i></button><button onclick="app.moveExercise(${i}, 1)" class="p-1 rounded text-txt-dim hover:text-white hover:bg-bordercol"><i data-lucide="arrow-down" class="w-4 h-4"></i></button><div class="w-px h-3 bg-bordercol mx-1"></div><button onclick="app.removeExercise(${i})" class="text-status-danger/40 hover:text-status-danger p-1 rounded hover:bg-status-danger-faint"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div></div>
              </div>
              <div class="grid grid-cols-3 gap-2">
                <div class="relative"><input type="number" value="${escapeHtml(
                  ex.sets
                )}" oninput="app.updateExercise(${i}, 'sets', this.value)" class="w-full p-2.5 rounded-lg bg-inputbg border border-bordercol text-txt-main text-center focus:border-status-info outline-none font-bold text-sm" placeholder="0"><span class="absolute top-[-6px] left-1/2 -translate-x-1/2 text-[8px] font-bold text-status-info bg-surface px-1 uppercase">S√©ries</span></div>
                <div class="relative"><input type="number" value="${escapeHtml(
                  ex.reps
                )}" oninput="app.updateExercise(${i}, 'reps', this.value)" class="w-full p-2.5 rounded-lg bg-inputbg border border-bordercol text-txt-main text-center focus:border-status-success outline-none font-bold text-sm" placeholder="0"><span class="absolute top-[-6px] left-1/2 -translate-x-1/2 text-[8px] font-bold text-status-success bg-surface px-1 uppercase">Reps</span></div>
                <div class="relative"><input type="number" value="${escapeHtml(
                  ex.weight
                )}" oninput="app.updateExercise(${i}, 'weight', this.value)" class="w-full p-2.5 rounded-lg bg-inputbg border border-bordercol text-txt-main text-center focus:border-yellow-500 outline-none font-bold text-sm" placeholder="-"><span class="absolute top-[-6px] left-1/2 -translate-x-1/2 text-[8px] font-bold text-yellow-600 bg-surface px-1 uppercase">Carga</span></div>
              </div>
            </div>`;
            })
            .join("");

          content = `<div class="space-y-5">
            ${
              state.routines.length > 0
                ? `<div class="bg-surface p-3 rounded-xl border border-bordercol"><label class="block text-xs font-bold text-txt-dim mb-2 uppercase">Preencher com Ficha</label><select onchange="app.loadRoutineIntoSession(this.value)" class="w-full p-2.5 rounded-lg bg-inputbg border border-bordercol text-txt-main text-sm outline-none focus:border-brand"><option value="">Selecione...</option>${state.routines
                    .map(
                      (r) =>
                        `<option value="${r.id}">${escapeHtml(r.name)}</option>`
                    )
                    .join("")}</select></div>`
                : ""
            }
            <div class="grid grid-cols-2 gap-4">
              <div><label class="block text-xs font-bold text-txt-dim mb-1.5 uppercase">Tipo</label><select onchange="app.updateForm('workoutType', this.value)" class="w-full p-3 rounded-xl bg-surface border border-bordercol text-txt-main focus:border-brand outline-none"><option value="">Selecione...</option><option value="cardio" ${
                state.workoutType === "cardio" ? "selected" : ""
              }>Cardio</option><option value="inferior" ${
            state.workoutType === "inferior" ? "selected" : ""
          }>Inferior</option><option value="superior" ${
            state.workoutType === "superior" ? "selected" : ""
          }>Superior</option><option value="mesclado" ${
            state.workoutType === "mesclado" ? "selected" : ""
          }>Mesclado</option></select></div>
              <div><label class="block text-xs font-bold text-txt-dim mb-1.5 uppercase">Peso (kg)</label><input type="number" step="0.1" value="${escapeHtml(
                state.weight
              )}" oninput="app.updateForm('weight', this.value)" class="w-full p-3 rounded-xl bg-surface border border-bordercol text-txt-main focus:border-brand outline-none" placeholder="Peso atual"></div>
            </div>
            ${
              state.workoutType
                ? `<div class="flex justify-between items-center pt-2"><label class="text-sm font-bold text-txt-main">Exerc√≠cios Realizados</label><button onclick="app.openPicker(null, 'log')" class="flex items-center gap-2 bg-brand hover:bg-brand-hover text-white px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wider transition-all active:scale-95"><i data-lucide="plus" class="w-3 h-3"></i> Adicionar</button></div><div class="max-h-[40vh] overflow-y-auto pr-1 custom-scrollbar">${exHtml}${
                    state.exercises.length === 0
                      ? `<div class="text-center py-8 text-txt-dim text-xs italic">Nenhum exerc√≠cio adicionado.</div>`
                      : ""
                  }</div>`
                : ""
            }
            <div><label class="block text-xs font-bold text-txt-dim mb-1.5 uppercase">Observa√ß√µes</label><textarea oninput="app.updateForm('notes', this.value)" class="w-full p-3 rounded-xl bg-surface border border-bordercol text-txt-main focus:border-brand outline-none" rows="2" placeholder="Como foi o treino?">${escapeHtml(
              state.notes
            )}</textarea></div>
            <button onclick="app.saveData('attended')" class="w-full bg-status-success hover:bg-green-700 text-white py-4 rounded-xl font-bold transition-transform active:scale-95">Concluir Treino</button>
            ${
              state.gymData[state.selectedDay.dateKey]
                ? `<button onclick="app.deleteEntry()" class="w-full text-status-danger font-semibold py-2 text-sm">Excluir Registro</button>`
                : ""
            }
          </div>`;
        } else if (state.modalMode === "rest") {
          content = `<div class="text-center py-6"><div class="w-20 h-20 bg-status-info-faint rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="coffee" class="w-10 h-10 text-status-info"></i></div><h3 class="text-xl font-bold text-white mb-2">Dia de Descanso</h3><p class="text-txt-dim text-sm mb-6">O descanso √© essencial.</p><div class="mb-6 text-left"><label class="block text-xs font-bold text-txt-dim mb-1.5 uppercase">Observa√ß√£o</label><textarea oninput="app.updateForm('notes', this.value)" class="w-full p-3 rounded-xl bg-surface border border-bordercol text-txt-main focus:border-status-info outline-none" rows="2">${escapeHtml(
            state.notes
          )}</textarea></div><button onclick="app.saveData('rest')" class="w-full bg-status-info hover:bg-blue-600 text-white py-4 rounded-xl font-bold">Confirmar Descanso</button>${
            state.gymData[state.selectedDay.dateKey]
              ? `<button onclick="app.deleteEntry()" class="w-full text-status-danger font-semibold py-3 mt-2">Excluir Registro</button>`
              : ""
          }</div>`;
        } else {
          content = `<div class="space-y-4"><label class="block text-xs font-bold text-txt-dim mb-2 uppercase">Motivo</label><div class="space-y-2">${missedReasons
            .map(
              (r) =>
                `<label class="flex items-center p-4 border border-bordercol rounded-xl cursor-pointer bg-surface hover:bg-bordercol transition-colors ${
                  state.missedReason === r
                    ? "border-status-danger bg-status-danger-faint"
                    : ""
                }"><input type="radio" name="reason" value="${escapeHtml(r)}" ${
                  state.missedReason === r ? "checked" : ""
                } onchange="app.updateForm('missedReason', this.value)" class="mr-3 w-5 h-5 accent-red-600"><span class="text-txt-main text-sm font-medium">${escapeHtml(
                  r
                )}</span></label>`
            )
            .join("")}</div>${
            state.missedReason === "Outro"
              ? `<textarea oninput="app.updateForm('customReason', this.value)" class="w-full p-3 rounded-xl bg-surface border border-bordercol text-txt-main focus:border-status-danger outline-none" placeholder="Motivo...">${escapeHtml(
                  state.customReason
                )}</textarea>`
              : ""
          }<button onclick="app.saveData('missed')" class="w-full bg-status-danger hover:bg-red-600 text-white py-4 rounded-xl font-bold mt-4">Confirmar Falta</button>${
            state.gymData[state.selectedDay.dateKey]
              ? `<button onclick="app.deleteEntry()" class="w-full text-status-danger font-semibold py-2">Excluir Registro</button>`
              : ""
          }</div>`;
        }

        modal.innerHTML = `<div class="bg-app w-full max-w-[450px] rounded-3xl shadow-none overflow-hidden flex flex-col max-h-[90vh] border border-bordercol"><div class="flex justify-between items-center p-5 border-b border-bordercol bg-surface"><div><h3 class="text-xl font-bold text-txt-main">Dia ${
          state.selectedDay.day
        }</h3><p class="text-txt-dim text-xs uppercase font-bold tracking-widest">${
          monthNames[state.currentDate.getMonth()]
        }</p></div><button onclick="app.closeModal()" class="p-2 rounded-full bg-bordercol hover:bg-zinc-700"><i data-lucide="x" class="w-5 h-5 text-txt-main"></i></button></div><div class="p-5 overflow-y-auto custom-scrollbar">${content}</div></div>`;
        root.appendChild(modal);
      }

      function renderRoutineModal(root) {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 flex items-end sm:items-center justify-center sm:p-4 z-50";
        modal.style.backgroundColor = "rgba(0, 0, 0, 0.9)";
        modal.style.backdropFilter = "blur(4px)";
        let content = "";

        if (state.selectedWeekday === null) {
          const weekdayButtons = weekdays
            .map((d, i) => {
              const hasExercises = state.currentRoutine.days[i].length > 0;
              const cardClass = hasExercises
                ? "bg-surface border-brand"
                : "bg-surface border-bordercol hover:border-zinc-700 opacity-70 hover:opacity-100";
              return `<button onclick="app.openDayEditor(${i})" class="${cardClass} relative flex flex-col justify-between p-4 rounded-2xl border transition-all active:scale-95 text-left group h-28"><div class="flex justify-between items-start w-full"><span class="text-3xl font-black tracking-tighter ${
                hasExercises ? "text-txt-main" : "text-zinc-600"
              }">${d.substring(0, 3).toUpperCase()}</span>${
                hasExercises
                  ? `<div class="bg-brand-faint text-brand p-1.5 rounded-lg"><i data-lucide="dumbbell" class="w-4 h-4"></i></div>`
                  : `<div class="p-1.5"><i data-lucide="plus" class="w-4 h-4 text-zinc-700 group-hover:text-zinc-500"></i></div>`
              }</div><div><p class="text-[10px] font-bold uppercase tracking-widest ${
                hasExercises ? "text-brand" : "text-zinc-600"
              }">${hasExercises ? "Treino" : "Vazio"}</p></div></button>`;
            })
            .join("");
          content = `<div class="mb-6"><label class="block text-xs font-bold text-txt-dim mb-2 uppercase tracking-wider">Nome</label><input type="text" value="${escapeHtml(
            state.routineName
          )}" oninput="state.routineName = this.value" class="w-full p-4 rounded-xl bg-inputbg border border-bordercol text-white focus:border-brand outline-none text-lg font-bold placeholder-zinc-700 transition-colors" placeholder="Ex: Hipertrofia ABC"></div><div class="flex flex-col mb-2 max-h-[60vh] overflow-y-auto pr-1 custom-scrollbar"><label class="block text-xs font-bold text-txt-dim mb-3 uppercase tracking-wider">Configurar Dias</label><div class="grid grid-cols-2 gap-3 pb-4">${weekdayButtons}</div></div><div class="pt-2 border-t border-bordercol"><button onclick="app.saveRoutine()" class="w-full bg-brand hover:bg-brand-hover text-white py-4 rounded-xl font-bold shadow-lg transition-all active:scale-95">Salvar Ficha</button></div>`;
        } else {
          const exList = state.routineExercises
            .map((ex, i) => {
              const gifUrl = exerciseGifs[ex.name] || exerciseGifs["Outro"];
              const btnUpClass =
                i === 0
                  ? "text-zinc-700 cursor-not-allowed"
                  : "text-txt-dim hover:text-white hover:bg-bordercol";
              const btnDownClass =
                i === state.routineExercises.length - 1
                  ? "text-zinc-700 cursor-not-allowed"
                  : "text-txt-dim hover:text-white hover:bg-bordercol";
              return `<div class="p-3 rounded-2xl bg-surface/50 border border-bordercol mb-3 relative group hover:border-zinc-700 transition-colors">
               <div class="flex items-start gap-3 mb-3">
                 <div onclick="app.openPicker(${i})" class="w-14 h-14 shrink-0 rounded-xl bg-inputbg border border-bordercol overflow-hidden relative cursor-pointer hover:border-brand transition-colors"><img src="${gifUrl}" class="w-full h-full object-cover opacity-80" onerror="this.src='https://placehold.co/100x100/27272a/FFF?text=IMG'"></div>
                 <div class="flex-1 min-w-0"><div class="flex justify-between items-start"><div onclick="app.openPicker(${i})" class="cursor-pointer"><span class="text-[10px] font-bold text-brand uppercase tracking-wider block mb-0.5">Exerc√≠cio ${
                i + 1
              }</span><h4 class="text-white font-bold text-sm truncate leading-tight">${escapeHtml(
                ex.name || "Personalizado"
              )}</h4></div><div class="flex items-center gap-1 -mr-2"><button onclick="app.moveRoutineExercise(${i}, -1)" class="p-1 rounded ${btnUpClass}"><i data-lucide="arrow-up" class="w-4 h-4"></i></button><button onclick="app.moveRoutineExercise(${i}, 1)" class="p-1 rounded ${btnDownClass}"><i data-lucide="arrow-down" class="w-4 h-4"></i></button><div class="w-px h-3 bg-bordercol mx-1"></div><button onclick="app.removeRoutineExercise(${i})" class="text-status-danger/40 hover:text-status-danger p-1 rounded hover:bg-status-danger-faint"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>${
                ex.name === "Outro"
                  ? `<input type="text" value="${escapeHtml(
                      ex.customName
                    )}" oninput="app.updateRoutineExercise(${i}, 'customName', this.value)" class="mt-2 w-full bg-black/50 border border-bordercol rounded-lg px-2 py-1 text-xs text-white focus:border-brand outline-none" placeholder="Nome...">`
                  : ""
              }</div>
               </div>
               <div class="grid grid-cols-3 gap-2">
                 <div class="relative"><input type="number" value="${escapeHtml(
                   ex.sets
                 )}" oninput="app.updateRoutineExercise(${i}, 'sets', this.value)" class="w-full p-2.5 rounded-lg bg-inputbg border border-bordercol text-white text-center focus:border-status-info outline-none font-bold text-sm" placeholder="0"><span class="absolute top-[-6px] left-1/2 -translate-x-1/2 text-[8px] font-bold text-status-info bg-surface px-1 uppercase">S√©ries</span></div>
                 <div class="relative"><input type="number" value="${escapeHtml(
                   ex.reps
                 )}" oninput="app.updateRoutineExercise(${i}, 'reps', this.value)" class="w-full p-2.5 rounded-lg bg-inputbg border border-bordercol text-white text-center focus:border-status-success outline-none font-bold text-sm" placeholder="0"><span class="absolute top-[-6px] left-1/2 -translate-x-1/2 text-[8px] font-bold text-status-success bg-surface px-1 uppercase">Reps</span></div>
                 <div class="relative"><input type="number" value="${escapeHtml(
                   ex.weight
                 )}" oninput="app.updateRoutineExercise(${i}, 'weight', this.value)" class="w-full p-2.5 rounded-lg bg-inputbg border border-bordercol text-white text-center focus:border-yellow-500 outline-none font-bold text-sm" placeholder="-"><span class="absolute top-[-6px] left-1/2 -translate-x-1/2 text-[8px] font-bold text-yellow-500 bg-surface px-1 uppercase">Carga</span></div>
               </div>
             </div>`;
            })
            .join("");
          content = `<div class="flex justify-between items-center mb-4 border-b border-bordercol pb-4"><div><h4 class="text-2xl font-bold text-white">${
            weekdays[state.selectedWeekday]
          }</h4><p class="text-txt-dim text-xs">Adicione os exerc√≠cios</p></div><button onclick="app.openPicker()" class="flex items-center gap-2 bg-brand hover:bg-brand-hover text-white px-4 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all active:scale-95"><i data-lucide="plus" class="w-4 h-4"></i> Adicionar</button></div><div class="mb-2 max-h-[60vh] overflow-y-auto pr-1 custom-scrollbar">${
            state.routineExercises.length
              ? exList
              : `<div onclick="app.openPicker()" class="flex flex-col items-center justify-center py-12 text-zinc-600 border-2 border-dashed border-bordercol rounded-2xl cursor-pointer hover:border-brand/50 hover:text-brand transition-colors"><i data-lucide="dumbbell" class="w-10 h-10 mb-2 opacity-30"></i><p class="text-sm font-medium">Toque para adicionar</p></div>`
          }</div><div class="pt-2 border-t border-bordercol"><button onclick="app.saveDayExercises()" class="w-full bg-white hover:bg-zinc-200 text-black py-4 rounded-xl font-bold transition-all active:scale-95">Salvar Treino</button></div>`;
        }

        modal.innerHTML = `<div class="bg-app w-full sm:w-[500px] sm:rounded-3xl rounded-t-3xl shadow-2xl flex flex-col max-h-[95vh] border-t border-bordercol sm:border"><div class="flex justify-between items-center p-5 border-b border-bordercol bg-app rounded-t-3xl"><h3 class="text-lg font-bold text-white flex items-center gap-2">${
          state.routineModalMode === "create"
            ? '<i data-lucide="plus-circle" class="text-brand"></i> Nova Ficha'
            : '<i data-lucide="pencil" class="text-brand"></i> Editar Ficha'
        }</h3><button onclick="state.showRoutineModal = false; state.selectedWeekday = null; app.render()" class="p-2 rounded-full bg-surface hover:bg-bordercol text-txt-muted hover:text-white transition-colors border border-bordercol"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-5 overflow-y-auto custom-scrollbar bg-app">${content}</div></div>`;
        root.appendChild(modal);
      }

      function renderDietTab(root) {
        const mealsHtml =
          state.diet.length === 0
            ? `<div class="text-center py-12 border-2 border-dashed border-bordercol rounded-2xl mt-4"><div class="w-16 h-16 bg-surface rounded-full flex items-center justify-center mx-auto mb-3"><i data-lucide="utensils" class="w-8 h-8 text-zinc-600"></i></div><p class="text-txt-dim text-sm">Nenhuma refei√ß√£o planejada.</p><button onclick="app.openDietModal()" class="text-brand font-bold text-sm mt-2 hover:underline">Criar Plano</button></div>`
            : state.diet
                .map(
                  (meal, i) => `
            <div onclick="app.openDietModal(${i})" class="bg-surface border border-bordercol p-4 rounded-2xl mb-3 relative group active:scale-95 transition-all">
              <div class="absolute top-4 right-4 text-zinc-600 group-hover:text-brand"><i data-lucide="pencil" class="w-4 h-4"></i></div>
              <div class="flex items-center gap-4 mb-3">
                <div class="bg-inputbg border border-bordercol text-white font-mono font-bold px-3 py-2 rounded-lg text-sm">${
                  meal.time
                }</div>
                <h3 class="text-lg font-bold text-txt-main">${escapeHtml(
                  meal.name
                )}</h3>
              </div>
              <div class="flex flex-wrap gap-2 pl-1">${
                meal.foods.length
                  ? meal.foods
                      .map(
                        (f) =>
                          `<span class="px-2 py-1 bg-zinc-800 rounded-md text-xs text-zinc-300 border border-bordercol"><b class="text-white">${f.qty}${f.unit}</b> ${f.name}</span>`
                      )
                      .join("")
                  : '<span class="text-zinc-600 text-xs italic">Sem alimentos</span>'
              }</div>
            </div>`
                )
                .join("");

        root.innerHTML = `<div class="mb-6 pt-2 flex justify-between items-end"><div><h1 class="text-2xl font-bold text-txt-main mb-1 flex items-center gap-2"><i data-lucide="apple" class="text-brand"></i> Dieta</h1><p class="text-txt-dim text-sm">Seu card√°pio di√°rio</p></div>${
          Notification.permission !== "granted"
            ? `<button onclick="app.requestNotificationPermission()" class="bg-surface p-2 rounded-full text-brand hover:text-white border border-bordercol"><i data-lucide="bell" class="w-5 h-5"></i></button>`
            : `<div class="text-status-success text-[10px] font-bold border border-green-900 bg-green-900/20 px-2 py-1 rounded-full flex items-center gap-1"><i data-lucide="bell-ring" class="w-3 h-3"></i> Alertas On</div>`
        }</div><div class="pb-20">${mealsHtml}<button onclick="app.openDietModal()" class="w-full bg-brand hover:bg-brand-hover text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all mt-4"><i data-lucide="plus" class="w-5 h-5"></i> Adicionar Refei√ß√£o</button></div>`;
      }

      function renderDietModal(root) {
        const meal = state.editingMeal;
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 flex items-end sm:items-center justify-center sm:p-4 z-50";
        modal.style.backgroundColor = "rgba(0, 0, 0, 0.9)";
        modal.style.backdropFilter = "blur(4px)";

        const foodsInputs = meal.foods
          .map(
            (food, i) => `
          <div class="flex gap-2 mb-2 items-center animate-in fade-in slide-in-from-left-2 duration-300" style="animation-delay: ${
            i * 50
          }ms">
            <div class="flex-1"><input type="text" value="${escapeHtml(
              food.name
            )}" oninput="app.updateFoodRow(${i}, 'name', this.value)" class="w-full p-3 bg-surface border border-bordercol rounded-xl text-txt-main text-sm focus:border-brand outline-none" placeholder="Ex: Arroz"></div>
            <div class="w-20"><input type="number" value="${escapeHtml(
              food.qty
            )}" oninput="app.updateFoodRow(${i}, 'qty', this.value)" class="w-full p-3 bg-surface border border-bordercol rounded-xl text-txt-main text-center text-sm focus:border-brand outline-none" placeholder="0"></div>
            <div class="w-20"><select onchange="app.updateFoodRow(${i}, 'unit', this.value)" class="w-full p-3 bg-surface border border-bordercol rounded-xl text-txt-main text-sm focus:border-brand outline-none appearance-none text-center"><option value="g" ${
              food.unit === "g" ? "selected" : ""
            }>g</option><option value="ml" ${
              food.unit === "ml" ? "selected" : ""
            }>ml</option><option value="un" ${
              food.unit === "un" ? "selected" : ""
            }>un</option><option value="kcal" ${
              food.unit === "kcal" ? "selected" : ""
            }>kcal</option></select></div>
            <button onclick="app.removeFoodRow(${i})" class="p-3 text-status-danger hover:bg-status-danger-faint rounded-xl transition-colors"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
          </div>
        `
          )
          .join("");

        modal.innerHTML = `<div class="bg-app w-full sm:w-[500px] sm:rounded-3xl rounded-t-3xl shadow-none flex flex-col max-h-[90vh] border-t border-bordercol sm:border"><div class="flex justify-between items-center p-5 border-b border-bordercol bg-app rounded-t-3xl"><h3 class="text-lg font-bold text-txt-main flex items-center gap-2">${
          meal.index !== undefined
            ? '<i data-lucide="pencil" class="text-brand"></i> Editar Refei√ß√£o'
            : '<i data-lucide="plus-circle" class="text-brand"></i> Nova Refei√ß√£o'
        }</h3><button onclick="app.closeDietModal()" class="p-2 rounded-full bg-surface hover:bg-bordercol text-txt-muted hover:text-white transition-colors border border-bordercol"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-5 overflow-y-auto custom-scrollbar bg-app flex-1"><div class="grid grid-cols-3 gap-3 mb-6"><div class="col-span-1"><label class="block text-[10px] font-bold text-txt-dim mb-1.5 uppercase">Hor√°rio</label><input type="time" value="${
          meal.time
        }" oninput="app.updateMealMeta('time', this.value)" class="w-full p-3 bg-inputbg border border-bordercol rounded-xl text-txt-main font-bold text-lg focus:border-brand outline-none text-center"></div><div class="col-span-2"><label class="block text-[10px] font-bold text-txt-dim mb-1.5 uppercase">Nome</label><input type="text" value="${escapeHtml(
          meal.name
        )}" oninput="app.updateMealMeta('name', this.value)" class="w-full p-3 bg-inputbg border border-bordercol rounded-xl text-txt-main font-bold text-lg focus:border-brand outline-none" placeholder="Ex: Caf√© da Manh√£"></div></div><div class="mb-2 flex justify-between items-center"><label class="block text-[10px] font-bold text-txt-dim uppercase">Alimentos</label><button onclick="app.addFoodRow()" class="text-xs font-bold text-brand hover:text-brand flex items-center gap-1">+ Item</button></div><div class="space-y-1 mb-6">${foodsInputs}</div></div><div class="p-4 border-t border-bordercol bg-app flex flex-col gap-3"><button onclick="app.saveMeal()" class="w-full bg-brand hover:bg-brand-hover text-white py-4 rounded-xl font-bold transition-all active:scale-95">Salvar Refei√ß√£o</button>${
          meal.index !== undefined
            ? `<button onclick="app.deleteMeal(${meal.index})" class="w-full text-status-danger font-bold text-sm py-2 hover:bg-status-danger-faint rounded-xl transition-colors">Excluir</button>`
            : ""
        }</div></div>`;
        root.appendChild(modal);
      }

      function renderStatsTab(root) {
        const brandColor = getComputedStyle(document.documentElement)
          .getPropertyValue("--primary")
          .trim();
        const now = new Date();
        let startDate = new Date();
        let labels = [];
        let dataPoints = [];
        if (state.statsPeriod === "week") {
          const day = now.getDay();
          startDate.setDate(now.getDate() - day);
          for (let i = 0; i < 7; i++) {
            let d = new Date(startDate);
            d.setDate(startDate.getDate() + i);
            labels.push(dayNames[d.getDay()].substring(0, 3));
            const k = formatDateKey(d.getFullYear(), d.getMonth(), d.getDate());
            const entry = state.gymData[k];
            if (state.statsMetric === "weight")
              dataPoints.push(
                entry && entry.weight ? parseFloat(entry.weight) : null
              );
            else dataPoints.push(entry && entry.attended ? 1 : 0);
          }
        } else if (state.statsPeriod === "month") {
          const daysInMonth = new Date(
            now.getFullYear(),
            now.getMonth() + 1,
            0
          ).getDate();
          for (let i = 1; i <= daysInMonth; i++) {
            if (i === 1 || i % 5 === 0) labels.push(i);
            else labels.push("");
            const k = formatDateKey(now.getFullYear(), now.getMonth(), i);
            const entry = state.gymData[k];
            if (state.statsMetric === "weight")
              dataPoints.push(
                entry && entry.weight ? parseFloat(entry.weight) : null
              );
            else dataPoints.push(entry && entry.attended ? 1 : 0);
          }
        } else {
          for (let i = 0; i < 12; i++) {
            labels.push(monthNames[i].substring(0, 3));
            let sum = 0;
            let count = 0;
            for (let d = 1; d <= 31; d++) {
              const k = formatDateKey(now.getFullYear(), i, d);
              const entry = state.gymData[k];
              if (entry) {
                if (state.statsMetric === "weight" && entry.weight) {
                  sum += parseFloat(entry.weight);
                  count++;
                } else if (
                  state.statsMetric === "frequency" &&
                  entry.attended
                ) {
                  sum++;
                }
              }
            }
            if (state.statsMetric === "weight")
              dataPoints.push(count > 0 ? sum / count : null);
            else dataPoints.push(sum);
          }
        }

        const allEntries = Object.values(state.gymData);
        const totalWorkouts = allEntries.filter((e) => e.attended).length;
        const totalRest = allEntries.filter((e) => e.status === "rest").length;
        const totalMissed = allEntries.filter(
          (e) => e.status === "missed"
        ).length;
        const countInferior = allEntries.filter(
          (e) => e.attended && e.workoutType === "inferior"
        ).length;
        const countSuperior = allEntries.filter(
          (e) => e.attended && e.workoutType === "superior"
        ).length;
        const countCardio = allEntries.filter(
          (e) => e.attended && e.workoutType === "cardio"
        ).length;
        let currentWeight = "--";
        const sortedDates = Object.keys(state.gymData).sort();
        for (let i = sortedDates.length - 1; i >= 0; i--) {
          const entry = state.gymData[sortedDates[i]];
          if (entry.weight && parseFloat(entry.weight) > 0) {
            currentWeight = entry.weight;
            break;
          }
        }

        let chartContent = "";
        if (state.statsMetric === "weight") {
          const cleanData = dataPoints.filter((n) => n !== null);
          if (cleanData.length < 1) {
            chartContent = `<div class="h-64 flex flex-col items-center justify-center text-txt-dim bg-surface rounded-2xl border border-bordercol"><i data-lucide="activity" class="w-8 h-8 mb-3 opacity-30"></i><p class="text-xs font-medium">Sem dados</p></div>`;
          } else {
            let min = Math.min(...cleanData);
            let max = Math.max(...cleanData);
            if (min === max) {
              min -= 5;
              max += 5;
            }
            const padding = (max - min) * 0.2;
            min -= padding;
            max += padding;
            const range = max - min;
            let pathD = "";
            let areaPathD = "";
            let pointsHtml = "";
            const stepX = 100 / (dataPoints.length - 1);
            let hasStarted = false;
            dataPoints.forEach((val, i) => {
              if (val !== null) {
                const x = i * stepX;
                const y = 100 - ((val - min) / range) * 100;
                if (!hasStarted) {
                  pathD += `M ${x} ${y}`;
                  areaPathD += `M ${x} ${100} L ${x} ${y}`;
                  hasStarted = true;
                } else {
                  pathD += ` L ${x} ${y}`;
                  areaPathD += ` L ${x} ${y}`;
                }
                pointsHtml += `<div class="absolute w-3 h-3 bg-surface border-2 border-brand rounded-full hover:scale-125 transition-transform cursor-pointer group" style="left: ${x}%; top: ${y}%; transform: translate(-50%, -50%);"><div class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-surface border border-bordercol text-txt-main text-[10px] font-bold px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-10">${val.toFixed(
                  1
                )}kg</div></div>`;
              }
            });
            if (hasStarted) {
              const lastValidIndex = dataPoints.findLastIndex(
                (v) => v !== null
              );
              areaPathD += ` L ${lastValidIndex * stepX} 100 Z`;
            }
            chartContent = `<div class="relative h-64 w-full select-none bg-surface rounded-2xl border border-bordercol p-4"><div class="absolute inset-0 flex flex-col justify-between text-[10px] text-zinc-600 font-mono py-6 px-4"><div class="border-b border-bordercol/50 w-full text-right pr-1">${max.toFixed(
              0
            )}</div><div class="border-b border-bordercol/50 w-full text-right pr-1">${(
              min +
              range * 0.5
            ).toFixed(
              0
            )}</div><div class="border-b border-bordercol/50 w-full text-right pr-1">${min.toFixed(
              0
            )}</div></div><svg viewBox="0 0 100 100" preserveAspectRatio="none" class="absolute inset-0 w-full h-full overflow-visible p-4"><defs><linearGradient id="gradientArea" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="${brandColor}" stop-opacity="0.3" /><stop offset="100%" stop-color="${brandColor}" stop-opacity="0" /></linearGradient></defs><path d="${areaPathD}" fill="url(#gradientArea)" stroke="none" /><path d="${pathD}" fill="none" stroke="${brandColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" vector-effect="non-scaling-stroke" /></svg><div class="absolute inset-0 p-4">${pointsHtml}</div><div class="absolute bottom-1 left-4 right-4 flex justify-between">${labels
              .map(
                (l) =>
                  `<div style="width: ${
                    100 / labels.length
                  }%; text-align: center;" class="text-[9px] text-txt-dim truncate">${l}</div>`
              )
              .join("")}</div></div>`;
          }
        } else {
          const maxVal = Math.max(...dataPoints, 5);
          const bars = dataPoints
            .map((val, i) => {
              const height = (val / maxVal) * 100;
              const bgClass = val > 0 ? "bg-brand" : "bg-bordercol";
              return `<div class="flex-1 flex flex-col items-center justify-end group gap-1 h-full"><div class="w-full mx-0.5 rounded-t-sm ${bgClass} transition-all relative" style="height: ${height}%"></div><span class="text-[8px] text-txt-dim truncate w-full text-center h-3 -mb-1">${labels[i]}</span></div>`;
            })
            .join("");
          chartContent = `<div class="h-64 w-full bg-surface rounded-2xl border border-bordercol p-4 pt-8 flex items-end pb-6">${bars}</div>`;
        }

        root.innerHTML = `<div class="mb-6 pt-2 px-1"><h1 class="text-2xl font-bold text-txt-main mb-1 flex items-center gap-2"><i data-lucide="trending-up" class="text-brand"></i> Evolu√ß√£o</h1><p class="text-txt-dim text-sm">Visualize seu progresso</p></div><div class="bg-surface p-1 rounded-xl flex gap-1 mb-4 border border-bordercol"><button onclick="state.statsMetric='weight'; app.render()" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all ${
          state.statsMetric === "weight"
            ? "bg-brand text-white"
            : "text-txt-dim hover:text-white"
        }">Peso Corporal</button><button onclick="state.statsMetric='frequency'; app.render()" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all ${
          state.statsMetric === "frequency"
            ? "bg-brand text-white"
            : "text-txt-dim hover:text-white"
        }">Frequ√™ncia</button></div>${chartContent}<div class="grid grid-cols-3 gap-2 mt-4 mb-6"><button onclick="state.statsPeriod='week'; app.render()" class="py-3 rounded-xl text-xs font-bold border transition-colors ${
          state.statsPeriod === "week"
            ? "bg-brand text-white border-brand"
            : "bg-surface text-txt-dim border-bordercol hover:border-zinc-700"
        }">Semana</button><button onclick="state.statsPeriod='month'; app.render()" class="py-3 rounded-xl text-xs font-bold border transition-colors ${
          state.statsPeriod === "month"
            ? "bg-brand text-white border-brand"
            : "bg-surface text-txt-dim border-bordercol hover:border-zinc-700"
        }">M√™s</button><button onclick="state.statsPeriod='year'; app.render()" class="py-3 rounded-xl text-xs font-bold border transition-colors ${
          state.statsPeriod === "year"
            ? "bg-brand text-white border-brand"
            : "bg-surface text-txt-dim border-bordercol hover:border-zinc-700"
        }">Ano</button></div><div class="grid grid-cols-2 gap-3 mb-3"><div class="bg-surface p-4 rounded-2xl border border-bordercol"><p class="text-txt-dim text-[10px] uppercase font-bold tracking-wider">Total Treinos</p><p class="text-2xl font-black text-txt-main mt-1 tracking-tight">${totalWorkouts}</p></div><div class="bg-surface p-4 rounded-2xl border border-bordercol"><p class="text-txt-dim text-[10px] uppercase font-bold tracking-wider">Peso Atual</p><p class="text-2xl font-black text-txt-main mt-1 tracking-tight">${currentWeight} <span class="text-sm font-medium text-txt-dim">kg</span></p></div></div><div class="grid grid-cols-3 gap-3 mb-3"><div class="bg-surface p-3 rounded-2xl border border-bordercol text-center"><p class="text-status-success text-lg font-black">${totalWorkouts}</p><p class="text-txt-dim text-[9px] uppercase font-bold">Treinos</p></div><div class="bg-surface p-3 rounded-2xl border border-bordercol text-center"><p class="text-status-info text-lg font-black">${totalRest}</p><p class="text-txt-dim text-[9px] uppercase font-bold">Descansos</p></div><div class="bg-surface p-3 rounded-2xl border border-bordercol text-center"><p class="text-status-danger text-lg font-black">${totalMissed}</p><p class="text-txt-dim text-[9px] uppercase font-bold">Faltas</p></div></div><div class="bg-surface rounded-2xl border border-bordercol p-4 mb-20"><p class="text-txt-dim text-[10px] uppercase font-bold tracking-wider mb-3">Divis√£o dos Treinos</p><div class="space-y-3"><div><div class="flex justify-between text-xs font-bold text-zinc-300 mb-1"><span>Inferior (Pernas)</span><span>${countInferior}</span></div><div class="w-full bg-bordercol rounded-full h-2"><div class="bg-brand h-2 rounded-full" style="width: ${
          totalWorkouts ? (countInferior / totalWorkouts) * 100 : 0
        }%"></div></div></div><div><div class="flex justify-between text-xs font-bold text-zinc-300 mb-1"><span>Superior (Bra√ßos/Costas)</span><span>${countSuperior}</span></div><div class="w-full bg-bordercol rounded-full h-2"><div class="bg-brand h-2 rounded-full" style="width: ${
          totalWorkouts ? (countSuperior / totalWorkouts) * 100 : 0
        }%"></div></div></div><div><div class="flex justify-between text-xs font-bold text-zinc-300 mb-1"><span>Cardio</span><span>${countCardio}</span></div><div class="w-full bg-bordercol rounded-full h-2"><div class="bg-brand h-2 rounded-full" style="width: ${
          totalWorkouts ? (countCardio / totalWorkouts) * 100 : 0
        }%"></div></div></div></div></div>`;
      }

      function renderToolsTab(root) {
        if (!state.activeTool) {
          // MENU PRINCIPAL (Mantido igual, apenas verifique as classes)
          root.innerHTML = `<div class="mb-6 pt-2"><h1 class="text-2xl font-bold text-txt-main mb-1 flex items-center gap-2"><i data-lucide="wrench" class="text-brand"></i> Ferramentas</h1><p class="text-txt-dim text-sm">Utilit√°rios</p></div><div class="grid grid-cols-1 gap-3"><button onclick="state.activeTool='timer'; app.render()" class="bg-surface hover:bg-app border border-bordercol p-5 rounded-2xl flex items-center gap-4 text-left transition-all active:scale-95 group shadow-sm"><div class="w-12 h-12 rounded-full bg-brand/10 text-brand flex items-center justify-center border border-brand/20 group-hover:border-brand transition-colors"><i data-lucide="timer" class="w-6 h-6"></i></div><div><h3 class="text-txt-main font-bold text-base">Cron√¥metro</h3><p class="text-txt-dim text-xs mt-0.5">Para descanso</p></div><i data-lucide="chevron-right" class="ml-auto text-txt-dim"></i></button><button onclick="state.activeTool='measurepy'; app.render()" class="bg-surface hover:bg-app border border-bordercol p-5 rounded-2xl flex items-center gap-4 text-left transition-all active:scale-95 group shadow-sm"><div class="w-12 h-12 rounded-full bg-status-success/10 text-status-success flex items-center justify-center border border-status-success/20 group-hover:border-status-success transition-colors"><i data-lucide="ruler" class="w-6 h-6"></i></div><div><h3 class="text-txt-main font-bold text-base">Medidas</h3><p class="text-txt-dim text-xs mt-0.5">Seu crescimento</p></div><i data-lucide="chevron-right" class="ml-auto text-txt-dim"></i></button><button onclick="state.activeTool='checklist'; app.render()" class="bg-surface hover:bg-app border border-bordercol p-5 rounded-2xl flex items-center gap-4 text-left transition-all active:scale-95 group shadow-sm"><div class="w-12 h-12 rounded-full bg-status-info/10 text-status-info flex items-center justify-center border border-status-info/20 group-hover:border-status-info transition-colors"><i data-lucide="check-square" class="w-6 h-6"></i></div><div><h3 class="text-txt-main font-bold text-base">Checklist</h3><p class="text-txt-dim text-xs mt-0.5">√Ågua, Creatina...</p></div><i data-lucide="chevron-right" class="ml-auto text-txt-dim"></i></button></div>`;
          return;
        }
        const header = `<div class="flex items-center gap-3 mb-6 pt-2"><button onclick="state.activeTool=null; app.render()" class="p-2 rounded-full bg-surface hover:bg-bordercol border border-bordercol text-txt-dim hover:text-brand transition-colors"><i data-lucide="arrow-left" class="w-5 h-5"></i></button><h1 class="text-xl font-bold text-txt-main">${
          state.activeTool === "timer"
            ? "Cron√¥metro"
            : state.activeTool === "measurepy"
            ? "Medidas"
            : "Checklist"
        }</h1></div>`;

        if (state.activeTool === "timer") {
          const mins = Math.floor(state.timerTime / 60)
            .toString()
            .padStart(2, "0");
          const secs = (state.timerTime % 60).toString().padStart(2, "0");
          const dashOffset = 283 - (state.timerTime / state.timerTotal) * 283;
          const strokeColor = getComputedStyle(document.documentElement)
            .getPropertyValue("--primary")
            .trim();

          // CORRE√á√ÉO DOS BOT√ïES DO TIMER:
          // bg-surface (branco no light) e text-txt-main (preto no light)
          const btnBaseClass =
            "py-3 border rounded-xl font-bold transition-all shadow-sm ";
          const btnInactiveClass =
            "bg-surface border-bordercol text-txt-dim hover:text-brand hover:border-brand";
          const btnActiveClass = "bg-brand text-white border-brand"; // Esse sempre √© roxo com texto branco

          root.innerHTML = `${header}
            <div class="flex flex-col items-center justify-center pt-4">
                <div class="relative w-64 h-64 mb-10">
                    <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="var(--border-color)" stroke-width="6" />
                        <circle id="timer-progress" cx="50" cy="50" r="45" fill="none" stroke="${strokeColor}" stroke-width="6" stroke-linecap="round" style="stroke-dasharray: 283; stroke-dashoffset: ${dashOffset}; transition: stroke-dashoffset 1s linear" />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span id="timer-display" class="text-6xl font-black text-txt-main tracking-tighter">${mins}:${secs}</span>
                    </div>
                </div>
                <div class="flex gap-4 mb-8">
                    ${
                      state.timerRunning
                        ? `<button onclick="app.stopTimer()" class="w-16 h-16 rounded-full bg-status-danger/10 text-status-danger border-2 border-status-danger flex items-center justify-center hover:bg-status-danger hover:text-white transition-all shadow-lg"><i data-lucide="pause" class="w-8 h-8"></i></button>`
                        : `<button onclick="app.startTimer()" class="w-16 h-16 rounded-full bg-brand text-white flex items-center justify-center hover:bg-brand-hover transition-all shadow-lg shadow-brand/20"><i data-lucide="play" class="w-8 h-8 ml-1"></i></button>`
                    }
                </div>
                
                <div class="grid grid-cols-4 gap-2 w-full">
                    <button onclick="app.resetTimer(30); app.startTimer()" class="${btnBaseClass} ${btnInactiveClass}">30s</button>
                    <button onclick="app.resetTimer(60); app.startTimer()" class="${btnBaseClass} ${btnInactiveClass}">1m</button>
                    <button onclick="app.resetTimer(90); app.startTimer()" class="${btnBaseClass} ${btnInactiveClass}">1:30</button>
                    <button onclick="app.resetTimer(120); app.startTimer()" class="${btnBaseClass} ${btnInactiveClass}">2m</button>
                </div>
                <div class="grid grid-cols-2 gap-2 w-full mt-2">
                    <button onclick="app.addSeconds(10)" class="${btnBaseClass} ${btnInactiveClass}">+10s</button>
                    <button onclick="app.addSeconds(-10)" class="${btnBaseClass} ${btnInactiveClass}">-10s</button>
                </div>
            </div>`;
        } else if (state.activeTool === "measurepy") {
          const m = state.bodyMeasurements;
          window.updateMeasure = (field, value) => {
            state.bodyMeasurements[field] = value;
            saveToStorage();
          };
          root.innerHTML = `${header}<div class="space-y-6"><div class="bg-surface p-4 rounded-2xl border border-bordercol shadow-sm"><h3 class="text-txt-dim text-xs font-bold uppercase tracking-wider mb-3 flex items-center gap-2"><i data-lucide="biceps-flexed" class="w-4 h-4"></i> Bra√ßos</h3><div class="grid grid-cols-2 gap-4"><div><label class="text-xs text-txt-muted mb-1 block">Esq.</label><input type="number" value="${m.armLeft}" oninput="updateMeasure('armLeft', this.value)" class="w-full p-3 bg-inputbg border border-bordercol rounded-xl text-txt-main font-bold focus:border-brand outline-none" placeholder="0"></div><div><label class="text-xs text-txt-muted mb-1 block">Dir.</label><input type="number" value="${m.armRight}" oninput="updateMeasure('armRight', this.value)" class="w-full p-3 bg-inputbg border border-bordercol rounded-xl text-txt-main font-bold focus:border-brand outline-none" placeholder="0"></div></div></div><div class="bg-surface p-4 rounded-2xl border border-bordercol shadow-sm"><h3 class="text-txt-dim text-xs font-bold uppercase tracking-wider mb-3 flex items-center gap-2"><i data-lucide="shirt" class="w-4 h-4"></i> Tronco</h3><div class="grid grid-cols-2 gap-4"><div><label class="text-xs text-txt-muted mb-1 block">Peito</label><input type="number" value="${m.chest}" oninput="updateMeasure('chest', this.value)" class="w-full p-3 bg-inputbg border border-bordercol rounded-xl text-txt-main font-bold focus:border-brand outline-none" placeholder="0"></div><div><label class="text-xs text-txt-muted mb-1 block">Cintura</label><input type="number" value="${m.waist}" oninput="updateMeasure('waist', this.value)" class="w-full p-3 bg-inputbg border border-bordercol rounded-xl text-txt-main font-bold focus:border-brand outline-none" placeholder="0"></div></div></div><div class="bg-surface p-4 rounded-2xl border border-bordercol shadow-sm"><h3 class="text-txt-dim text-xs font-bold uppercase tracking-wider mb-3 flex items-center gap-2"><i data-lucide="footprints" class="w-4 h-4"></i> Pernas</h3><div class="grid grid-cols-2 gap-4 mb-3"><div><label class="text-xs text-txt-muted mb-1 block">Coxa Esq.</label><input type="number" value="${m.legLeft}" oninput="updateMeasure('legLeft', this.value)" class="w-full p-3 bg-inputbg border border-bordercol rounded-xl text-txt-main font-bold focus:border-brand outline-none" placeholder="0"></div><div><label class="text-xs text-txt-muted mb-1 block">Coxa Dir.</label><input type="number" value="${m.legRight}" oninput="updateMeasure('legRight', this.value)" class="w-full p-3 bg-inputbg border border-bordercol rounded-xl text-txt-main font-bold focus:border-brand outline-none" placeholder="0"></div></div><div><label class="text-xs text-txt-muted mb-1 block">Panturrilha</label><input type="number" value="${m.calves}" oninput="updateMeasure('calves', this.value)" class="w-full p-3 bg-inputbg border border-bordercol rounded-xl text-txt-main font-bold focus:border-brand outline-none" placeholder="0"></div></div><p class="text-center text-txt-dim text-xs pt-4">Salvo automaticamente.</p></div>`;
        } else if (state.activeTool === "checklist") {
          const c = state.dailyCheck;
          window.toggleCheck = (key) => {
            state.dailyCheck[key] = !state.dailyCheck[key];
            saveToStorage();
            app.render();
          };
          const items = [
            {
              key: "creatine",
              label: "Tomei Creatina",
              icon: "zap",
              color: "status-info",
            },
            {
              key: "water",
              label: "Bebi 3L de √Ågua",
              icon: "droplets",
              color: "status-info",
            },
            {
              key: "protein",
              label: "Bati a Prote√≠na",
              icon: "beef",
              color: "status-danger",
            },
            { key: "sleep", label: "Dormi 7h+", icon: "moon", color: "brand" },
          ];
          const listHtml = items
            .map((item) => {
              const checked = c[item.key];
              const colorVar = `var(--${item.color
                .replace("brand", "primary")
                .replace("status-", "")})`;
              const style = checked
                ? `border-color: ${colorVar}; background-color: ${colorVar}20;`
                : "";
              // Corre√ß√£o aqui: border-bordercol quando n√£o checado
              return `<button onclick="toggleCheck('${
                item.key
              }')" class="w-full p-5 rounded-2xl border flex items-center justify-between transition-all active:scale-95 group mb-3 shadow-sm ${
                !checked ? "border-bordercol bg-surface" : ""
              }" style="${style}"><div class="flex items-center gap-4"><div class="w-10 h-10 rounded-full bg-inputbg flex items-center justify-center border border-bordercol"><i data-lucide="${
                item.icon
              }" class="w-5 h-5" style="color: ${
                checked ? colorVar : "var(--text-dim)"
              }"></i></div><span class="font-bold text-base ${
                checked ? "text-txt-main" : "text-txt-dim"
              }">${
                item.label
              }</span></div><div class="w-6 h-6 rounded-full border-2 flex items-center justify-center" style="border-color: ${
                checked ? colorVar : "var(--border-color)"
              }; background-color: ${checked ? colorVar : "transparent"}">${
                checked
                  ? '<i data-lucide="check" class="w-4 h-4 text-black font-bold"></i>'
                  : ""
              }</div></button>`;
            })
            .join("");
          root.innerHTML = `${header}<div class="pt-2"><div class="mb-6 p-4 bg-brand/10 border border-brand/20 rounded-xl"><p class="text-brand text-xs text-center">Esses itens reiniciam sua disciplina di√°ria.</p></div>${listHtml}</div>`;
        }
      }

      function renderFeaturesModal(root) {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200";

        // --- LISTA ATUALIZADA E COMPLETA ---
        const features = [
          {
            id: "daily",
            icon: "calendar-check",
            title: "Di√°rio de Treino",
            desc: "Gerencie sua frequ√™ncia e hist√≥rico.",
            details:
              "O cora√ß√£o do app. Marque seus dias como 'Treino', 'Descanso' ou 'Falta'. Ao registrar um treino, voc√™ seleciona a ficha usada, anota as cargas, como se sentiu e pode at√© salvar uma foto do shape do dia para comparar sua evolu√ß√£o futura.",
          },
          {
            id: "routines",
            icon: "clipboard-list",
            title: "Montagem de Fichas",
            desc: "Crie treinos ABC, ABCD ou personalizados.",
            details:
              "Liberdade total para montar seu treino. Crie rotinas ilimitadas (ex: 'Treino de For√ßa', 'Adapta√ß√£o'). Adicione exerc√≠cios espec√≠ficos para cada dia da semana, reordene a lista e edite s√©ries e repeti√ß√µes a qualquer momento.",
          },
          {
            id: "gifs",
            icon: "play-circle",
            title: "Biblioteca Visual (GIFs)",
            desc: "Aprenda a execu√ß√£o correta.",
            details:
              "Nunca mais fique na d√∫vida na academia. Ao clicar em qualquer exerc√≠cio da sua ficha, voc√™ v√™ um GIF em alta qualidade da execu√ß√£o, lista de m√∫sculos trabalhados e 'Dicas de Mestre' para melhorar sua t√©cnica e evitar les√µes.",
          },
          {
            id: "diet",
            icon: "utensils",
            title: "Gest√£o de Dieta",
            desc: "Planeje suas refei√ß√µes e hor√°rios.",
            details:
              "Organize sua alimenta√ß√£o. Crie refei√ß√µes (Caf√©, Almo√ßo, Janta...), defina o hor√°rio e liste os alimentos e quantidades. Se ativar as notifica√ß√µes, o app te avisa 15 minutos antes de cada refei√ß√£o para voc√™ n√£o esquecer de comer.",
          },
          {
            id: "tools",
            icon: "wrench",
            title: "Ferramentas √öteis",
            desc: "Cron√¥metro, Medidas e Checklist.",
            details:
              "Um canivete su√≠√ßo para quem treina: Cron√¥metro para o descanso entre s√©ries, Tabela de Medidas para registrar o crescimento de bra√ßo/perna/peito e um Checklist di√°rio para marcar seus h√°bitos (√Ågua, Creatina, Sono, Prote√≠na).",
          },
          {
            id: "cloud",
            icon: "cloud",
            title: "Backup na Nuvem",
            desc: "Seus dados salvos no Google.",
            details:
              "Seguran√ßa total. Fa√ßa login com sua conta Google para sincronizar tudo na nuvem. Se voc√™ trocar de celular, formatar ou acessar pelo computador, suas fichas, hist√≥rico e dieta estar√£o l√°, s√£os e salvos.",
          },
          {
            id: "ui",
            icon: "moon",
            title: "Personaliza√ß√£o",
            desc: "Temas Claro e Escuro.",
            details:
              "Escolha o visual que mais te agrada. O modo Dark economiza bateria e foca no conte√∫do, enquanto o novo modo Light (Lavanda) oferece uma interface limpa e moderna com alto contraste.",
          },
        ];

        const featuresHtml = features
          .map(
            (f) => `
            <div onclick="app.toggleFeatureDetails('${
              f.id
            }')" class="group bg-surface border border-bordercol rounded-2xl overflow-hidden cursor-pointer hover:border-brand transition-all active:scale-[0.98] mb-3">
                <div class="flex items-center gap-4 p-4">
                    <div class="w-10 h-10 rounded-full bg-brand/10 flex items-center justify-center text-brand flex-shrink-0 group-hover:bg-brand group-hover:text-white transition-colors">
                        <i data-lucide="${f.icon}" class="w-5 h-5"></i>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-txt-main font-bold text-sm mb-0.5">${escapeHtml(
                          f.title
                        )}</h4>
                        <p class="text-txt-dim text-xs">${escapeHtml(
                          f.desc
                        )}</p>
                    </div>
                    <i id="feature-icon-${
                      f.id
                    }" data-lucide="chevron-down" class="w-5 h-5 text-txt-dim transition-transform duration-300"></i>
                </div>
                
                <div id="feature-details-${
                  f.id
                }" class="hidden bg-inputbg border-t border-bordercol p-4 animate-in fade-in slide-in-from-top-1">
                    <p class="text-txt-main text-xs leading-relaxed opacity-80">
                        ${escapeHtml(f.details)}
                    </p>
                </div>
            </div>
        `
          )
          .join("");

        modal.innerHTML = `
            <div class="bg-app w-full max-w-md rounded-3xl border border-bordercol shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
                <div class="p-6 border-b border-bordercol bg-surface z-10">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold text-txt-main flex items-center gap-2">
                            <i data-lucide="sparkles" class="text-brand"></i> Novidades
                        </h3>
                        <button onclick="app.toggleFeatures()" class="p-2 rounded-full bg-app hover:bg-bordercol text-txt-dim hover:text-brand border border-bordercol transition-colors">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <p class="text-txt-dim text-sm">Toque nos itens para ver os detalhes.</p>
                </div>

                <div class="p-4 overflow-y-auto custom-scrollbar bg-app">
                    ${featuresHtml}
                </div>

                <div class="p-4 border-t border-bordercol bg-surface z-10">
                    <button onclick="app.toggleFeatures()" class="w-full bg-brand hover:bg-brand-hover text-white py-3.5 rounded-xl font-bold transition-all active:scale-95 shadow-lg shadow-brand/20">
                        Entendi, vamos treinar!
                    </button>
                </div>
            </div>
        `;
        root.appendChild(modal);
        lucide.createIcons();
      }

      function renderExercisePicker(root) {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 z-[60] bg-black/95 flex flex-col animate-in fade-in duration-200";
        let list = [];
        if (state.pickerFilter === "todos") {
          const all = [
            ...exercisesList.cardio,
            ...exercisesList.inferior,
            ...exercisesList.superior,
          ];
          list = [...new Set(all)];
        } else {
          list = exercisesList[state.pickerFilter] || [];
        }
        if (state.pickerSearch) {
          const term = state.pickerSearch.toLowerCase();
          list = list.filter((ex) => ex.toLowerCase().includes(term));
        }

        const gridHtml = list
          .map((exName) => {
            const gifUrl =
              exerciseGifs[exName] ||
              exerciseGifs[exName.replace(" 45¬∞", "")] ||
              exerciseGifs["Outro"];
            let realType = "superior";
            if (exercisesList.inferior.includes(exName)) realType = "inferior";
            else if (exercisesList.cardio.includes(exName)) realType = "cardio";
            const isUltimate =
              typeof ultimateList !== "undefined" &&
              ultimateList.includes(exName);
            const borderClass = isUltimate
              ? "border-brand border-2"
              : "border-bordercol";
            return `<button onclick="app.selectExerciseFromPicker('${escapeHtml(
              exName
            )}', '${realType}')" class="flex flex-col gap-2 group active:scale-95 transition-transform text-left"><div class="aspect-square w-full rounded-2xl overflow-hidden border ${borderClass} group-hover:border-brand transition-colors relative bg-surface"><img src="${gifUrl}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100" loading="lazy" onerror="this.onerror=null; this.src='https://placehold.co/100x100/27272a/FFF?text=IMG';"><div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent"></div>${
              isUltimate
                ? '<div class="absolute top-2 right-2 w-2 h-2 bg-brand rounded-full"></div>'
                : ""
            }<div class="absolute bottom-2 left-2 right-2"><p class="text-white text-[10px] font-bold leading-tight text-center line-clamp-2">${escapeHtml(
              exName
            )}</p></div></div></button>`;
          })
          .join("");

        modal.innerHTML = `<div class="p-4 bg-surface border-b border-bordercol flex items-center gap-3 shrink-0 z-10"><button onclick="app.closePicker()" class="p-2 -ml-2 rounded-full hover:bg-bordercol text-txt-dim"><i data-lucide="arrow-left" class="w-6 h-6"></i></button><div class="flex-1 relative"><i data-lucide="search" class="w-4 h-4 text-txt-dim absolute left-3 top-1/2 -translate-y-1/2"></i><input type="text" value="${escapeHtml(
          state.pickerSearch
        )}" oninput="app.setPickerSearch(this.value)" placeholder="Buscar..." class="w-full bg-inputbg border border-bordercol rounded-full py-2.5 pl-10 pr-4 text-base text-white focus:border-brand outline-none placeholder-zinc-500"></div></div><div class="flex-1 overflow-y-auto custom-scrollbar"><div class="px-4 pt-4 pb-2 grid grid-cols-4 gap-2 sticky top-0 bg-surface/95 backdrop-blur-sm z-10"><button onclick="app.setPickerFilter('inferior')" class="py-2.5 rounded-xl text-xs font-bold transition-all border ${
          state.pickerFilter === "inferior"
            ? "bg-brand text-white border-brand"
            : "bg-surface text-txt-dim border-bordercol hover:bg-bordercol"
        }">Inferior</button><button onclick="app.setPickerFilter('superior')" class="py-2.5 rounded-xl text-xs font-bold transition-all border ${
          state.pickerFilter === "superior"
            ? "bg-brand text-white border-brand"
            : "bg-surface text-txt-dim border-bordercol hover:bg-bordercol"
        }">Superior</button><button onclick="app.setPickerFilter('cardio')" class="py-2.5 rounded-xl text-xs font-bold transition-all border ${
          state.pickerFilter === "cardio"
            ? "bg-brand text-white border-brand"
            : "bg-surface text-txt-dim border-bordercol hover:bg-bordercol"
        }">Cardio</button><button onclick="app.setPickerFilter('todos')" class="py-2.5 rounded-xl text-xs font-bold transition-all border ${
          state.pickerFilter === "todos"
            ? "bg-brand text-white border-brand"
            : "bg-surface text-txt-dim border-bordercol hover:bg-bordercol"
        }">Todos</button></div><div id="picker-grid-container" class="p-4 pt-2">${
          list.length > 0
            ? `<div class="grid grid-cols-3 gap-3 pb-20">${gridHtml}</div>`
            : `<div class="text-center text-txt-dim mt-20 flex flex-col items-center"><i data-lucide="frown" class="w-10 h-10 mb-2 opacity-50"></i><p>Nada encontrado</p></div>`
        }</div></div>`;
        root.appendChild(modal);
      }

      app.render();
    </script>

    <!-- FIREBASE -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        GoogleAuthProvider,
        signInWithPopup,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // --- SUAS CHAVES ORIGINAIS ---
      const firebaseConfig = {
        apiKey: "AIzaSyA7OU8xkjbPVgUs5z1XExqrKYAP_4TpO4g",
        authDomain: "gymdaily-app.firebaseapp.com",
        projectId: "gymdaily-app",
        storageBucket: "gymdaily-app.firebasestorage.app",
        messagingSenderId: "1072026357474",
        appId: "1:1072026357474:web:8e48b13d3b9ad58c5258bb",
      };

      // Inicializa Firebase
      let appFirebase;
      let auth;
      let db;
      let provider;

      try {
        appFirebase = initializeApp(firebaseConfig);
        auth = getAuth(appFirebase);
        db = getFirestore(appFirebase);
        provider = new GoogleAuthProvider();
        console.log("Firebase conectado.");
      } catch (e) {
        console.error("Erro ao iniciar Firebase:", e);
      }

      let currentUser = null;

      // Fun√ß√£o Global de Login
      window.loginGoogle = async () => {
        if (!auth) return alert("Firebase n√£o inicializou.");
        try {
          console.log("Abrindo popup...");
          const result = await signInWithPopup(auth, provider);
          // O observador onAuthStateChanged vai atualizar a tela automaticamente
        } catch (error) {
          console.error("Erro no login:", error);
          alert("Erro ao logar: " + error.message);
        }
      };

      // Fun√ß√£o Global de Logout
      window.logoutGoogle = async () => {
        if (!auth) return;
        try {
          await signOut(auth);
          alert("Voc√™ saiu da conta.");
        } catch (error) {
          console.error(error);
        }
      };

      // Fun√ß√£o para Salvar na Nuvem (Atualizada com Dieta e Tema)
      window.saveToCloud = async () => {
        // Se n√£o estiver logado, salva apenas no LocalStorage
        if (!currentUser || !db) {
          localStorage.setItem("gymTrackerData", JSON.stringify(state.gymData));
          localStorage.setItem("gymRoutines", JSON.stringify(state.routines));
          localStorage.setItem("gymDiet", JSON.stringify(state.diet));
          localStorage.setItem(
            "gymChecklist",
            JSON.stringify(state.dailyCheck)
          );
          localStorage.setItem(
            "gymMeasurements",
            JSON.stringify(state.bodyMeasurements)
          );
          localStorage.setItem("gymTheme", state.theme);
          return;
        }

        // Se estiver logado, salva no Firestore
        try {
          const userRef = doc(db, "users", currentUser.uid);
          await setDoc(userRef, {
            gymData: state.gymData,
            routines: state.routines,
            diet: state.diet,
            dailyCheck: state.dailyCheck,
            bodyMeasurements: state.bodyMeasurements,
            theme: state.theme,
            lastUpdate: new Date().toISOString(),
          });
          console.log("Dados sincronizados com a nuvem!");
        } catch (e) {
          console.error("Erro ao salvar na nuvem:", e);
        }
      };

      // Observador de Estado (Roda quando loga, desloga ou recarrega a p√°gina)
      if (auth) {
        onAuthStateChanged(auth, async (user) => {
          console.log("Auth State:", user ? "Logado" : "Deslogado");

          if (user) {
            currentUser = user;
            state.isLogged = true;
            state.userPhoto = user.photoURL;
            state.userName = user.displayName;

            // Busca dados do Firestore
            const docRef = doc(db, "users", user.uid);
            try {
              const docSnap = await getDoc(docRef);

              if (docSnap.exists()) {
                const data = docSnap.data();

                // Carrega dados da nuvem para o App
                state.gymData = data.gymData || {};
                state.routines = data.routines || [];
                state.diet = data.diet || [];
                state.dailyCheck = data.dailyCheck || {
                  creatine: false,
                  water: false,
                  sleep: false,
                  protein: false,
                };
                state.bodyMeasurements = data.bodyMeasurements || {
                  armRight: "",
                  armLeft: "",
                  legRight: "",
                  legLeft: "",
                  chest: "",
                  waist: "",
                  calves: "",
                };

                // Aplica o tema salvo na nuvem
                if (data.theme) state.theme = data.theme;

                app.render();
                console.log("Dados baixados da nuvem com sucesso.");
              } else {
                // Se √© a primeira vez, sobe o que tem local para a nuvem
                saveToCloud();
                app.render();
              }
            } catch (e) {
              console.error("Erro ao buscar dados:", e);
            }
          } else {
            // Se deslogou
            currentUser = null;
            state.isLogged = false;
            state.showProfileMenu = false;
            state.userPhoto = null;
            state.userName = "";
            app.render();
          }
        });
      }
    </script>
  </body>
</html>
