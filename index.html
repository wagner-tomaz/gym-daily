<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Gym Daily</title>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#000000" />
    <link rel="apple-touch-icon" href="../gym-daily/images/gymdaily.png" />
    <link rel="icon" sizes="192x192" href="../gym-daily/images/gymdaily.png" />

    <script src="libs/tailwind.js"></script>
    <script src="libs/lucide.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            borderRadius: {
              lg: "4px",
              xl: "8px",
              "2xl": "8px",
              "3xl": "12px",
              full: "8px",
            },
          },
        },
      };
    </script>

    <style>
      html,
      body {
        overscroll-behavior-y: none;
        background-color: black;
        color: white;
        -webkit-tap-highlight-color: transparent;
        width: 100%;
        height: 100%;
      }
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #1a1a1a;
      }
      ::-webkit-scrollbar-thumb {
        background: #3b0764;
        border-radius: 3px;
      }
      input,
      select,
      textarea {
        font-size: 16px !important;
      }
    </style>
  </head>
  <body class="min-h-screen bg-zinc-950 pb-24 select-none">
    <div id="root" class="max-w-md mx-auto p-4"></div>

    <div
      class="fixed bottom-0 left-0 right-0 border-t z-40 bg-zinc-900 border-zinc-800"
    >
      <div class="max-w-md mx-auto flex">
        <button
          onclick="app.setTab('calendar')"
          id="btn-calendar"
          class="flex-1 py-4 flex flex-col items-center gap-1 transition-colors"
        >
          <i data-lucide="calendar" class="w-6 h-6"></i>
          <span class="text-xs font-semibold">Calendário</span>
        </button>
        <button
          onclick="app.setTab('routine')"
          id="btn-routine"
          class="flex-1 py-4 flex flex-col items-center gap-1 transition-colors"
        >
          <i data-lucide="dumbbell" class="w-6 h-6"></i>
          <span class="text-xs font-semibold">Ficha</span>
        </button>
      </div>
    </div>

    <script>
      // === FUNÇÃO DE SANITIZAÇÃO ===
      function escapeHtml(text) {
        if (text === null || text === undefined) return "";
        const div = document.createElement("div");
        div.textContent = String(text);
        return div.innerHTML;
      }

      // === ESTADO GLOBAL ===
      const state = {
        // Controle do Seletor de Exercícios (Novo)
        showExercisePicker: false,
        pickerFilter: 'inferior', // 'inferior', 'superior', 'todos'
        pickerSearch: '',
        editingIndex: null, // Para saber se estamos criando um novo ou trocando um existente

        isLogged: false,
        userPhoto: null,        // <--- NOVO
        userName: '',           // <--- NOVO
        showProfileMenu: false, // <--- NOVO: Controla se o menu tá aberto ou fechado

        isLogged: false,
        showFeaturesModal: false,
        viewingImage: null,
        currentTab: "calendar",
        currentDate: new Date(),
        gymData: JSON.parse(localStorage.getItem("gymTrackerData")) || {},
        routines: JSON.parse(localStorage.getItem("gymRoutines")) || [],

        selectedDay: null,
        showModal: false,
        modalMode: "select",

        weight: "",
        workoutType: "",
        exercises: [
          { name: "", customName: "", weight: "", reps: "", sets: "" },
        ],
        notes: "",
        photo: null,
        missedReason: "",
        customReason: "",

        showRoutineModal: false,
        routineModalMode: "create",
        currentRoutine: null,
        routineName: "",
        selectedWeekday: null,
        routineExercises: [],

        viewingRoutineId: null,
        viewingDay: null,
      };

      // === CONSTANTES ===
      const weekdays = [
        "Domingo",
        "Segunda-feira",
        "Terça-feira",
        "Quarta-feira",
        "Quinta-feira",
        "Sexta-feira",
        "Sábado",
      ];
      const monthNames = [
        "Janeiro",
        "Fevereiro",
        "Março",
        "Abril",
        "Maio",
        "Junho",
        "Julho",
        "Agosto",
        "Setembro",
        "Outubro",
        "Novembro",
        "Dezembro",
      ];
      const dayNames = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];

      const exerciseGifs = {
        // === CARDIO & AQUECIMENTO ===
        "Esteira": "https://i.pinimg.com/originals/2c/87/4b/2c874b1b5b30a07eeee1e3002d2e52b4.gif",
        "Escada": "https://www.hipertrofia.org/blog/wp-content/uploads/2024/09/walking-on-stepmill.gif", // Nome da ficha: "Escada"
        "Bicicleta Ergométrica": "https://i.pinimg.com/originals/88/00/6a/88006a03e1da8a94a7843f5306dac42f.gif",
        "Elíptico (Transport)": "https://gymvisual.com/img/p/1/5/8/4/1/15841.gif",
        "Pular Corda": "https://www.mundoboaforma.com.br/wp-content/uploads/2021/04/pular-corda.gif",
        "Caminhada Leve": "https://png.pngtree.com/png-clipart/20220419/original/pngtree-man-doing-walking-exercise-png-image_7538567.png", // Ficha Sábado

        // === INFERIOR (Pernas/Glúteos) ===
        "Agachamento Livre": "https://media1.tenor.com/m/pdMmsiutWkcAAAAC/gym.gif",
        "Agachamento Hack": "https://media.tenor.com/jiqHF0MkHeYAAAAM/gym.gif", 
        "Leg Press 45°": "https://media1.tenor.com/m/xJh_-w_SxckAAAAC/leg-press.gif",
        "Cadeira Extensora": "https://media1.tenor.com/m/bqKtsSuqilQAAAAC/gym.gif",
        "Cadeira Flexora": "https://i0.wp.com/omelhortreino.com.br/wp-content/uploads/2025/07/Cadeira-flexora.gif?resize=550%2C550&ssl=1",
        "Mesa Flexora": "https://media1.tenor.com/m/fj_cZPprAyMAAAAC/gym.gif", // Ficha: "Mesa Flexora (Deitado)"
        "Stiff": "https://i.pinimg.com/originals/82/4d/fd/824dfd405284597cd20e8a55233e2d77.gif",
        "Levantamento Terra": "https://www.hipertrofia.org/blog/wp-content/uploads/2017/11/barbell-deadlift.gif",
        "Elevação Pélvica": "https://i0.wp.com/meutreinador.com/wp-content/uploads/2024/04/elevacao-pelvica-no-banco.gif?fit=1080%2C1080&ssl=1",
        "Cadeira Abdutora": "https://www.hipertrofia.org/blog/wp-content/uploads/2024/09/lever-seated-hip-abduction.gif",
        "Cadeira Adutora": "https://i.pinimg.com/originals/4e/17/b8/4e17b88b6b11c54155939c0a5b3c3381.gif",
        "Agachamento Búlgaro": "https://www.hipertrofia.org/blog/wp-content/uploads/2024/06/agachamento-bulgaro.gif",
        "Subida no Banco (Step-up)": "https://www.mundoboaforma.com.br/wp-content/uploads/2021/09/stepup-alto-no-banco-com-halteres.gif", // Novo da ficha
        "Abdução de Quadril (Deitado)": "https://www.mundoboaforma.com.br/wp-content/uploads/2021/09/abducao-do-quadril-pernas-deitado-no-solo-com-elevacao-da-perna-reta.gif", // Novo da ficha Sábado
        "Mobilidade de Anca e Tornozelo": "https://nabexigamandoeu.pt/wp-content/uploads/2018/06/05_gif.gif", // Novo

        // === PANTURRILHA ===
        "Panturrilha em Pé": "https://www.hipertrofia.org/blog/wp-content/uploads/2023/03/lever-standing-calf-raise.gif",
        "Panturrilha Sentado": "https://www.hipertrofia.org/blog/wp-content/uploads/2018/10/lever-seated-calf-raise-.gif", 
        "Panturrilha (Livre ou Máquina)": "https://www.hipertrofia.org/blog/wp-content/uploads/2023/07/standing-calf-raise-on-a-staircase.gif", // Ficha Sábado

        // === PEITO ===
        "Supino Reto": "https://www.hipertrofia.org/blog/wp-content/uploads/2018/09/barbell-decline-bench-press.gif", // Ficha: "Supino Reto (Halteres)" - O gif é barra, mas serve a referência
        "Supino Inclinado": "https://www.hipertrofia.org/blog/wp-content/uploads/2023/05/dumbbell-incline-bench-press.gif", // Ficha: "Supino Inclinado (Halteres)"
        "Peck Deck (Crucifixo Máquina)": "https://www.mundoboaforma.com.br/wp-content/uploads/2020/12/voador-no-aparelho.gif", // Nome exato da ficha
        "Crucifixo": "https://www.hipertrofia.org/blog/wp-content/uploads/2023/09/dumbbell-fly.gif",
        "Crossover (Polia)": "https://i0.wp.com/meutreinador.com/wp-content/uploads/2024/04/Crossover-polia-alta.gif?fit=1080%2C1080&ssl=1", 
        "Mergulho": "https://i.pinimg.com/originals/4a/48/40/4a48407e46bab53a0c6050935f61f669.gif",

        // === COSTAS ===
        "Puxada Aberta (Pulldown)": "https://www.mundoboaforma.com.br/wp-content/uploads/2020/12/costas-puxada-aberta-com-barra-no-pulley.gif", // Nome exato da ficha
        "Remada Sentada (Triângulo)": "https://media.tenor.com/vy_b35185M0AAAAM/remada-baixa-triangulo.gif", // Nome exato da ficha
        "Barra Fixa": "https://www.mundoboaforma.com.br/wp-content/uploads/2020/12/costas-barra-fixa-pegada-aberta-palma-para-frente-chinup.gif", 
        "Remada Curvada": "https://www.mundoboaforma.com.br/wp-content/uploads/2020/12/costas-remada-curvada-.gif",
        "Remada Unilateral (Serrote)": "https://www.mundoboaforma.com.br/wp-content/uploads/2020/12/costas-remada-unilateral-com-halter-serrote-no-banco.gif", 
        "Dead Hang (Pendurar na barra)": "https://media.tenor.com/PfpznfyXlk8AAAAM/hang-strong.gif", // Novo da ficha

        // === OMBROS ===
        "Desenvolvimento": "https://www.mundoboaforma.com.br/wp-content/uploads/2020/12/desenvolvimento-para-ombros-com-halteres.gif",
        "Elevação Lateral": "https://media.tenor.com/cy46UbnfUrkAAAAM/eleva%C3%A7%C3%A3o-lateral-hateres.gif",
        "Elevação Frontal": "https://image.tuasaude.com/media/article/sz/nf/elevacao-frontal_75624.gif?width=686&height=487", 
        "Face Pull": "https://fitnessprogramer.com/wp-content/uploads/2021/02/Face-Pull.gif", 
        "Encolhimento (Trapézio)": "https://www.hipertrofia.org/blog/wp-content/uploads/2024/01/dumbbell-shrug.gif", 

        // === BRAÇOS (Bíceps/Tríceps/Antebraço) ===
        "Rosca Scott": "https://www.mundoboaforma.com.br/wp-content/uploads/2020/11/Rosca-Scott-com-halteres-com-dois-bracos.gif", 
        "Rosca Inversa": "https://i0.wp.com/omelhortreino.com.br/wp-content/uploads/2025/04/Rosca-Inversa.gif?resize=550%2C550&ssl=1",
        "Flexão de Punho": "https://treinomestre.com.br/wp-content/uploads/2024/09/flexao-de-punho-com-halteres.gif",
        "Rosca Martelo": "https://www.hipertrofia.org/blog/wp-content/uploads/2023/04/dumbbell-hammer-curl-v-2.gif",
        "Tríceps Corda": "https://media.tenor.com/mbebKudZjxYAAAAM/tr%C3%ADceps-pulley.gif",
        "Rosca Pajé (Wrist Roller)": "https://burnfit.io/wp-content/uploads/2023/11/WRIST_ROLLER.gif", // Novo da ficha
        "Rosca Direta": "https://www.hipertrofia.org/blog/wp-content/uploads/2024/02/barbell-standing-close-grip-curl.gif",
        "Tríceps Testa": "https://www.hipertrofia.org/blog/wp-content/uploads/2024/02/barbell-lying-triceps-extension-skull-crusher.gif",
        "Tríceps Francês": "https://www.hipertrofia.org/blog/wp-content/uploads/2025/01/triceps-frances-com-um-halter-sentado.gif", 
        "Tríceps Coice": "https://karoldeliberato.com.br/wp-content/uploads/2023/05/image68.gif", 

        // === CORE / ABS / LOMBAR ===
        "Abdominal Infra (Elevação pernas)": "https://grandeatleta.com.br/wp-content/uploads/2024/03/Abdominal-infra-solo.gif", // Nome ajustado
        "Prancha Abdominal": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSERETl8HEs2s1GLn4FV5zdxsELa2-_oxBV7w&s", // Nome ajustado
        "Abdominal Supra (Crunch)": "https://www.mundoboaforma.com.br/wp-content/uploads/2023/02/47271301-abdominal-supra.gif",
        "Extensão Lombar (Banco Romano)": "https://media.tenor.com/Fsu8AmbXPl0AAAAM/back-extension.gif", // Novo da ficha
        "Stomach Vacuum": "https://www.wikihow.com/images/thumb/9/96/Do-the-Stomach-Vacuum-Exercise-Step-5-Version-2.jpg/v4-460px-Do-the-Stomach-Vacuum-Exercise-Step-5-Version-2.jpg", // Novo da ficha
        "Flexão de Braço (Push-up)": "https://i.pinimg.com/originals/b0/da/7f/b0da7f7f3556befcc7cbdd0ba33be39e.gif", // Novo da ficha (Core/Peito)

        // === PADRÃO ===
        "Outro": "https://media.forgecdn.net/attachments/627/928/pushup.gif"
      };

      const missedReasons = [
        "Feriado",
        "Academia fechada",
        "Doente",
        "Cansaço excessivo",
        "Trabalho/Estudo",
        "Perdi o horário",
        "Outro",
      ];

      const exercisesList = {
        cardio: [ 
            "Escada",
            "Esteira",
            "Caminhada Leve",
            "Bicicleta Ergométrica",
            "Elíptico (Transport)",
            "Pular Corda",
            "Mobilidade de Anca e Tornozelo",
            "Outro"
        ],
        inferior: [
            // --- Quadríceps ---
            "Agachamento Livre",
            "Agachamento Hack",
            "Leg Press 45°",
            "Cadeira Extensora",
            "Agachamento Búlgaro",
            "Subida no Banco (Step-up)",
            "Afundo",

            // --- Posterior & Glúteo ---
            "Elevação Pélvica",
            "Stiff",
            "Mesa Flexora",
            "Cadeira Flexora",
            "Abdução de Quadril (Deitado)",
            "Cadeira Abdutora",
            "Glúteo Polia (Coice)", // (Mantive como opção extra)

            // --- Adutores ---
            "Cadeira Adutora",

            // --- Panturrilha ---
            "Panturrilha em Pé",
            "Panturrilha Sentado",
            "Panturrilha (Livre ou Máquina)",

            // --- Geral ---
            "Levantamento Terra",
            "Outro",
        ],
        superior: [
            // --- Peito ---
            "Supino Inclinado",
            "Supino Reto",
            "Peck Deck (Crucifixo Máquina)",
            "Crucifixo",
            "Flexão de Braço (Push-up)",
            "Mergulho",
            "Crossover (Polia)",

            // --- Costas ---
            "Puxada Aberta (Pulldown)",
            "Remada Sentada (Triângulo)",
            "Barra Fixa",
            "Remada Curvada",
            "Remada Unilateral (Serrote)",
            "Dead Hang (Pendurar na barra)",

            // --- Ombros ---
            "Desenvolvimento",
            "Elevação Lateral",
            "Elevação Frontal",
            "Face Pull",
            "Encolhimento (Trapézio)",

            // --- Braços (Bíceps/Tríceps) ---
            "Rosca Scott",
            "Rosca Martelo",
            "Rosca Direta",
            "Tríceps Corda",
            "Tríceps Testa",
            "Tríceps Francês",
            "Tríceps Coice",

            // --- Antebraço ---
            "Rosca Inversa",
            "Flexão de Punho",
            "Rosca Pajé (Wrist Roller)",

            // --- Core / Lombar ---
            "Abdominal Infra (Elevação pernas)",
            "Abdominal Supra (Crunch)",
            "Prancha Abdominal",
            "Extensão Lombar (Banco Romano)",
            "Stomach Vacuum",

            "Outro",
        ],
        mesclado: [],
      };

      exercisesList.mesclado = [
        ...exercisesList.inferior.slice(0, -1),
        ...exercisesList.superior,
      ];

      // --- LISTA PARA DESTAQUE VISUAL ---
      const ultimateList = [
        "Elevação Pélvica", "Stiff", "Cadeira Flexora", "Leg Press 45°", "Cadeira Abdutora", "Panturrilha em Pé", "Cadeira Extensora",
        "Supino Inclinado", "Peck Deck (Crucifixo Máquina)", "Puxada Aberta (Pulldown)", "Remada Sentada (Triângulo)", "Rosca Scott", "Rosca Inversa", "Flexão de Punho",
        "Escada", "Abdominal Infra (Elevação pernas)", "Prancha Abdominal", "Abdominal Supra (Crunch)", "Extensão Lombar (Banco Romano)", "Flexão de Braço (Push-up)", "Stomach Vacuum",
        "Agachamento Livre", "Agachamento Hack", "Agachamento Búlgaro", "Mesa Flexora", "Subida no Banco (Step-up)", "Panturrilha Sentado", "Cadeira Adutora",
        "Desenvolvimento", "Elevação Lateral", "Supino Reto", "Rosca Martelo", "Tríceps Corda", "Rosca Pajé (Wrist Roller)", "Dead Hang (Pendurar na barra)",
        "Panturrilha (Livre ou Máquina)", "Abdução de Quadril (Deitado)", "Mobilidade de Anca e Tornozelo", "Caminhada Leve"
      ];

      // === UTILITÁRIOS ===
      const formatDateKey = (year, month, day) =>
        `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(
          2,
          "0"
        )}`;

      const getDaysInMonth = (date) => {
        const year = date.getFullYear();
        const month = date.getMonth();
        return {
          daysInMonth: new Date(year, month + 1, 0).getDate(),
          startingDayOfWeek: new Date(year, month, 1).getDay(),
        };
      };

      const getDayType = (exercises) => {
        if (!exercises || exercises.length === 0) return "";
        const types = [...new Set(exercises.map((ex) => ex.type))];
        if (types.length === 1)
          return types[0].charAt(0).toUpperCase() + types[0].slice(1);
        return "Mesclado";
      };

      const saveToStorage = () => {
        if (window.saveToCloud) {
          window.saveToCloud();
        } else {
          localStorage.setItem("gymTrackerData", JSON.stringify(state.gymData));
          localStorage.setItem("gymRoutines", JSON.stringify(state.routines));
        }
      };

      // === APLICAÇÃO PRINCIPAL ===
      window.app = {
        render: () => {
          const root = document.getElementById("root");
          root.innerHTML = "";

          document.getElementById("btn-calendar").style.color =
            state.currentTab === "calendar" ? "#a855f7" : "#71717a";
          document.getElementById("btn-routine").style.color =
            state.currentTab === "routine" ? "#a855f7" : "#71717a";

          if (state.currentTab === "calendar") renderCalendar(root);
          else renderRoutineTab(root);

          if (state.showModal) renderCalendarModal(root);
          if (state.showRoutineModal) renderRoutineModal(root);
          if (state.viewingImage) renderImageModal(root);
          if (state.showFeaturesModal) renderFeaturesModal(root);

          if (state.showExercisePicker) renderExercisePicker(root);

          lucide.createIcons();
        },

        // Abre o Seletor (Pode ser para criar novo ou trocar um existente)
        openPicker: (index = null) => {
            state.editingIndex = index; // Se for null, é novo. Se for número, é edição.
            state.pickerFilter = 'inferior'; // Reseta filtro
            state.pickerSearch = ''; // Reseta busca
            state.showExercisePicker = true;
            app.render();
        },

        closePicker: () => {
            state.showExercisePicker = false;
            app.render();
        },

        setPickerFilter: (filter) => {
            state.pickerFilter = filter;
            // Aqui podemos usar render completo para atualizar as abas coloridas
            app.render(); 
        },

        setPickerSearch: (text) => {
            state.pickerSearch = text;
            // --- MUDANÇA: NÃO CHAMA app.render() ---
            updatePickerGridOnly(); 
        },

        selectExerciseFromPicker: (name, type) => {
            if (state.editingIndex === null) {
                // Adicionando NOVO exercício
                state.routineExercises.push({
                    type: type,
                    name: name,
                    customName: '',
                    weight: '',
                    reps: '',
                    sets: ''
                });
            } else {
                // Trocando exercício EXISTENTE (mantém carga/reps)
                state.routineExercises[state.editingIndex].name = name;
                state.routineExercises[state.editingIndex].type = type;
                state.routineExercises[state.editingIndex].customName = '';
            }
            state.showExercisePicker = false;
            app.render();
        },

        toggleProfileMenu: () => {
            state.showProfileMenu = !state.showProfileMenu;
            app.render(); // Redesenha para mostrar/esconder o menu
        },

        setTab: (tab) => {
          state.currentTab = tab;
          app.render();
        },
        toggleFeatures: () => {
          state.showFeaturesModal = !state.showFeaturesModal;
          app.render();
        },
        openImage: (url) => {
          state.viewingImage = url;
          app.render();
        },
        closeImage: () => {
          state.viewingImage = null;
          app.render();
        },

        prevMonth: () => {
          state.currentDate = new Date(
            state.currentDate.getFullYear(),
            state.currentDate.getMonth() - 1
          );
          app.render();
        },
        nextMonth: () => {
          state.currentDate = new Date(
            state.currentDate.getFullYear(),
            state.currentDate.getMonth() + 1
          );
          app.render();
        },
        dayClick: (day) => {
          const dateKey = formatDateKey(
            state.currentDate.getFullYear(),
            state.currentDate.getMonth(),
            day
          );
          const dateObj = new Date(
            state.currentDate.getFullYear(),
            state.currentDate.getMonth(),
            day
          );
          state.selectedDay = { day, dateKey, weekdayIndex: dateObj.getDay() };
          const data = state.gymData[dateKey];
          app.resetForm();
          if (data) {
            if (data.status) state.modalMode = data.status;
            else state.modalMode = data.attended ? "attended" : "missed";
            if (state.modalMode === "attended") {
              state.weight = data.weight || "";
              state.workoutType = data.workoutType || "";
              state.exercises = data.exercises || [
                { name: "", customName: "", weight: "", reps: "", sets: "" },
              ];
              state.notes = data.notes || "";
              state.photo = data.photo || null;
            } else if (state.modalMode === "missed") {
              state.missedReason = data.reason || "";
              state.customReason = data.customReason || "";
            }
          } else {
            state.modalMode = "select";
          }
          state.showModal = true;
          app.render();
        },
        resetForm: () => {
          state.weight = "";
          state.workoutType = "";
          state.exercises = [
            { name: "", customName: "", weight: "", reps: "", sets: "" },
          ];
          state.notes = "";
          state.photo = null;
          state.missedReason = "";
          state.customReason = "";
        },
        closeModal: () => {
          state.showModal = false;
          app.render();
        },
        setModalMode: (mode) => {
          state.modalMode = mode;
          app.render();
        },
        updateForm: (field, value) => {
          state[field] = value;
          if (field === "workoutType") app.render();
        },
        addExercise: () => {
          state.exercises.push({
            name: "",
            customName: "",
            weight: "",
            reps: "",
            sets: "",
          });
          app.render();
        },
        removeExercise: (index) => {
          state.exercises.splice(index, 1);
          app.render();
        },
        updateExercise: (index, field, value) => {
          state.exercises[index][field] = value;
        },
        loadRoutineIntoSession: (routineId) => {
          if (!routineId) return;
          const routine = state.routines.find((r) => r.id == routineId);
          if (!routine) return;
          const weekday = state.selectedDay.weekdayIndex;
          const exercisesForDay = routine.days[weekday];
          if (exercisesForDay && exercisesForDay.length > 0) {
            state.exercises = exercisesForDay.map((ex) => ({
              name: ex.name,
              customName: ex.customName,
              weight: ex.weight,
              reps: ex.reps,
              sets: ex.sets,
            }));
            const types = [...new Set(exercisesForDay.map((e) => e.type))];
            state.workoutType = types.length === 1 ? types[0] : "mesclado";
            alert(`Treino de ${weekdays[weekday]} carregado!`);
          } else {
            alert(`Sem treinos para ${weekdays[weekday]} nesta rotina.`);
          }
          app.render();
        },
        saveData: (status) => {
          const entry = {
            status: status,
            attended: status === "attended",
            notes: state.notes,
          };
          if (status === "attended") {
            entry.weight = state.weight;
            entry.workoutType = state.workoutType;
            entry.exercises = state.exercises
              .filter((ex) => ex.name)
              .map((ex) => ({
                ...ex,
                name: ex.name === "Outro" ? ex.customName : ex.name,
              }));
            entry.photo = state.photo;
          } else if (status === "missed") {
            entry.reason = state.missedReason;
            entry.customReason =
              state.missedReason === "Outro" ? state.customReason : "";
          }
          state.gymData[state.selectedDay.dateKey] = entry;
          saveToStorage();
          state.showModal = false;
          app.resetForm();
          app.render();
        },
        deleteEntry: () => {
          if (confirm("Apagar registro?")) {
            delete state.gymData[state.selectedDay.dateKey];
            saveToStorage();
            state.showModal = false;
            app.resetForm();
            app.render();
          }
        },
        exportJSON: () => {
          const data = {
            exportDate: new Date().toISOString(),
            data: state.gymData,
            routines: state.routines,
          };
          const url = URL.createObjectURL(
            new Blob([JSON.stringify(data, null, 2)], {
              type: "application/json",
            })
          );
          const link = document.createElement("a");
          link.href = url;
          link.download = `backup-gym-${
            new Date().toISOString().split("T")[0]
          }.json`;
          link.click();
          URL.revokeObjectURL(url);
        },
        importJSON: (input) => {
          const file = input.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const imported = JSON.parse(e.target.result);
              if (imported.type === "single_routine") {
                state.routines.push(imported.data);
                alert(`Rotina importada!`);
              } else {
                if (imported.data) state.gymData = imported.data;
                if (imported.routines) state.routines = imported.routines;
                alert("Backup restaurado!");
              }
              saveToStorage();
              app.render();
            } catch {
              alert("Erro ao ler arquivo.");
            }
          };
          reader.readAsText(file);
          input.value = "";
        },
        createRoutine: () => {
          state.routineModalMode = "create";
          state.routineName = "";
          state.currentRoutine = {
            id: Date.now(),
            name: "",
            days: { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [] },
          };
          state.showRoutineModal = true;
          state.selectedWeekday = null;
          app.render();
        },
        editRoutine: (id, e) => {
          if (e) e.stopPropagation();
          const r = state.routines.find((r) => r.id === id);
          if (!r) return;
          state.currentRoutine = JSON.parse(JSON.stringify(r));
          state.routineName = r.name;
          state.routineModalMode = "edit";
          state.showRoutineModal = true;
          state.selectedWeekday = null;
          app.render();
        },

        // --- COLE ISSO DENTRO DE window.app ---
        
        editDayDirectly: (id, dayIndex) => {
            const r = state.routines.find(r => r.id === id);
            if(!r) return;
            
            // 1. Prepara a rotina para edição
            state.currentRoutine = JSON.parse(JSON.stringify(r));
            state.routineName = r.name;
            state.routineModalMode = 'edit';
            
            // 2. Define o dia que queremos editar
            state.selectedWeekday = dayIndex; 
            
            // 3. Carrega os exercícios desse dia na memória
            const days = state.currentRoutine.days[dayIndex];
            state.routineExercises = days.length > 0 ? JSON.parse(JSON.stringify(days)) : [];
            
            // 4. Abre o modal
            state.showRoutineModal = true;
            app.render();
        },

        // --------------------------------------

        deleteRoutine: (id, e) => {
          if (e) e.stopPropagation();
          if (confirm("Excluir rotina?")) {
            state.routines = state.routines.filter((r) => r.id !== id);
            saveToStorage();
            if (state.viewingRoutineId === id) state.viewingRoutineId = null;
            app.render();
          }
        },
        saveRoutine: () => {
          if (!state.routineName.trim()) return alert("Nome obrigatório");
          state.currentRoutine.name = state.routineName;
          const idx = state.routines.findIndex(
            (r) => r.id === state.currentRoutine.id
          );
          if (idx >= 0) state.routines[idx] = state.currentRoutine;
          else state.routines.push(state.currentRoutine);
          saveToStorage();
          state.showRoutineModal = false;
          app.render();
        },
        openDayEditor: (dayIndex) => {
          state.selectedWeekday = dayIndex;
          const days = state.currentRoutine.days[dayIndex];
          state.routineExercises =
            days.length > 0 ? JSON.parse(JSON.stringify(days)) : [];
          app.render();
        },
        addRoutineExercise: () => {
          state.routineExercises.push({
            type: "",
            name: "",
            customName: "",
            weight: "",
            reps: "",
            sets: "",
          });
          app.render();
        },
        removeRoutineExercise: (i) => {
          state.routineExercises.splice(i, 1);
          app.render();
        },
        updateRoutineExercise: (i, field, val) => {
          state.routineExercises[i][field] = val;
          if (field === "type") app.render();
        },
        saveDayExercises: () => {
          state.currentRoutine.days[state.selectedWeekday] =
            state.routineExercises.filter((ex) => ex.type && ex.name);
          if (state.routineModalMode === "edit") {
            const idx = state.routines.findIndex(
              (r) => r.id === state.currentRoutine.id
            );
            if (idx >= 0) {
              state.routines[idx] = state.currentRoutine;
              saveToStorage();
            }
          }
          state.selectedWeekday = null;
          app.render();
        },
        openRoutineView: (id) => {
          state.viewingRoutineId = id;
          state.viewingDay = null;
          app.render();
        },
        closeRoutineView: () => {
          state.viewingRoutineId = null;
          app.render();
        },
        openDayView: (idx) => {
          state.viewingDay = idx;
          app.render();
        },
        closeDayView: () => {
          state.viewingDay = null;
          app.render();
        },
        exportSingleRoutine: (id, e) => {
          if (e) e.stopPropagation();
          const routine = state.routines.find((r) => r.id === id);
          const url = URL.createObjectURL(
            new Blob(
              [
                JSON.stringify(
                  { type: "single_routine", data: routine },
                  null,
                  2
                ),
              ],
              { type: "application/json" }
            )
          );
          const link = document.createElement("a");
          link.href = url;
          link.download = `rotina.json`;
          link.click();
          URL.revokeObjectURL(url);
        },
      };

      function renderCalendar(root) {
        const { daysInMonth, startingDayOfWeek } = getDaysInMonth(state.currentDate);
        let gridHtml = "";
        for (let i = 0; i < startingDayOfWeek; i++)
            gridHtml += '<div class="aspect-square"></div>';

        for (let i = 1; i <= daysInMonth; i++) {
            const dateKey = formatDateKey(
                state.currentDate.getFullYear(),
                state.currentDate.getMonth(),
                i
            );
            const entry = state.gymData[dateKey];
            let classes =
                "aspect-square rounded-xl flex flex-col items-center justify-center font-bold text-sm transition-all active:scale-95 shadow-md ";
            let style = "background-color: #27272a; color: white;";
            if (entry) {
                if (entry.status === "rest") {
                    classes += "bg-blue-600/90 text-white";
                    style = "";
                } else if (entry.status === "missed" || entry.attended === false) {
                    classes += "bg-red-600/90 text-white";
                    style = "";
                } else if (entry.status === "attended" || entry.attended) {
                    classes += "bg-green-600/90 text-white";
                    style = "";
                }
            } else {
                classes += "hover:bg-zinc-900";
            }
            gridHtml += `<button onclick="app.dayClick(${i})" class="${classes}" style="${style}">${i}</button>`;
        }

        const btnLabel = state.isLogged ? "Sair" : "Entrar";
        const btnAction = state.isLogged
            ? "window.logoutGoogle()"
            : "window.loginGoogle()";

        // --- CORREÇÃO AQUI: SVG DO GOOGLE ---
        const googleIcon = `<svg class="w-4 h-4" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>`;

        let headerRightHtml = '';

        if (!state.isLogged) {
            // MODO DESLOGADO
            headerRightHtml = `
                <button onclick="window.loginGoogle()" class="flex items-center gap-2 px-4 py-2 rounded-full bg-white text-black text-xs font-bold shadow-lg active:scale-95 transition-transform h-9">
                    ${googleIcon}
                    <span>Entrar</span>
                </button>
            `;
        } else {
            // MODO LOGADO - CORREÇÃO DE ALINHAMENTO AQUI
            // Adicionei 'flex items-center' na div wrapper e no botão
            headerRightHtml = `
                <div class="relative z-50 flex items-center">
                    <button onclick="app.toggleProfileMenu()" class="relative flex items-center">
                        <img src="${state.userPhoto || 'https://ui-avatars.com/api/?name=User'}" class="w-9 h-9 rounded-full border-2 border-purple-600 cursor-pointer hover:opacity-80 transition-opacity block">
                        <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-black rounded-full"></div>
                    </button>

                    ${state.showProfileMenu ? `
                        <div class="absolute right-0 top-12 w-64 bg-zinc-900 border border-zinc-700 rounded-2xl shadow-2xl p-4 flex flex-col items-center gap-3 animate-in fade-in slide-in-from-top-2 duration-200">
                            <img src="${state.userPhoto}" class="w-16 h-16 rounded-full border-2 border-zinc-600">
                            <div class="text-center mb-2">
                                <p class="text-white font-bold text-sm">${escapeHtml(state.userName)}</p>
                                <p class="text-zinc-500 text-xs">Conta Google Conectada</p>
                            </div>
                            <button onclick="window.logoutGoogle()" class="w-full py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 text-xs font-bold rounded-lg border border-red-500/20 transition-colors flex items-center justify-center gap-2">
                                <i data-lucide="log-out" class="w-3 h-3"></i> Sair da Conta
                            </button>
                        </div>
                        <div class="fixed inset-0 z-[-1]" onclick="app.toggleProfileMenu()"></div>
                    ` : ''}
                </div>
            `;
        }

        root.innerHTML = `
            <div class="mb-6 pt-2 flex items-center justify-between relative">
                <div>
                    <h1 class="text-2xl font-bold text-purple-600 flex items-center gap-2">
                        <i data-lucide="dumbbell" class="text-purple-600"></i> GymDaily
                    </h1>
                </div>
                <div class="flex items-center gap-3">
                    ${headerRightHtml}
                    <button onclick="app.toggleFeatures()" class="w-9 h-9 flex items-center justify-center rounded-full bg-zinc-900 text-purple-500 border border-zinc-800 hover:border-purple-500 transition-colors active:scale-95">
                        <i data-lucide="info" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            
            <div class="bg-zinc-900 rounded-3xl p-4 mb-3 border border-zinc-800">
                <div class="flex items-center justify-between mb-4">
                    <button onclick="app.prevMonth()" class="p-2 rounded-full bg-zinc-800 hover:bg-purple-700 text-zinc-400 hover:text-white"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                    <h2 class="text-lg font-bold text-white capitalize">${
                        monthNames[state.currentDate.getMonth()]
                    } <span class="text-purple-600">${state.currentDate.getFullYear()}</span></h2>
                    <button onclick="app.nextMonth()" class="p-2 rounded-full bg-zinc-800 hover:bg-purple-700 text-zinc-400 hover:text-white"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                </div>
                <div class="grid grid-cols-7 gap-2 mb-2">
                    ${dayNames
                        .map(
                        (d) =>
                            `<div class="text-center text-zinc-500 font-bold text-xs uppercase tracking-wider">${d}</div>`
                        )
                        .join("")}
                </div>
                <div class="grid grid-cols-7 gap-2">${gridHtml}</div>
                <div class="flex justify-center gap-4 mt-4 text-xs font-medium text-zinc-400">
                    <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 bg-green-600/90 rounded-full"></div>Treino</div>
                    <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 bg-red-600/90 rounded-full"></div>Falta</div>
                    <div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 bg-blue-600/90 rounded-full"></div>Descanso</div>
                </div>
            </div>
            <div class="flex gap-3 mb-6">
                <button onclick="app.exportJSON()" class="flex-1 bg-zinc-900 hover:bg-purple-800 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2 border border-zinc-800 transition-all"><i data-lucide="download" class="w-4 h-4"></i> Exportar</button>
                <label class="flex-1 bg-zinc-900 hover:bg-purple-800 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2 cursor-pointer border border-zinc-800 transition-all"><i data-lucide="upload" class="w-4 h-4"></i> Importar<input type="file" accept=".json" class="hidden" onchange="app.importJSON(this)"></label>
            </div>
        `;
    }

      function renderRoutineTab(root) {
        const activeRoutine = state.viewingRoutineId
          ? state.routines.find((r) => r.id === state.viewingRoutineId)
          : null;

        if (!activeRoutine) {
          const listHtml = state.routines
            .map((r) => {
              const safeName = escapeHtml(r.name);
              const exerciseCount = r.days
                ? Object.values(r.days).reduce((acc, d) => acc + d.length, 0)
                : 0;

              return `<div class="group w-full rounded-2xl p-4 mb-3 bg-zinc-900 border border-zinc-800 hover:border-purple-900 transition-all relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-purple-700"></div>
                    <div class="flex justify-between items-center">
                        <div onclick="app.openRoutineView(${r.id})" class="flex-1 cursor-pointer">
                            <h3 class="text-lg font-bold text-white">${safeName}</h3>
                            <p class="text-zinc-500 text-xs mt-0.5">${exerciseCount} exercícios</p>
                        </div>
                        <div class="flex gap-1 ml-2">
                            <button onclick="app.exportSingleRoutine(${r.id}, event)" class="p-2 text-zinc-400 hover:text-white rounded-lg hover:bg-zinc-800">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </button>
                            <button onclick="app.editRoutine(${r.id}, event)" class="p-2 text-purple-400 hover:text-purple-300 rounded-lg hover:bg-purple-900/20">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                            <button onclick="app.deleteRoutine(${r.id}, event)" class="p-2 text-red-400 hover:text-red-300 rounded-lg hover:bg-red-900/20">
<i data-lucide="trash-2" class="w-4 h-4"></i>
</button>
</div>
</div>
</div>`;
            })
            .join("");

          root.innerHTML = `
            <div class="mb-6 pt-2">
                <h1 class="text-2xl font-bold text-white mb-1">Minhas fichas</h1>
                <p class="text-zinc-400 text-sm">Gerencie seus treinos</p>
            </div>
            <div class="flex gap-3 mb-3">
                <button onclick="app.createRoutine()" class="flex-1 bg-purple-700 hover:bg-purple-900 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all">
                    <i data-lucide="plus" class="w-5 h-5"></i> Criar ficha
                </button>
                <label class="px-4 bg-zinc-800 hover:bg-purple-700 text-white rounded-xl flex items-center justify-center cursor-pointer border border-zinc-700 transition-all">
                    <i data-lucide="upload" class="w-5 h-5"></i>
                    <input type="file" accept=".json" class="hidden" onchange="app.importJSON(this)">
                </label>
            </div>
            <div class="pb-20">
                ${listHtml}
                ${
                  state.routines.length === 0
                    ? `
                    <div class="text-center py-12 border-2 border-dashed border-zinc-800 rounded-2xl">
                        <i data-lucide="clipboard-list" class="w-12 h-12 text-zinc-600 mx-auto mb-3"></i>
                        <p class="text-zinc-500">Nenhuma rotina criada</p>
                    </div>
                `
                    : ""
                }
            </div>
        `;
        } else if (state.viewingDay === null) {
          const r = activeRoutine;
          const safeName = escapeHtml(r.name);

          const daysList = weekdays
            .map((day, idx) => {
              const len = r.days[idx].length;
              const isActive = len > 0;
              const cardClass = isActive
                ? "bg-zinc-900 border-purple-500/30 hover:border-purple-500 shadow-lg shadow-purple-900/10"
                : "bg-zinc-900/40 border-zinc-800/50 opacity-60 hover:opacity-100";
              const dayType = getDayType(r.days[idx]) || "Descanso";

              return `<button onclick="app.openDayView(${idx})" class="${cardClass} relative flex flex-col justify-between p-4 rounded-2xl border transition-all active:scale-95 text-left group min-h-[110px]">
                <div class="flex justify-between items-start w-full mb-2">
                    <span class="text-3xl font-black tracking-tighter ${
                      isActive ? "text-white" : "text-zinc-700"
                    }">${day.substring(0, 3).toUpperCase()}</span>
                    ${
                      isActive
                        ? `
                        <div class="bg-purple-500/20 text-purple-400 p-2 rounded-xl">
                            <i data-lucide="dumbbell" class="w-4 h-4"></i>
                        </div>
                    `
                        : `
                        <div class="p-2">
                            <i data-lucide="coffee" class="w-4 h-4 text-zinc-700"></i>
                        </div>
                    `
                    }
                </div>
                <div>
                    <p class="text-[10px] font-bold uppercase tracking-widest ${
                      isActive ? "text-purple-400" : "text-zinc-600"
                    }">${dayType}</p>
                    ${
                      isActive
                        ? `<p class="text-xs text-zinc-400 mt-0.5">${len} exercícios</p>`
                        : ""
                    }
                </div>
            </button>`;
            })
            .join("");

          root.innerHTML = `
            <div class="flex items-center gap-3 mb-6 pt-2">
                <button onclick="app.closeRoutineView()" class="p-2 rounded-full bg-purple-700 hover:bg-purple-900 border border-zinc-700">
                    <i data-lucide="arrow-left" class="text-white w-5 h-5"></i>
                </button>
                <div class="flex-1 overflow-hidden">
                    <h1 class="text-xl font-bold text-white truncate leading-tight">${safeName}</h1>
                    <p class="text-xs text-zinc-500">Visão Semanal</p>
                </div>
                <button onclick="app.editRoutine(${r.id})" class="flex items-center gap-2 text-zinc-100 text-xs font-bold px-4 py-2 bg-purple-700 rounded-full hover:bg-purple-900 transition-colors">
                    <i data-lucide="pencil" class="w-3 h-3"></i> Editar
                </button>
            </div>
            <div class="grid grid-cols-2 gap-3 pb-24">${daysList}</div>
        `;
        } else {
          const r = activeRoutine;
          const d = state.viewingDay;
          const exercises = r.days[d];
          const dayType = getDayType(exercises);

          const exList =
            exercises.length === 0
              ? `
            <div class="text-center py-20 text-zinc-500">
                <i data-lucide="coffee" class="w-12 h-12 mx-auto mb-3 opacity-20"></i>
                <p>Nenhum exercício neste dia</p>
                <button onclick="app.editDayDirectly(${r.id}, ${d})" class="text-purple-400 mt-4 text-sm hover:underline">Adicionar Exercícios</button>
            </div>
        `
              : exercises
                  .map((ex, i) => {
                    const exName =
                      ex.name === "Outro"
                        ? escapeHtml(ex.customName)
                        : escapeHtml(ex.name);
                    const gifUrl =
                      exerciseGifs[ex.name] ||
                      exerciseGifs[ex.name.replace(" 45°", "")] ||
                      exerciseGifs[ex.customName];

                    const mediaHtml = gifUrl
  ? `<img src="${escapeHtml(gifUrl)}" 
          onerror="this.src='https://placehold.co/200x200/27272a/a855f7?text=Erro+no+GIF'"
          onclick="app.openImage('${escapeHtml(gifUrl)}')" 
          class="w-16 h-16 rounded-xl object-cover border border-zinc-700 flex-shrink-0 bg-black cursor-zoom-in hover:opacity-80 transition-opacity">`
  : `<div class="w-16 h-16 rounded-xl bg-zinc-800 flex items-center justify-center flex-shrink-0 text-purple-500 font-bold border border-zinc-700 text-lg">${i + 1}</div>`;

                    return `<div class="flex gap-4 p-3 rounded-2xl mb-3 bg-zinc-900 border border-zinc-800 items-center">
                ${mediaHtml}
                <div class="flex-1">
                    <h3 class="text-purple-500 font-bold text-base leading-tight mb-2.5">${exName}</h3>
                    <div class="flex flex-wrap gap-2 text-xs">
                        <span class="bg-blue-900/20 px-2.5 py-1 rounded-md text-blue-400 font-bold border border-blue-500/30">${escapeHtml(
                          ex.sets
                        )} Séries</span>
                        <span class="bg-emerald-900/20 px-2.5 py-1 rounded-md text-emerald-400 font-bold border border-emerald-500/30">${escapeHtml(
                          ex.reps
                        )} Repetições</span>
                        ${
                          ex.weight
                            ? `<span class="bg-yellow-900/20 px-2.5 py-1 rounded-md text-yellow-500 font-mono font-bold border border-yellow-500/30">${escapeHtml(
                                ex.weight
                              )}kg</span>`
                            : ""
                        }
                    </div>
                </div>
            </div>`;
                  })
                  .join("");

          root.innerHTML = `
                <div class="flex items-center gap-3 mb-4 pt-2">
                    <button onclick="app.closeDayView()" class="p-2 rounded-full bg-purple-700 hover:bg-purple-900 border border-zinc-700">
                        <i data-lucide="arrow-left" class="text-white w-5 h-5"></i>
                    </button>
                    
                    <div class="flex-1">
                        <h1 class="text-xl font-bold text-white">${weekdays[d]}</h1>
                        <p class="text-xs text-purple-400 font-semibold uppercase tracking-wider">${getDayType(exercises)}</p>
                    </div>

                    <button onclick="app.editDayDirectly(${r.id}, ${d})" class="flex items-center gap-2 text-purple-400 text-xs font-bold px-4 py-2 bg-purple-900/30 border border-purple-500/30 rounded-full hover:bg-purple-900/50 transition-colors">
                        <i data-lucide="pencil" class="w-3 h-3"></i> Editar
                    </button>
                    </div>
                <div class="pb-20">${exList}</div>
            `;
        }
      }

      function renderCalendarModal(root) {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 flex items-center justify-center p-4 z-50";
        modal.style.backgroundColor = "rgba(0, 0, 0, 0.8)";
        modal.style.backdropFilter = "blur(4px)";

        let content = "";

        if (state.modalMode === "select") {
          content = `
                <h3 class="text-lg font-bold text-white text-center mb-6">Como foi hoje?</h3>
                <div class="flex flex-col gap-3">
                    <button onclick="app.setModalMode('attended')" class="bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-3 transition-transform active:scale-95">
                        <i data-lucide="check-circle-2" class="w-6 h-6"></i> Treinei!
                    </button>
                    <button onclick="app.setModalMode('rest')" class="bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-3 transition-transform active:scale-95">
                        <i data-lucide="coffee" class="w-6 h-6"></i> Descansei
                    </button>
                    <button onclick="app.setModalMode('missed')" class="bg-red-600 hover:bg-red-700 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-3 transition-transform active:scale-95">
                        <i data-lucide="x-circle" class="w-6 h-6"></i> Faltei
                    </button>
                </div>
            `;
        } else if (state.modalMode === "attended") {
          const routinesOptions = state.routines
            .map(
              (r) => `<option value="${r.id}">${escapeHtml(r.name)}</option>`
            )
            .join("");

          const exHtml = state.exercises
            .map((ex, i) => {
              const exerciseOptions = (exercisesList[state.workoutType] || [])
                .map(
                  (opt) =>
                    `<option value="${escapeHtml(opt)}" ${
                      ex.name === opt ? "selected" : ""
                    }>${escapeHtml(opt)}</option>`
                )
                .join("");

              return `<div class="p-4 rounded-xl mb-3 space-y-3 bg-zinc-900 border border-zinc-700 relative">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-zinc-400 text-xs uppercase tracking-wider">Exercício ${
                          i + 1
                        }</span>
                        <button onclick="app.removeExercise(${i})" class="text-red-500 p-1">
                            <i data-lucide="trash" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <select onchange="app.updateExercise(${i}, 'name', this.value)" class="w-full p-3 rounded-lg bg-black border border-zinc-700 text-white focus:border-purple-500 outline-none">
                        <option value="">Selecione...</option>
                        ${exerciseOptions}
                    </select>
                    ${
                      ex.name === "Outro"
                        ? `
                        <input type="text" value="${escapeHtml(
                          ex.customName
                        )}" oninput="app.updateExercise(${i}, 'customName', this.value)" class="w-full p-3 rounded-lg bg-black border border-zinc-700 text-white focus:border-purple-500 outline-none" placeholder="Nome do exercício">
                    `
                        : ""
                    }
                    <div class="grid grid-cols-3 gap-3">
                        <div class="relative">
                            <input type="number" value="${escapeHtml(
                              ex.weight
                            )}" oninput="app.updateExercise(${i}, 'weight', this.value)" class="w-full p-3 rounded-lg bg-black border border-zinc-700 text-white focus:border-purple-500 outline-none pl-8" placeholder="0">
                            <span class="absolute left-3 top-3 text-zinc-500 text-xs">Kg</span>
                        </div>
                        <div class="relative">
                            <input type="number" value="${escapeHtml(
                              ex.sets
                            )}" oninput="app.updateExercise(${i}, 'sets', this.value)" class="w-full p-3 rounded-lg bg-black border border-zinc-700 text-white focus:border-purple-500 outline-none pl-8" placeholder="0">
                            <span class="absolute left-3 top-3 text-zinc-500 text-xs">Sér</span>
                        </div>
                        <div class="relative">
                            <input type="number" value="${escapeHtml(
                              ex.reps
                            )}" oninput="app.updateExercise(${i}, 'reps', this.value)" class="w-full p-3 rounded-lg bg-black border border-zinc-700 text-white focus:border-purple-500 outline-none pl-8" placeholder="0">
                            <span class="absolute left-3 top-3 text-zinc-500 text-xs">Rep</span>
                        </div>
                    </div>
                </div>`;
            })
            .join("");

          content = `<div class="space-y-5">
                ${
                  state.routines.length > 0
                    ? `
                    <div class="bg-purple-900/20 p-3 rounded-xl border border-purple-500/30">
                        <label class="block text-xs font-bold text-purple-300 mb-2 uppercase">Carregar da Rotina</label>
                        <select onchange="app.loadRoutineIntoSession(this.value)" class="w-full p-2 rounded-lg bg-black border border-purple-500/50 text-white text-sm">
                            <option value="">Selecione...</option>
                            ${routinesOptions}
                        </select>
                    </div>
                `
                    : ""
                }
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-zinc-500 mb-1.5 uppercase">Tipo</label>
                        <select onchange="app.updateForm('workoutType', this.value)" class="w-full p-3 rounded-xl bg-zinc-900 border border-zinc-700 text-white focus:border-purple-500 outline-none">
                            <option value="">Selecione...</option>
                            <option value="inferior" ${
                              state.workoutType === "inferior" ? "selected" : ""
                            }>Inferior</option>
                            <option value="superior" ${
                              state.workoutType === "superior" ? "selected" : ""
                            }>Superior</option>
                            <option value="mesclado" ${
                              state.workoutType === "mesclado" ? "selected" : ""
                            }>Mesclado</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-zinc-500 mb-1.5 uppercase">Peso (kg)</label>
                        <input type="number" step="0.1" value="${escapeHtml(
                          state.weight
                        )}" oninput="app.updateForm('weight', this.value)" class="w-full p-3 rounded-xl bg-zinc-900 border border-zinc-700 text-white focus:border-purple-500 outline-none">
                    </div>
                </div>
                ${
                  state.workoutType
                    ? `
                    <div class="flex justify-between items-center pt-2">
                        <label class="text-sm font-bold text-white">Exercícios</label>
                        <button onclick="app.addExercise()" class="text-purple-400 font-bold text-sm hover:text-purple-300">+ Adicionar</button>
                    </div>
                    <div class="max-h-[40vh] overflow-y-auto pr-1">${exHtml}</div>
                `
                    : ""
                }
                <div>
                    <label class="block text-xs font-bold text-zinc-500 mb-1.5 uppercase">Observações</label>
                    <textarea oninput="app.updateForm('notes', this.value)" class="w-full p-3 rounded-xl bg-zinc-900 border border-zinc-700 text-white focus:border-purple-500 outline-none" rows="2" placeholder="Como foi o treino?">${escapeHtml(
                      state.notes
                    )}</textarea>
                </div>
                <button onclick="app.saveData('attended')" class="w-full bg-purple-700 hover:bg-purple-600 text-white py-4 rounded-xl font-bold">Salvar Treino</button>
                ${
                  state.gymData[state.selectedDay.dateKey]
                    ? `
                    <button onclick="app.deleteEntry()" class="w-full text-red-400 font-semibold py-2">Excluir Registro</button>
                `
                    : ""
                }
            </div>`;
        } else if (state.modalMode === "rest") {
          content = `<div class="text-center py-6">
                <div class="w-20 h-20 bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="coffee" class="w-10 h-10 text-blue-400"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Dia de Descanso</h3>
                <p class="text-zinc-400 text-sm mb-6">O descanso é essencial para a hipertrofia e recuperação.</p>
                <div class="mb-6 text-left">
                    <label class="block text-xs font-bold text-zinc-500 mb-1.5 uppercase">Observação (Opcional)</label>
                    <textarea oninput="app.updateForm('notes', this.value)" class="w-full p-3 rounded-xl bg-zinc-900 border border-zinc-700 text-white focus:border-blue-500 outline-none" rows="2" placeholder="Ex: Senti dores musculares...">${escapeHtml(
                      state.notes
                    )}</textarea>
                </div>
                <button onclick="app.saveData('rest')" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold">Confirmar Descanso</button>
                ${
                  state.gymData[state.selectedDay.dateKey]
                    ? `
                    <button onclick="app.deleteEntry()" class="w-full text-red-400 font-semibold py-3 mt-2">Excluir Registro</button>
                `
                    : ""
                }
            </div>`;
        } else {
          const reasonOptions = missedReasons
            .map(
              (r) => `
                <label class="flex items-center p-4 border border-zinc-700 rounded-xl cursor-pointer bg-zinc-900 hover:bg-zinc-800 transition-colors ${
                  state.missedReason === r ? "border-red-500 bg-red-900/10" : ""
                }">
                    <input type="radio" name="reason" value="${escapeHtml(
                      r
                    )}" ${
                state.missedReason === r ? "checked" : ""
              } onchange="app.updateForm('missedReason', this.value)" class="mr-3 w-5 h-5 accent-red-600">
                    <span class="text-white text-sm font-medium">${escapeHtml(
                      r
                    )}</span>
                </label>
            `
            )
            .join("");

          content = `<div class="space-y-4">
                <label class="block text-xs font-bold text-zinc-500 mb-2 uppercase">Motivo da Falta</label>
                <div class="space-y-2">${reasonOptions}</div>
                ${
                  state.missedReason === "Outro"
                    ? `
                    <textarea oninput="app.updateForm('customReason', this.value)" class="w-full p-3 rounded-xl bg-zinc-900 border border-zinc-700 text-white focus:border-red-500 outline-none" placeholder="Descreva o motivo...">${escapeHtml(
                      state.customReason
                    )}</textarea>
                `
                    : ""
                }
                <button onclick="app.saveData('missed')" class="w-full bg-red-600 hover:bg-red-500 text-white py-4 rounded-xl font-bold mt-4">Confirmar Falta</button>
                ${
                  state.gymData[state.selectedDay.dateKey]
                    ? `
                    <button onclick="app.deleteEntry()" class="w-full text-red-400 font-semibold py-2">Excluir Registro</button>
                `
                    : ""
                }
            </div>`;
        }

        modal.innerHTML = `
            <div class="bg-black w-full max-w-[450px] rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] border border-zinc-800">
                <div class="flex justify-between items-center p-5 border-b border-zinc-800 bg-zinc-900">
                    <div>
                        <h3 class="text-xl font-bold text-white">Dia ${
                          state.selectedDay.day
                        }</h3>
                        <p class="text-zinc-500 text-xs uppercase font-bold tracking-widest">${
                          monthNames[state.currentDate.getMonth()]
                        }</p>
                    </div>
                    <button onclick="app.closeModal()" class="p-2 rounded-full bg-zinc-800 hover:bg-zinc-700">
                        <i data-lucide="x" class="w-5 h-5 text-white"></i>
                    </button>
                </div>
                <div class="p-5 overflow-y-auto custom-scrollbar">${content}</div>
            </div>
        `;

        root.appendChild(modal);
      }

      function renderRoutineModal(root) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 flex items-end sm:items-center justify-center sm:p-4 z-50';
        modal.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
        modal.style.backdropFilter = 'blur(4px)';
        
        let content = '';

        if (state.selectedWeekday === null) {
            // --- TELA 1: SELEÇÃO DE DIAS ---
            const weekdayButtons = weekdays.map((d, i) => {
                const count = state.currentRoutine.days[i].length;
                const hasExercises = count > 0;
                
                // Sem sombras, design flat
                const cardClass = hasExercises 
                    ? 'bg-zinc-900 border-purple-500' // Ativo
                    : 'bg-zinc-900/40 border-zinc-800 hover:border-zinc-700 opacity-70'; // Inativo
                
                const textClass = hasExercises ? 'text-white' : 'text-zinc-600';
                const subTextClass = hasExercises ? 'text-purple-400' : 'text-zinc-600';

                return `
                <button onclick="app.openDayEditor(${i})" class="${cardClass} relative flex flex-col justify-between p-4 rounded-2xl border transition-all active:scale-95 text-left group h-28">
                    <div class="flex justify-between items-start w-full">
                        <span class="text-3xl font-black tracking-tighter ${textClass}">
                            ${d.substring(0,3).toUpperCase()}
                        </span>
                        ${hasExercises 
                            ? `<div class="bg-purple-500/20 text-purple-400 p-1.5 rounded-lg"><i data-lucide="dumbbell" class="w-4 h-4"></i></div>` 
                            : `<div class="p-1.5"><i data-lucide="plus" class="w-4 h-4 text-zinc-700 group-hover:text-zinc-500"></i></div>`
                        }
                    </div>
                    <div>
                        <p class="text-[10px] font-bold uppercase tracking-widest ${subTextClass}">${hasExercises ? 'Treino' : 'Vazio'}</p>
                        <p class="text-xs text-zinc-500 mt-0.5">${hasExercises ? `${count} exercícios` : 'Toque p/ adicionar'}</p>
                    </div>
                </button>
                `;
            }).join('');

            content = `
                <div class="mb-6">
                    <label class="block text-xs font-bold text-zinc-500 mb-2 uppercase tracking-wider">Nome da Ficha</label>
                    <input type="text" value="${escapeHtml(state.routineName)}" oninput="state.routineName = this.value" class="w-full p-4 rounded-xl bg-black border border-zinc-800 text-white focus:border-purple-500 outline-none text-lg font-bold placeholder-zinc-700 transition-colors" placeholder="Ex: Hipertrofia">
                </div>
                <div class="flex flex-col mb-2 max-h-[60vh] overflow-y-auto pr-1 custom-scrollbar">
                    <label class="block text-xs font-bold text-zinc-500 mb-3 uppercase tracking-wider">Configurar Dias</label>
                    <div class="grid grid-cols-2 gap-3 pb-4">
                        ${weekdayButtons}
                    </div>
                </div>
                <div class="pt-2 border-t border-zinc-800">
                    <button onclick="app.saveRoutine()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-4 rounded-xl font-bold transition-all active:scale-95">
                        Salvar Ficha
                    </button>
                </div>
            `;
        } else {
            // --- TELA 2: LISTA DE EXERCÍCIOS ---
            const exList = state.routineExercises.map((ex, i) => {
                const gifUrl = exerciseGifs[ex.name] || exerciseGifs[ex.name.replace(' 45°', '')] || exerciseGifs[ex.customName] || exerciseGifs['Outro'];
                const displayTitle = ex.name === 'Outro' ? (ex.customName || 'Personalizado') : ex.name;

                return `
                <div class="p-3 rounded-2xl bg-zinc-900/50 border border-zinc-800 mb-3 relative group">
                    <div class="flex items-start gap-3 mb-3">
                        <div onclick="app.openPicker(${i})" class="w-14 h-14 shrink-0 rounded-xl bg-black border border-zinc-700 overflow-hidden relative cursor-pointer hover:border-purple-500 transition-colors">
                            <img src="${gifUrl}" class="w-full h-full object-cover opacity-80" onerror="this.src='https://placehold.co/100x100/27272a/FFF?text=IMG'">
                            <div class="absolute inset-0 flex items-center justify-center bg-black/30">
                                <i data-lucide="refresh-cw" class="w-4 h-4 text-white opacity-70"></i>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <div onclick="app.openPicker(${i})" class="cursor-pointer">
                                    <span class="text-[10px] font-bold text-purple-500 uppercase tracking-wider block mb-0.5">Exercício ${i+1}</span>
                                    <h4 class="text-white font-bold text-sm truncate leading-tight">${escapeHtml(displayTitle)}</h4>
                                </div>
                                <button onclick="app.removeRoutineExercise(${i})" class="text-red-500/40 hover:text-red-500 p-1 -mr-2"><i data-lucide="x" class="w-4 h-4"></i></button>
                            </div>
                            ${ex.name === 'Outro' ? `<input type="text" value="${escapeHtml(ex.customName)}" oninput="app.updateRoutineExercise(${i}, 'customName', this.value)" class="mt-2 w-full bg-black/50 border border-zinc-700 rounded-lg px-2 py-1 text-xs text-white focus:border-purple-500 outline-none" placeholder="Nome...">` : ''}
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="relative">
                            <input type="number" value="${escapeHtml(ex.sets)}" oninput="app.updateRoutineExercise(${i}, 'sets', this.value)" class="w-full p-2.5 rounded-lg bg-black border border-zinc-800 text-white text-center focus:border-blue-500 outline-none font-bold text-sm" placeholder="0">
                            <span class="absolute top-[-6px] left-1/2 -translate-x-1/2 text-[8px] font-bold text-blue-500 bg-zinc-900 px-1 uppercase">Séries</span>
                        </div>
                        <div class="relative">
                            <input type="number" value="${escapeHtml(ex.reps)}" oninput="app.updateRoutineExercise(${i}, 'reps', this.value)" class="w-full p-2.5 rounded-lg bg-black border border-zinc-800 text-white text-center focus:border-emerald-500 outline-none font-bold text-sm" placeholder="0">
                            <span class="absolute top-[-6px] left-1/2 -translate-x-1/2 text-[8px] font-bold text-emerald-500 bg-zinc-900 px-1 uppercase">Reps</span>
                        </div>
                        <div class="relative">
                            <input type="number" value="${escapeHtml(ex.weight)}" oninput="app.updateRoutineExercise(${i}, 'weight', this.value)" class="w-full p-2.5 rounded-lg bg-black border border-zinc-800 text-white text-center focus:border-yellow-500 outline-none font-bold text-sm" placeholder="-">
                            <span class="absolute top-[-6px] left-1/2 -translate-x-1/2 text-[8px] font-bold text-yellow-500 bg-zinc-900 px-1 uppercase">Carga</span>
                        </div>
                    </div>
                </div>
            `}).join('');

            content = `
                <div class="flex justify-between items-center mb-4 border-b border-zinc-800 pb-4">
                    <div>
                        <h4 class="text-2xl font-bold text-white">${weekdays[state.selectedWeekday]}</h4>
                        <p class="text-zinc-500 text-xs">Adicione os exercícios deste dia</p>
                    </div>
                    <button onclick="app.openPicker()" class="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all active:scale-95">
                        <i data-lucide="plus" class="w-4 h-4"></i> Adicionar
                    </button>
                </div>
                
                <div class="mb-2 max-h-[60vh] overflow-y-auto pr-1 custom-scrollbar">
                    ${state.routineExercises.length ? exList : `
                        <div onclick="app.openPicker()" class="flex flex-col items-center justify-center py-12 text-zinc-600 border-2 border-dashed border-zinc-800 rounded-2xl cursor-pointer hover:border-purple-500/50 hover:text-purple-500 transition-colors">
                            <i data-lucide="dumbbell" class="w-10 h-10 mb-2 opacity-30"></i>
                            <p class="text-sm font-medium">Toque para adicionar</p>
                        </div>
                    `}
                </div>
                
                <div class="pt-2 border-t border-zinc-800">
                    <button onclick="app.saveDayExercises()" class="w-full bg-white hover:bg-zinc-200 text-black py-4 rounded-xl font-bold transition-all active:scale-95">
                        Salvar Treino
                    </button>
                </div>
            `;
        }

        modal.innerHTML = `
            <div class="bg-zinc-950 w-full sm:w-[500px] sm:rounded-3xl rounded-t-3xl shadow-2xl flex flex-col max-h-[95vh] border-t border-zinc-800 sm:border">
                <div class="flex justify-between items-center p-5 border-b border-zinc-800 bg-zinc-950 rounded-t-3xl">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        ${state.routineModalMode === 'create' ? '<i data-lucide="plus-circle" class="text-purple-500"></i> Nova Ficha' : '<i data-lucide="pencil" class="text-purple-500"></i> Editar Ficha'}
                    </h3>
                    <button onclick="state.showRoutineModal = false; state.selectedWeekday = null; app.render()" class="p-2 rounded-full bg-zinc-900 hover:bg-zinc-800 text-zinc-400 hover:text-white transition-colors border border-zinc-800"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="p-5 overflow-y-auto custom-scrollbar bg-zinc-950">${content}</div>
            </div>
        `;
        root.appendChild(modal);
    }

    // --- ATUALIZA SÓ O GRID (SEM FECHAR TECLADO) ---
    function updatePickerGridOnly() {
        const container = document.getElementById('picker-grid-container');
        if (!container) return;

        // 1. Lógica de Filtro
        let list = [];
        if (state.pickerFilter === 'todos') {
            const all = [...exercisesList.cardio, ...exercisesList.inferior, ...exercisesList.superior];
            list = [...new Set(all)]; 
        } else {
            list = exercisesList[state.pickerFilter] || [];
        }

        // 2. Lógica de Busca
        if (state.pickerSearch) {
            const term = state.pickerSearch.toLowerCase();
            list = list.filter(ex => ex.toLowerCase().includes(term));
        }

        // 3. Gera o HTML
        if (list.length === 0) {
            container.innerHTML = `
                <div class="text-center text-zinc-500 mt-20 flex flex-col items-center">
                    <i data-lucide="frown" class="w-10 h-10 mb-2 opacity-50"></i>
                    <p>Nenhum exercício encontrado</p>
                </div>`;
        } else {
            container.innerHTML = `<div class="grid grid-cols-3 gap-3 pb-20">` + list.map(exName => {
                const gifUrl = exerciseGifs[exName] || exerciseGifs[exName.replace(' 45°', '')] || exerciseGifs['Outro'];
                const realType = exercisesList.inferior.includes(exName) ? 'inferior' : (exercisesList.cardio.includes(exName) ? 'cardio' : 'superior');
                
                // --- AQUI ESTÁ A MÁGICA DA BORDA ROXA ---
                const isUltimate = ultimateList.includes(exName);
                const borderClass = isUltimate 
                    ? 'border-purple-500 border-2 shadow-[0_0_15px_rgba(168,85,247,0.4)]' // Roxo brilhante
                    : 'border-zinc-800'; // Normal
                // ----------------------------------------

                return `
                    <button onclick="app.selectExerciseFromPicker('${escapeHtml(exName)}', '${realType}')" class="flex flex-col gap-2 group active:scale-95 transition-transform text-left">
                        <div class="aspect-square w-full rounded-2xl overflow-hidden border ${borderClass} group-hover:border-purple-500 transition-colors relative bg-zinc-900">
                            <img src="${gifUrl}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100" loading="lazy">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent"></div>
                            ${isUltimate ? '<div class="absolute top-2 right-2 w-2 h-2 bg-purple-500 rounded-full shadow-lg shadow-purple-500"></div>' : ''}
                            <div class="absolute bottom-2 left-2 right-2">
                                <p class="text-white text-[10px] font-bold leading-tight text-center line-clamp-2">${escapeHtml(exName)}</p>
                            </div>
                        </div>
                    </button>
                `;
            }).join('') + `</div>`;
        }
        
        // Re-cria ícones se necessário (para o ícone de triste)
        lucide.createIcons();
    }

    // --- NOVO RENDERIZADOR: SELETOR VISUAL DE EXERCÍCIOS (CORRIGIDO FINAL) ---
    function renderExercisePicker(root) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[60] bg-black/95 flex flex-col animate-in fade-in duration-200';
        
        // Lógica de Filtro
        let list = [];
        if (state.pickerFilter === 'todos') {
            const all = [...exercisesList.cardio, ...exercisesList.inferior, ...exercisesList.superior];
            list = [...new Set(all)]; 
        } else {
            list = exercisesList[state.pickerFilter] || [];
        }

        // Lógica de Busca
        if (state.pickerSearch) {
            const term = state.pickerSearch.toLowerCase();
            list = list.filter(ex => ex.toLowerCase().includes(term));
        }

        // Renderiza Grid
        const gridHtml = list.map(exName => {
            const gifUrl = exerciseGifs[exName] || exerciseGifs[exName.replace(' 45°', '')] || exerciseGifs['Outro'];
            
            let realType = 'superior'; 
            if (exercisesList.inferior.includes(exName)) realType = 'inferior';
            else if (exercisesList.cardio.includes(exName)) realType = 'cardio';

            const isUltimate = typeof ultimateList !== 'undefined' && ultimateList.includes(exName);
            // Ajuste na borda: sem sombra, apenas borda sólida
            const borderClass = isUltimate ? 'border-purple-500 border-2' : 'border-zinc-800';

            return `
                <button onclick="app.selectExerciseFromPicker('${escapeHtml(exName)}', '${realType}')" class="flex flex-col gap-2 group active:scale-95 transition-transform text-left">
                    <div class="aspect-square w-full rounded-2xl overflow-hidden border ${borderClass} group-hover:border-purple-500 transition-colors relative bg-zinc-900">
                        <img src="${gifUrl}" 
                             class="w-full h-full object-cover opacity-80 group-hover:opacity-100" 
                             loading="lazy"
                             onerror="this.onerror=null; this.src='https://placehold.co/100x100/27272a/FFF?text=IMG';">
                        
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent"></div>
                        
                        ${isUltimate ? '<div class="absolute top-2 right-2 w-2 h-2 bg-purple-500 rounded-full"></div>' : ''}
                        
                        <div class="absolute bottom-2 left-2 right-2">
                            <p class="text-white text-[10px] font-bold leading-tight text-center line-clamp-2">${escapeHtml(exName)}</p>
                        </div>
                    </div>
                </button>
            `;
        }).join('');

        modal.innerHTML = `
            <div class="p-4 bg-zinc-900 border-b border-zinc-800 flex items-center gap-3 shrink-0 z-10">
                <button onclick="app.closePicker()" class="p-2 -ml-2 rounded-full hover:bg-zinc-800 text-zinc-400">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <div class="flex-1 relative">
                    <i data-lucide="search" class="w-4 h-4 text-zinc-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                    <input type="text" 
                        value="${escapeHtml(state.pickerSearch)}"
                        oninput="app.setPickerSearch(this.value)" 
                        placeholder="Buscar..." 
                        class="w-full bg-zinc-800 border border-zinc-700 rounded-full py-2.5 pl-10 pr-4 text-base text-white focus:border-purple-500 outline-none placeholder-zinc-500"
                    >
                </div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar">
                <div class="px-4 pt-4 pb-2 grid grid-cols-4 gap-2 sticky top-0 bg-black/95 backdrop-blur-sm z-10">
                    <button onclick="app.setPickerFilter('inferior')" class="py-2.5 rounded-xl text-xs font-bold transition-all border ${state.pickerFilter === 'inferior' ? 'bg-purple-600 text-white border-purple-500' : 'bg-zinc-900 text-zinc-500 border-zinc-800 hover:bg-zinc-800'}">Inferior</button>
                    <button onclick="app.setPickerFilter('superior')" class="py-2.5 rounded-xl text-xs font-bold transition-all border ${state.pickerFilter === 'superior' ? 'bg-purple-600 text-white border-purple-500' : 'bg-zinc-900 text-zinc-500 border-zinc-800 hover:bg-zinc-800'}">Superior</button>
                    <button onclick="app.setPickerFilter('cardio')" class="py-2.5 rounded-xl text-xs font-bold transition-all border ${state.pickerFilter === 'cardio' ? 'bg-purple-600 text-white border-purple-500' : 'bg-zinc-900 text-zinc-500 border-zinc-800 hover:bg-zinc-800'}">Cardio</button>
                    <button onclick="app.setPickerFilter('todos')" class="py-2.5 rounded-xl text-xs font-bold transition-all border ${state.pickerFilter === 'todos' ? 'bg-purple-600 text-white border-purple-500' : 'bg-zinc-900 text-zinc-500 border-zinc-800 hover:bg-zinc-800'}">Todos</button>
                </div>

                <div id="picker-grid-container" class="p-4 pt-2">
                    ${list.length > 0 
                        ? `<div class="grid grid-cols-3 gap-3 pb-20">${gridHtml}</div>`
                        : `<div class="text-center text-zinc-500 mt-20 flex flex-col items-center"><i data-lucide="frown" class="w-10 h-10 mb-2 opacity-50"></i><p>Nada encontrado</p></div>`
                    }
                </div>
            </div>
        `;
        root.appendChild(modal);
    }

      function renderFeaturesModal(root) {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200";

        const features = [
          {
            icon: "calendar-check",
            title: "Registro Diário",
            desc: "Marque seus dias como Treino, Descanso ou Falta para acompanhar sua rotina de treino.",
          },
          {
            icon: "clipboard-list",
            title: "Criação de Fichas",
            desc: "Monte treinos personalizados (ABC, ABCD...) e organize por dias da semana.",
          },
          {
            icon: "play-circle",
            title: "GIFs Demonstrativos",
            desc: "Veja a execução correta dos exercícios clicando na miniatura animada.",
          },
          {
            icon: "bar-chart-3",
            title: "Controle de Carga",
            desc: "Registre peso, séries e repetições para acompanhar sua progressão.",
          },
          {
            icon: "save",
            title: "Backup & Restore",
            desc: "Exporte seus dados para um arquivo seguro e restaure quando quiser. Seus dados são seus.",
          },
          {
            icon: "smartphone",
            title: "Design Mobile",
            desc: "Interface pensada para uso fácil no celular.",
          },
        ];

        const featuresHtml = features
          .map(
            (f) => `
            <div class="flex gap-4 p-4 rounded-2xl bg-black/40 border border-zinc-800/50 hover:border-purple-500/30 transition-colors">
                <div class="w-10 h-10 rounded-full bg-purple-900/20 flex items-center justify-center text-purple-400 flex-shrink-0">
                    <i data-lucide="${f.icon}" class="w-5 h-5"></i>
                </div>
                <div>
                    <h4 class="text-white font-bold text-sm mb-1">${escapeHtml(
                      f.title
                    )}</h4>
                    <p class="text-zinc-500 text-xs leading-relaxed">${escapeHtml(
                      f.desc
                    )}</p>
                </div>
            </div>
        `
          )
          .join("");

        modal.innerHTML = `
            <div class="bg-zinc-900 w-full max-w-md rounded-3xl border border-zinc-800 shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
                <div class="p-6 border-b border-zinc-800 bg-zinc-900">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <i data-lucide="sparkles" class="text-purple-500"></i> Funcionalidades
                        </h3>
                        <button onclick="app.toggleFeatures()" class="p-2 rounded-full bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <p class="text-zinc-400 text-sm">Tudo o que o GymDaily pode fazer por você.</p>
                </div>
                <div class="p-4 overflow-y-auto custom-scrollbar space-y-3">
                    ${featuresHtml}
</div>
<div class="p-4 border-t border-zinc-800 bg-zinc-900">
<button onclick="app.toggleFeatures()" class="w-full bg-purple-700 hover:bg-purple-900 text-white py-3.5 rounded-xl font-bold transition-all active:scale-95">
Entendi, vamos treinar!
</button>
</div>
</div>
`;

        root.appendChild(modal);
      }

      function renderImageModal(root) {
        const modal = document.createElement("div");
        modal.className = "fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-4 animate-in zoom-in duration-200";
        modal.onclick = () => app.closeImage();

        modal.innerHTML = `
            <div class="relative max-w-full max-h-full">
                <button onclick="app.closeImage()" class="absolute -top-12 right-0 p-2 text-white bg-zinc-800 rounded-full">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                <img src="${state.viewingImage}" class="max-w-full max-h-[80vh] rounded-2xl shadow-2xl border border-zinc-800 object-contain">
                <p class="text-zinc-500 text-center mt-4 text-xs font-medium">Toque fora para fechar</p>
            </div>
        `;
        root.appendChild(modal);
        lucide.createIcons();
      }

      app.render();
    </script>
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("./sw.js")
            .then(() => console.log("App instalado com sucesso"))
            .catch((err) => console.log("Erro ao instalar:", err));
        });
      }
    </script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        GoogleAuthProvider,
        signInWithPopup,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyA7OU8xkjbPVgUs5z1XExqrKYAP_4TpO4g",
        authDomain: "gymdaily-app.firebaseapp.com",
        projectId: "gymdaily-app",
        storageBucket: "gymdaily-app.firebasestorage.app",
        messagingSenderId: "1072026357474",
        appId: "1:1072026357474:web:8e48b13d3b9ad58c5258bb",
      };

      const appFirebase = initializeApp(firebaseConfig);
      const auth = getAuth(appFirebase);
      const db = getFirestore(appFirebase);
      const provider = new GoogleAuthProvider();

      let currentUser = null;

      window.loginGoogle = async () => {
        try {
          console.log("Iniciando login...");
          const result = await signInWithPopup(auth, provider);
          alert(`Bem-vindo, ${result.user.displayName}!`);
        } catch (error) {
          console.error("Erro no login:", error);
          alert("Erro ao logar: " + error.message);
        }
      };

      window.logoutGoogle = async () => {
        try {
          await signOut(auth);
          state.gymData = {};
          state.routines = [];
          state.isLogged = false;
          app.render();
          alert("Desconectado.");
        } catch (error) {
          console.error(error);
        }
      };

      window.saveToCloud = async () => {
    if (!currentUser) {
        localStorage.setItem('gymTrackerData', JSON.stringify(state.gymData));
        localStorage.setItem('gymRoutines', JSON.stringify(state.routines));
        return;
    }
    try {
        const userRef = doc(db, "users", currentUser.uid);
        
        // --- A MUDANÇA ESTÁ AQUI ---
        // Removemos o { merge: true }. Agora ele sobrescreve o documento
        // garantindo que o que foi deletado no app suma do banco também.
        await setDoc(userRef, {
            gymData: state.gymData,
            routines: state.routines,
            lastUpdate: new Date().toISOString()
        });
        
        console.log("Dados sincronizados (Sobrescrita completa)!");
    } catch (e) {
        console.error("Erro ao salvar:", e);
    }
  };

      onAuthStateChanged(auth, async (user) => {
        console.log("Estado:", user ? "Logado" : "Deslogado");

        if (user) {
          currentUser = user;
          state.isLogged = true;

          const docRef = doc(db, "users", user.uid);
          const docSnap = await getDoc(docRef);

          state.userPhoto = user.photoURL; // Pega a foto do Google
          state.userName = user.displayName; // Pega o nome do Google

          if (docSnap.exists()) {
            const data = docSnap.data();
            state.gymData = data.gymData || {};
            state.routines = data.routines || {};
            app.render();
            console.log("Dados carregados.");
          } else {
            saveToCloud();
            app.render();
          }

        } else {
          currentUser = null;
          state.isLogged = false;
          app.render();
        }
      });
    </script>
  </body>
</html>